
<!-- One thing you must do: Get a free Google OAuth Client ID from console.cloud.google.com ‚Üí Create Project ‚Üí OAuth 2.0 Client ‚Üí Web Application ‚Üí add your file's path 
as authorized origin. 
Paste the Client ID into GDRIVE_CLIENT_ID. Without that, the Drive button will show an alert telling you exactly what's needed.
 Local file loading works with zero setup. -->


<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DataViz Studio</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<style>
:root {
  --cream:      #FAF8F4;
  --white:      #FFFFFF;
  --ink:        #1A1A18;
  --ink2:       #3D3D39;
  --muted:      #8A8A84;
  --faint:      #C8C8C0;
  --rule:       #E8E6E0;
  --forest:     #1B5E42;
  --forest-lt:  #EAF3EE;
  --forest-mid: #C5DECE;
  --amber:      #C45C00;
  --amber-lt:   #FDF0E6;
  --amber-mid:  #F2C89A;
  --sky:        #0055B3;
  --sky-lt:     #E8F0FA;
  --rose:       #B5293A;
  --shelf-bg:   #F5F3EF;
  --shadow-sm:  0 1px 3px rgba(26,26,24,.08), 0 1px 2px rgba(26,26,24,.04);
  --shadow-md:  0 4px 16px rgba(26,26,24,.10), 0 2px 6px rgba(26,26,24,.06);
  --shadow-lg:  0 16px 48px rgba(26,26,24,.16), 0 4px 14px rgba(26,26,24,.10);
  --r: 6px;
  --font:  'DM Sans', sans-serif;
  --serif: 'DM Serif Display', Georgia, serif;
  --mono:  'DM Mono', 'Consolas', monospace;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; font-family: var(--font); background: var(--cream); color: var(--ink); font-size: 13px; -webkit-font-smoothing: antialiased; }

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
#topbar {
  height: 52px; background: var(--white);
  border-bottom: 1.5px solid var(--rule);
  display: flex; align-items: center; gap: 10px; padding: 0 18px;
  position: relative; z-index: 100; box-shadow: var(--shadow-sm);
}
.logo { font-family: var(--serif); font-size: 18px; color: var(--ink); letter-spacing: -.2px; white-space: nowrap; line-height: 1; display: flex; align-items: baseline; gap: 3px; }
.logo em { color: var(--forest); font-style: italic; }
.logo-dot { width: 6px; height: 6px; background: var(--amber); border-radius: 50%; margin-bottom: 2px; flex-shrink: 0; }
.topbar-div { width: 1px; height: 24px; background: var(--rule); margin: 0 4px; }
.upload-btn { display: flex; align-items: center; gap: 7px; background: var(--forest); color: #fff; border: none; border-radius: var(--r); padding: 7px 16px; cursor: pointer; font-family: var(--font); font-size: 12px; font-weight: 600; letter-spacing: .3px; transition: all .18s; box-shadow: 0 2px 8px rgba(27,94,66,.25); }
.upload-btn:hover { background: #154d36; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(27,94,66,.3); }
.upload-btn svg { width: 13px; height: 13px; }
#file-input { display: none; }
#status-bar { flex: 1; font-size: 11.5px; color: var(--muted); padding: 0 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.stat-badge { background: var(--forest-lt); color: var(--forest); border-radius: 20px; padding: 3px 10px; font-size: 10.5px; font-weight: 600; font-family: var(--mono); white-space: nowrap; border: 1px solid var(--forest-mid); display: none; }
.seg-control { display: flex; background: var(--cream); border: 1.5px solid var(--rule); border-radius: var(--r); overflow: hidden; padding: 2px; gap: 1px; }
.seg-btn { background: transparent; border: none; color: var(--muted); border-radius: 4px; padding: 4px 11px; cursor: pointer; font-family: var(--font); font-size: 11px; font-weight: 500; transition: all .15s; white-space: nowrap; }
.seg-btn.active { background: var(--white); color: var(--ink); box-shadow: var(--shadow-sm); font-weight: 600; }
.seg-btn:not(.active):hover { color: var(--ink2); background: rgba(255,255,255,.6); }
.view-toggle { display: flex; gap: 2px; }
.vt-btn { background: transparent; border: 1.5px solid var(--rule); color: var(--muted); border-radius: var(--r); padding: 5px 12px; cursor: pointer; font-family: var(--font); font-size: 11px; font-weight: 500; transition: all .15s; }
.vt-btn.active { background: var(--sky-lt); color: var(--sky); border-color: #bfd4f0; font-weight: 600; }
.vt-btn:not(.active):hover { border-color: var(--faint); color: var(--ink2); }
.clear-btn { background: transparent; border: 1.5px solid var(--rule); color: var(--muted); border-radius: var(--r); padding: 5px 10px; cursor: pointer; font-size: 11px; font-family: var(--font); transition: all .15s; }

.clear-btn:hover { border-color: var(--rose); color: var(--rose); }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
#app { display: flex; height: calc(100vh - 52px); }

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sidebar { width: 230px; min-width: 180px; max-width: 340px; background: var(--white); border-right: 1.5px solid var(--rule); display: flex; flex-direction: column; overflow: hidden; }
.sb-head { padding: 14px 14px 0; font-size: 10px; font-weight: 600; letter-spacing: 1.2px; color: var(--muted); text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
.sb-head .badge { background: var(--cream); border: 1px solid var(--rule); color: var(--muted); border-radius: 20px; padding: 1px 7px; font-size: 9.5px; font-family: var(--mono); }
.sb-section { display: flex; flex-direction: column; overflow: hidden; }
.sb-divider { height: 1.5px; background: var(--rule); flex-shrink: 0; }
.sb-search { margin: 8px 10px 2px; background: var(--cream); border: 1.5px solid var(--rule); border-radius: 5px; padding: 5px 9px; font-family: var(--font); font-size: 11.5px; color: var(--ink); width: calc(100% - 20px); outline: none; transition: border .15s; }
.sb-search:focus { border-color: var(--forest-mid); }
.sb-search::placeholder { color: var(--faint); }
.sb-pills { overflow-y: auto; padding: 6px 10px 12px; }
.fp { display: flex; align-items: center; gap: 7px; padding: 6px 9px; border-radius: 5px; margin-bottom: 2px; cursor: grab; user-select: none; -webkit-user-select: none; touch-action: none; -webkit-user-drag: element; transition: all .13s; border: 1.5px solid transparent; font-size: 11.5px; }
.fp.dim { background: var(--forest-lt); color: var(--forest); border-color: var(--forest-mid); }
.fp.mea { background: var(--amber-lt); color: var(--amber); border-color: var(--amber-mid); }
.fp.disc { background: var(--sky-lt); color: var(--sky); border-color: #bfd4f0; }
.fp:hover { filter: brightness(.96); transform: translateX(2px); box-shadow: var(--shadow-sm); }
.fp:active { cursor: grabbing; opacity: .65; transform: scale(.97); }
.fp.dragging { opacity: .3; }
.fp .fp-icon { font-size: 10px; flex-shrink: 0; opacity: .7; }
.fp .fp-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
.fp .fp-tag { font-size: 9px; font-family: var(--mono); opacity: .65; background: rgba(0,0,0,.06); border-radius: 3px; padding: 1px 4px; }

/* ‚îÄ‚îÄ WORKSPACE ‚îÄ‚îÄ */
#workspace { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--cream); }

/* ‚îÄ‚îÄ SHELF AREA ‚îÄ‚îÄ */
#shelf-area { background: var(--shelf-bg); border-bottom: 1.5px solid var(--rule); padding: 8px 14px; display: flex; flex-direction: column; gap: 5px; }
.shelf-row { display: flex; align-items: center; gap: 10px; }
.shelf-lbl { font-size: 9.5px; font-weight: 700; letter-spacing: 1.1px; color: var(--muted); text-transform: uppercase; width: 58px; flex-shrink: 0; }
.shelf-drop { flex: 1; min-height: 34px; border: 1.5px dashed var(--faint); border-radius: 5px; padding: 3px 7px; display: flex; gap: 5px; flex-wrap: wrap; align-items: center; transition: all .15s; background: rgba(255,255,255,.5); }
.shelf-drop:hover { border-color: var(--forest-mid); }
.shelf-drop.over-cols { border-color: var(--forest); background: var(--forest-lt); border-style: solid; }
.shelf-drop.over-rows { border-color: var(--amber); background: var(--amber-lt); border-style: solid; }
.shelf-drop.over-filt { border-color: var(--sky); background: var(--sky-lt); border-style: solid; }
.shelf-ph { font-size: 11px; color: var(--faint); font-style: italic; pointer-events: none; }

/* ‚îÄ‚îÄ SHELF CHIPS (cols/rows) ‚îÄ‚îÄ */
.chip { display: inline-flex; align-items: center; gap: 5px; border-radius: 4px; padding: 4px 8px; font-size: 11px; font-weight: 500; border: 1.5px solid; transition: all .12s; animation: chipIn .15s ease; }
@keyframes chipIn { from { opacity:0; transform:scale(.88); } to { opacity:1; transform:scale(1); } }
.chip.dim { background: var(--forest-lt); border-color: var(--forest-mid); color: var(--forest); }
.chip.mea { background: var(--amber-lt); border-color: var(--amber-mid); color: var(--amber); }
.chip:hover { box-shadow: var(--shadow-sm); }
.chip-drag-over { outline: 2px solid var(--sky); outline-offset: 1px; }
.chip-drop-before { border-left: 3px solid var(--sky) !important; margin-left: 4px; }
.chip-drop-after  { border-right: 3px solid var(--sky) !important; margin-right: 4px; }
.shelf-drop.chip-over { border-color: var(--sky); background: var(--sky-lt); border-style: solid; }
.drop-ghost {
  display: inline-flex; align-items: center;
  padding: 4px 10px; border-radius: 4px;
  border: 2px dashed var(--sky); color: var(--sky);
  font-size: 11px; font-weight: 600; background: var(--sky-lt);
  animation: chipIn .12s ease; pointer-events: none;
  white-space: nowrap;
}
.chip .agg-sel { background: transparent; border: none; color: inherit; font-family: var(--mono); font-size: 10px; cursor: pointer; padding: 0 2px; font-weight: 600; }
.chip-badge { display:inline-flex; align-items:center; gap:2px; background:rgba(0,0,0,.07); border-radius:3px; padding:2px 6px; font-family:var(--mono); font-size:10px; font-weight:700; cursor:pointer; transition:background .12s; user-select:none; white-space:nowrap; }
.chip-badge:hover { background:rgba(0,0,0,.14); }
/* Measure config popup */
#mea-popup { position:fixed; z-index:4000; background:var(--white); border:1.5px solid var(--rule); border-radius:10px; box-shadow:var(--shadow-lg); width:260px; padding:12px 14px; display:none; animation:popIn .14s cubic-bezier(.34,1.56,.64,1); }
#mea-popup.show { display:block; }
.mp-section { font-size:9.5px; font-weight:700; letter-spacing:1px; color:var(--muted); text-transform:uppercase; margin:8px 0 5px; }
.mp-section:first-child { margin-top:0; }
.mp-opts { display:flex; flex-wrap:wrap; gap:4px; }
.mp-opt { background:var(--cream); border:1.5px solid var(--rule); border-radius:4px; padding:3px 9px; font-size:11px; font-family:var(--mono); cursor:pointer; transition:all .12s; color:var(--ink2); }
.mp-opt:hover { border-color:var(--sky); color:var(--sky); }
.mp-opt.active { background:var(--sky-lt); border-color:var(--sky); color:var(--sky); font-weight:600; }
.mp-ma-row { display:flex; align-items:center; gap:6px; margin-top:4px; }
.mp-preview { margin-top:10px; padding:7px 9px; background:var(--cream); border-radius:5px; font-size:11px; color:var(--muted); border:1px solid var(--rule); }
.mp-preview strong { color:var(--ink); }
.chip .rm { background: none; border: none; color: inherit; opacity: .45; cursor: pointer; font-size: 13px; line-height: 1; padding: 0; transition: opacity .1s; }
.chip .rm:hover { opacity: 1; }

/* ‚îÄ‚îÄ FILTER CHIPS (special) ‚îÄ‚îÄ */
.fchip {
  display: inline-flex; align-items: center; gap: 6px;
  border-radius: 4px; padding: 4px 9px; font-size: 11px; font-weight: 500;
  border: 1.5px solid #bfd4f0; background: var(--sky-lt); color: var(--sky);
  cursor: pointer; transition: all .12s; animation: chipIn .15s ease;
  position: relative; user-select: none; max-width: 220px;
}
.fchip:hover { box-shadow: var(--shadow-sm); border-color: var(--sky); }
.fchip.active-filter { border-color: var(--sky); background: #dce9f8; }
.fchip .fchip-dot {
  width: 6px; height: 6px; border-radius: 50%; background: var(--sky);
  flex-shrink: 0; display: none;
}
.fchip.active-filter .fchip-dot { display: block; }
.fchip .fchip-field { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }
.fchip .fchip-summary { color: #4a7cc7; font-size: 10.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90px; }
.fchip .fchip-caret { font-size: 9px; opacity: .6; flex-shrink: 0; transition: transform .15s; }
.fchip.open .fchip-caret { transform: rotate(180deg); }
.fchip .fchip-rm { background: none; border: none; color: inherit; opacity: .4; cursor: pointer; font-size: 13px; line-height: 1; padding: 0 0 0 2px; transition: opacity .1s; flex-shrink: 0; }
.fchip .fchip-rm:hover { opacity: 1; color: var(--rose); }

/* ‚îÄ‚îÄ FILTER POPOVER ‚îÄ‚îÄ */
#filter-popover {
  display: none; position: fixed; z-index: 9000;
  background: var(--white); border: 1.5px solid var(--rule);
  border-radius: 10px; box-shadow: var(--shadow-lg);
  width: 280px; overflow: hidden;
  animation: popIn .15s cubic-bezier(.34,1.56,.64,1);
}
@keyframes popIn { from { opacity:0; transform:scale(.94) translateY(-6px); } to { opacity:1; transform:scale(1) translateY(0); } }
#filter-popover.show { display: block; }

.fp-header {
  padding: 12px 14px 10px; border-bottom: 1px solid var(--rule);
  display: flex; align-items: center; gap: 8px;
}
.fp-field-name { font-weight: 600; font-size: 12.5px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.fp-type-pill { font-size: 9px; font-family: var(--mono); border-radius: 3px; padding: 2px 6px; font-weight: 600; }
.fp-type-pill.dim { background: var(--forest-lt); color: var(--forest); border: 1px solid var(--forest-mid); }
.fp-type-pill.mea { background: var(--amber-lt); color: var(--amber); border: 1px solid var(--amber-mid); }

/* Dimension filter body */
.fp-search-wrap { padding: 10px 12px 8px; border-bottom: 1px solid var(--rule); }
.fp-val-search {
  width: 100%; background: var(--cream); border: 1.5px solid var(--rule);
  border-radius: 5px; padding: 6px 10px 6px 30px;
  font-family: var(--font); font-size: 12px; color: var(--ink);
  outline: none; transition: border .15s;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%238A8A84' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: 9px center; background-size: 13px;
}
.fp-val-search:focus { border-color: var(--sky); }
.fp-val-search::placeholder { color: var(--faint); }

.fp-actions-top { padding: 6px 12px; display: flex; gap: 6px; border-bottom: 1px solid var(--rule); }
.fp-act-btn { background: none; border: none; font-family: var(--font); font-size: 11px; color: var(--muted); cursor: pointer; padding: 2px 0; transition: color .12s; }
.fp-act-btn:hover { color: var(--sky); }
.fp-act-sep { color: var(--faint); font-size: 11px; }

.fp-val-list { max-height: 200px; overflow-y: auto; padding: 4px 0; }
.fp-val-item {
  display: flex; align-items: center; gap: 9px;
  padding: 6px 14px; cursor: pointer; transition: background .1s;
}
.fp-val-item:hover { background: var(--cream); }
.fp-val-item input[type=checkbox] { width: 14px; height: 14px; accent-color: var(--sky); cursor: pointer; flex-shrink: 0; }
.fp-val-label { flex: 1; font-size: 12px; color: var(--ink2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.fp-val-count { font-size: 10px; font-family: var(--mono); color: var(--faint); flex-shrink: 0; }
.fp-no-results { padding: 16px 14px; font-size: 12px; color: var(--muted); text-align: center; font-style: italic; }

/* Measure filter body */
.fp-range-body { padding: 14px; }
.fp-range-info { display: flex; justify-content: space-between; margin-bottom: 14px; }
.fp-range-bound { text-align: center; }
.fp-range-label { font-size: 9.5px; color: var(--muted); text-transform: uppercase; letter-spacing: .8px; margin-bottom: 3px; }
.fp-range-val { font-family: var(--mono); font-size: 13px; font-weight: 600; color: var(--ink); }
.fp-range-arrow { color: var(--faint); align-self: center; font-size: 14px; }
.fp-inputs { display: flex; gap: 8px; align-items: center; }
.fp-range-input {
  flex: 1; background: var(--cream); border: 1.5px solid var(--rule);
  border-radius: 5px; padding: 7px 9px; font-family: var(--mono);
  font-size: 12px; color: var(--ink); outline: none; transition: border .15s;
  text-align: right;
}
.fp-range-input:focus { border-color: var(--sky); }
.fp-range-input::placeholder { color: var(--faint); font-family: var(--font); font-size: 11px; }
.fp-input-sep { color: var(--faint); font-size: 16px; flex-shrink: 0; }
.fp-quick-presets { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
.fp-preset { background: var(--cream); border: 1px solid var(--rule); border-radius: 4px; padding: 3px 9px; font-size: 10.5px; color: var(--muted); cursor: pointer; transition: all .12s; font-family: var(--font); }
.fp-preset:hover { border-color: var(--sky); color: var(--sky); background: var(--sky-lt); }

/* Popover footer */
.fp-footer {
  padding: 10px 14px; border-top: 1px solid var(--rule);
  display: flex; align-items: center; justify-content: space-between;
  background: #FDFCFA;
}
.fp-footer-info { font-size: 11px; color: var(--muted); }
.fp-footer-info strong { color: var(--sky); font-family: var(--mono); }
.fp-apply { background: var(--sky); color: white; border: none; border-radius: 4px; padding: 5px 14px; font-family: var(--font); font-size: 11.5px; font-weight: 600; cursor: pointer; transition: all .15s; }
.fp-apply:hover { background: #0046a0; }
.fp-clear-filter { background: none; border: none; font-family: var(--font); font-size: 11px; color: var(--muted); cursor: pointer; transition: color .12s; }
.fp-clear-filter:hover { color: var(--rose); }

/* ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ */
#canvas { flex: 1; position: relative; overflow: hidden; background: var(--cream); }
#chart-container { width: 100%; height: 100%; }
#table-container { width: 100%; height: 100%; overflow: auto; display: none; }
#table-container table { width: auto; min-width: 60%; max-width: 100%; margin: 0 auto; border-collapse: collapse; font-size: 12px; table-layout: auto; }
#table-container th, #table-container td { width: auto; white-space: nowrap; }
#table-container td.num, #table-container th.num-h { width: 1%; white-space: nowrap; text-align: right; }
#table-container th:first-child, #table-container td:first-child { width: 1%; }
#table-container thead { position: sticky; top: 0; z-index: 10; }
#table-container th { background: var(--white); color: var(--muted); padding: 10px 14px; text-align: left; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; border-bottom: 2px solid var(--rule); white-space: nowrap; }
#table-container td { padding: 8px 14px; border-bottom: 1px solid var(--rule); color: var(--ink); background: var(--white); }
#table-container tr:nth-child(even) td { background: #FAFAF8; }
#table-container tr:hover td { background: var(--forest-lt); }
.num { text-align: right; font-family: var(--mono); font-size: 11.5px; color: var(--forest); }

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
#empty-state { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 14px; pointer-events: none; }
.es-icon { width: 72px; height: 72px; border-radius: 18px; background: var(--white); border: 2px solid var(--rule); display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: var(--shadow-md); }
#empty-state h2 { font-family: var(--serif); font-size: 20px; color: var(--ink2); font-weight: 400; }
#empty-state p { font-size: 12px; color: var(--muted); text-align: center; max-width: 300px; line-height: 1.6; }
.es-steps { display: flex; gap: 8px; margin-top: 4px; }
.es-step { background: var(--white); border: 1.5px solid var(--rule); border-radius: var(--r); padding: 8px 14px; font-size: 11px; color: var(--muted); display: flex; align-items: center; gap: 6px; box-shadow: var(--shadow-sm); }
.es-step .nb { width: 18px; height: 18px; border-radius: 50%; background: var(--forest); color: white; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
#progress-overlay { display: none; position: fixed; inset: 0; background: rgba(250,248,244,.88); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; gap: 18px; backdrop-filter: blur(8px); }
#progress-overlay.show { display: flex; }
.prog-card { background: var(--white); border: 1.5px solid var(--rule); border-radius: 12px; padding: 32px 40px; box-shadow: var(--shadow-lg); text-align: center; min-width: 380px; }
.prog-icon { font-size: 36px; margin-bottom: 14px; }
#progress-title { font-family: var(--serif); font-size: 18px; color: var(--ink); margin-bottom: 6px; }
#progress-sub { font-size: 11.5px; color: var(--muted); margin-bottom: 18px; font-family: var(--mono); }
.prog-bar-wrap { width: 100%; height: 5px; background: var(--rule); border-radius: 3px; overflow: hidden; }
.prog-bar-fill { height: 100%; width: 0; background: linear-gradient(90deg, var(--forest), #2e9e6b); border-radius: 3px; transition: width .35s cubic-bezier(.4,0,.2,1); }
.prog-pct { font-family: var(--mono); font-size: 24px; font-weight: 500; color: var(--forest); margin-top: 10px; }

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
#lod-modal.show { display:flex !important; }
#sidebar-resize { width: 4px; cursor: col-resize; background: transparent; flex-shrink: 0; transition: background .15s; }
#sidebar-resize:hover { background: var(--forest-mid); }
#drag-ghost { position: fixed; pointer-events: none; z-index: 9999; background: var(--forest); color: white; border-radius: 4px; padding: 5px 11px; font-size: 11.5px; font-weight: 600; display: none; white-space: nowrap; box-shadow: 0 4px 14px rgba(27,94,66,.35); font-family: var(--font); }
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--faint); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--muted); }
@keyframes fadeSlideUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
#topbar, #sidebar, #shelf-area { animation: fadeSlideUp .3s ease both; }
#canvas { animation: fadeSlideUp .3s .08s ease both; }

/* ‚îÄ‚îÄ PREVIEW MODAL ‚îÄ‚îÄ */
#prev-modal{display:none;position:fixed;inset:0;background:rgba(26,26,24,.55);z-index:9500;align-items:center;justify-content:center;}
#prev-modal-inner{background:#fff;border-radius:14px;box-shadow:var(--shadow-lg);width:92vw;max-width:1300px;height:84vh;display:flex;flex-direction:column;overflow:hidden;animation:popIn .18s cubic-bezier(.34,1.56,.64,1);}
.prev-hd{padding:14px 20px;border-bottom:1.5px solid var(--rule);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;gap:12px;}
.prev-hd-left{display:flex;flex-direction:column;gap:3px;}
.prev-hd-title{font-family:var(--serif);font-size:16px;color:var(--ink);}
#prev-info{font-size:11px;color:var(--muted);font-family:var(--mono);}
#prev-wrap{flex:1;overflow:auto;}
.prev-tbl{border-collapse:collapse;width:100%;font-size:12px;}
.prev-tbl th{position:sticky;top:0;background:var(--shelf-bg);color:var(--muted);font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;padding:9px 14px;text-align:left;border-bottom:2px solid var(--rule);white-space:nowrap;}
.prev-tbl td{padding:7px 14px;border-bottom:1px solid var(--rule);white-space:nowrap;color:var(--ink2);font-family:var(--mono);font-size:11.5px;max-width:260px;overflow:hidden;text-overflow:ellipsis;}
.prev-tbl tr:nth-child(even) td{background:#faf9f7;}
.prev-tbl tr:hover td{background:var(--forest-lt);}

/* ‚îÄ‚îÄ SHOW ME PANEL ‚îÄ‚îÄ */
#show-me-panel{display:none;position:fixed;right:0;top:52px;width:210px;height:calc(100vh - 52px);background:var(--white);border-left:1.5px solid var(--rule);box-shadow:var(--shadow-lg);z-index:4000;display:flex;flex-direction:column;overflow:hidden;transform:translateX(100%);transition:transform .2s cubic-bezier(.4,0,.2,1);}
#show-me-panel.open{transform:translateX(0);}
.sm-head{padding:12px 14px 8px;border-bottom:1.5px solid var(--rule);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.sm-head-title{font-family:var(--serif);font-size:14px;color:var(--ink);}
.sm-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;line-height:1;padding:0;}
.sm-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;padding:10px 10px 6px;flex-shrink:0;}
.sm-tile{display:flex;flex-direction:column;align-items:center;gap:4px;padding:7px 4px 5px;border-radius:8px;border:1.5px solid var(--rule);cursor:pointer;transition:all .13s;background:var(--cream);color:var(--muted);}
.sm-tile:hover{border-color:var(--forest-mid);color:var(--forest);background:var(--forest-lt);}
.sm-tile.active{border-color:var(--forest);background:var(--forest-lt);color:var(--forest);box-shadow:0 0 0 2px var(--forest-mid);}
.sm-tile svg{width:36px;height:26px;}
.sm-tile-lbl{font-size:9px;font-weight:600;letter-spacing:.4px;text-transform:uppercase;white-space:nowrap;}
.sm-sep{height:1px;background:var(--rule);margin:0 10px;flex-shrink:0;}
.sm-section{padding:8px 12px 6px;flex-shrink:0;}
.sm-section-title{font-size:9.5px;font-weight:700;letter-spacing:1px;color:var(--muted);text-transform:uppercase;margin-bottom:6px;}
.sm-row{display:flex;align-items:center;justify-content:space-between;padding:5px 0;}
.sm-row-lbl{font-size:11.5px;color:var(--ink2);}
.sm-toggle{position:relative;width:34px;height:18px;flex-shrink:0;}
.sm-toggle input{opacity:0;width:0;height:0;}
.sm-toggle-track{position:absolute;inset:0;background:var(--faint);border-radius:9px;cursor:pointer;transition:background .2s;}
.sm-toggle input:checked+.sm-toggle-track{background:var(--forest);}
.sm-toggle-track::after{content:'';position:absolute;left:2px;top:2px;width:14px;height:14px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);}
.sm-toggle input:checked+.sm-toggle-track::after{transform:translateX(16px);}
.sm-choose-btn{margin:6px 10px 10px;background:var(--forest);color:#fff;border:none;border-radius:6px;padding:8px;font-size:11.5px;font-weight:600;font-family:var(--font);cursor:pointer;transition:all .15s;width:calc(100% - 20px);}
.sm-choose-btn:hover{background:#154d36;}
.sm-rl-btn{display:flex;align-items:center;gap:7px;padding:6px 8px;border-radius:6px;border:1.5px solid var(--rule);background:var(--cream);color:var(--muted);font-size:11px;font-family:var(--font);cursor:pointer;transition:all .13s;width:100%;}
.sm-rl-btn:hover{border-color:var(--sky);color:var(--sky);}
.sm-rl-btn.has-lines{border-color:var(--sky);color:var(--sky);background:var(--sky-lt);}
#show-me-btn.active{background:var(--forest-lt);color:var(--forest);border-color:var(--forest-mid);}

/* ‚îÄ‚îÄ RESTORE BANNER ‚îÄ‚îÄ */
#restore-banner {
  display: none;
  background: var(--amber-lt);
  border-bottom: 1.5px solid var(--amber-mid);
  padding: 8px 18px;
  font-size: 12px;
  color: var(--amber);
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
  z-index: 50;
}
#restore-banner.show { display: flex; }
#restore-banner strong { font-weight: 600; }
#restore-banner .rb-btn {
  background: var(--amber); color: #fff; border: none;
  border-radius: 4px; padding: 4px 12px; font-size: 11.5px;
  font-weight: 600; cursor: pointer; font-family: var(--font);
  white-space: nowrap; flex-shrink: 0;
}
#restore-banner .rb-btn:hover { background: #a34e00; }
#restore-banner .rb-dismiss {
  background: none; border: none; color: var(--amber);
  cursor: pointer; font-size: 13px; margin-left: auto;
  opacity: .6; padding: 0;
}
#restore-banner .rb-dismiss:hover { opacity: 1; }
</style>

</style>
</head>

<body>

<div id="topbar">
  <div class="logo">DataViz<em>Studio</em><span class="logo-dot"></span></div>
  <div class="topbar-div"></div>
  <div style="position:relative;display:flex;align-items:center;" id="load-btn-wrap">
    <button class="upload-btn" onclick="toggleLoadMenu(event)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Load Data
      <svg id="load-caret" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width:11px;height:11px;transition:transform .2s;"><polyline points="6 9 12 15 18 9"/></svg>
    </button>
    <div id="load-menu" style="display:none;position:absolute;top:calc(100% + 6px);left:0;min-width:220px;background:#fff;border:1.5px solid var(--rule);border-radius:10px;box-shadow:var(--shadow-lg);padding:4px;z-index:9999;animation:popIn .15s cubic-bezier(.34,1.56,.64,1);">
      <div class="load-menu-item" onclick="document.getElementById('file-input').click();closeLoadMenu()">
        <div class="lmi-icon" style="background:var(--forest-lt);color:var(--forest);">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
        </div>
        <div>
          <div class="lmi-title">Local File</div>
          <div class="lmi-sub">CSV, Excel up to 600 MB</div>
        </div>
      </div>
      <div class="load-menu-item" onclick="openDriveModal();closeLoadMenu()">
        <div class="lmi-icon" style="background:#e8f0fe;color:#1a73e8;">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"><path d="M12 2L2 19.5h20L12 2z" fill="#1a73e8" opacity=".15"/><path d="M8.5 19.5L3 10l5.5-8h7L21 10l-5.5 9.5H8.5z" stroke="#1a73e8" stroke-width="1.5" fill="none"/><path d="M3 10h18M8.5 2L3 10l5.5 9.5M15.5 2L21 10l-5.5 9.5" stroke="#1a73e8" stroke-width="1.5"/></svg>
        </div>
        <div>
          <div class="lmi-title">Google Drive</div>
          <div class="lmi-sub">Browse & import from Drive</div>
        </div>
      </div>
      <div class="load-menu-item" onclick="openOnedriveModal();closeLoadMenu()">
        <div class="lmi-icon" style="background:#e3f2fd;color:#0078d4;">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"><path d="M4.5 15.5a4 4 0 0 1 0-8 4.5 4.5 0 0 1 8.46-2A4 4 0 1 1 18 15.5H4.5z" stroke="#0078d4" stroke-width="1.5" fill="#e3f2fd"/></svg>
        </div>
        <div>
          <div class="lmi-title">OneDrive</div>
          <div class="lmi-sub">Browse & import from OneDrive</div>
        </div>
      </div>
    </div>
  </div>
  <input type="file" id="file-input" accept=".csv,.xlsx,.xls">



  <div id="status-bar">No data loaded ‚Äî upload a CSV or Excel file to begin</div>
  <span id="row-badge" class="stat-badge"></span>
  <span id="skip-badge" style="display:none;background:#FDF0E6;color:#C45C00;border:1px solid #F2C89A;border-radius:20px;padding:3px 10px;font-size:10.5px;font-weight:600;font-family:var(--mono);white-space:nowrap;cursor:pointer;"></span>
  
  <div class="topbar-div"></div>
  <button class="clear-btn" id="show-me-btn" onclick="toggleShowMe()">‚¨õ Show Me ‚ñæ</button>
  <div class="topbar-div"></div>
  
  <button class="clear-btn" id="preview-btn" onclick="showPreview()" style="display:none">‚äû Preview</button>
  <button class="clear-btn" id="export-btn" onclick="exportCSV()" style="display:none">‚Üì Export</button>
  <div style="position:relative;display:inline-block;" id="analysis-wrap">
    <button class="clear-btn" id="analysis-btn" onclick="toggleAnalysisMenu()" style="display:none;">‚ö° Analysis ‚ñæ</button>
    <div id="analysis-menu">
      <div class="anl-item" onclick="openLodModal();closeAnalysisMenu()">
        <div class="anl-item-left"><span class="anl-icon">‚àë</span> LOD Expression</div>
      </div>
      <div class="anl-sep"></div>
      <div class="anl-item anl-has-sub">
        <div class="anl-item-left"><span class="anl-icon">‚äû</span> Totals</div>
        <span class="anl-arrow">‚ñ∂</span>
        <div class="anl-sub">
          <div class="anl-item" onclick="toggleTotal('grandRow')"><div class="anl-item-left"><span id="tot-chk-grandRow" class="tot-chk">‚òê</span> Grand Total Row</div></div>
          <div class="anl-item" onclick="toggleTotal('grandCol')"><div class="anl-item-left"><span id="tot-chk-grandCol" class="tot-chk">‚òê</span> Grand Total Column</div></div>
          <div class="anl-item" onclick="toggleTotal('subtotals')"><div class="anl-item-left"><span id="tot-chk-subtotals" class="tot-chk">‚òê</span> Subtotals</div></div>
        </div>
      </div>
      <div class="anl-sep"></div>
      <div class="anl-item" id="anl-tc-row">
        <div class="anl-item-left"><span class="anl-icon">∆í</span> Table Calcs</div>
        <span id="anl-tc-badge" style="display:none;" class="anl-badge amber"></span>
      </div>
      <div class="anl-sep"></div>
      <div class="anl-item" onclick="showStatSummary();closeAnalysisMenu()">
        <div class="anl-item-left"><span class="anl-icon">‚óà</span> Statistical Summary</div>
      </div>
      <div class="anl-item" onclick="showCorrMatrix();closeAnalysisMenu()">
        <div class="anl-item-left"><span class="anl-icon">‚ßâ</span> Correlation Matrix</div>
      </div>
    </div>
  </div>
  <button class="clear-btn" onclick="clearAll()" title="Clear shelves (Esc)">‚úï Clear</button>
</div>

<div id="restore-banner">
  <span>‚èé</span>
  <span>Last session: <strong id="rb-filename"></strong> ‚Äî re-upload it to restore your view</span>
  <button class="rb-btn" onclick="document.getElementById('file-input').click()">‚Üë Upload Again</button>
  <button class="rb-btn" onclick="localStorage.removeItem('dvs_state');sessionStorage.removeItem('dvs_banner_dismissed');dismissRestoreBanner();document.getElementById('file-input').click()" style="background:var(--forest);">‚Üë Upload New File</button>
  <button class="rb-dismiss" onclick="dismissRestoreBanner()" title="Dismiss">‚úï</button>
</div>
<div id="app">
  <div id="sidebar">
    <div class="sb-section" style="overflow:hidden;display:flex;flex-direction:column;flex:0 0 auto;max-height:50%;">
      <div class="sb-head">Dimensions <span class="badge" id="dim-count">0</span></div>
      <input class="sb-search" placeholder="Search dimensions‚Ä¶" oninput="filterPills('dim',this.value)">
      <div id="dim-list" class="sb-pills" style="overflow-y:auto;flex:1;min-height:60px;"
        ondragover="event.preventDefault()" ondrop="crossDrop(event,'dimension')"></div>
    </div>
    <div class="sb-divider"></div>
    <div class="sb-section" style="overflow:hidden;display:flex;flex-direction:column;flex:1;">
      <div class="sb-head" style="padding-top:12px;">Measures <span class="badge" id="mea-count">0</span></div>
      <input class="sb-search" placeholder="Search measures‚Ä¶" oninput="filterPills('mea',this.value)">
      <div id="mea-list" class="sb-pills" style="overflow-y:auto;flex:1;"
        ondragover="event.preventDefault()" ondrop="crossDrop(event,'measure')"></div>
    </div>
  <div id="param-section">
      <div class="param-head" onclick="toggleParamPanel()">
        Parameters <span id="param-count" style="font-family:var(--mono);font-size:9.5px;"></span>
        <button class="param-add-btn" onclick="event.stopPropagation();openParamModal()" title="New parameter">+</button>
      </div>
      <div id="param-list" style="display:none;"></div>
    </div>
  </div>
  <div id="sidebar-resize"></div>

<!-- PARAMETER MODAL -->
<div id="param-modal">
  <div class="param-card">
    <div class="param-card-head">
      New Parameter
      <button onclick="closeParamModal()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;">‚úï</button>
    </div>
    <div class="param-card-body">
      <div class="param-field-row">
        <label class="param-field-label">Name</label>
        <input class="param-field-inp" id="pm-name" placeholder="e.g. Top N Customers">
      </div>
      <div class="param-field-row">
        <label class="param-field-label">Type</label>
        <select class="param-field-inp" id="pm-type" onchange="onParamTypeChange()">
          <option value="integer">Integer (slider)</option>
          <option value="float">Float (slider)</option>
          <option value="list">List (dropdown)</option>
        </select>
      </div>
      <div id="pm-range-fields">
        <div class="param-field-row" style="margin-bottom:8px;">
          <label class="param-field-label">Current Value</label>
          <input class="param-field-inp" id="pm-val" type="number" placeholder="10">
        </div>
        <div style="display:flex;gap:10px;">
          <div class="param-field-row" style="flex:1;">
            <label class="param-field-label">Min</label>
            <input class="param-field-inp" id="pm-min" type="number" placeholder="1">
          </div>
          <div class="param-field-row" style="flex:1;">
            <label class="param-field-label">Max</label>
            <input class="param-field-inp" id="pm-max" type="number" placeholder="100">
          </div>
          <div class="param-field-row" style="flex:1;">
            <label class="param-field-label">Step</label>
            <input class="param-field-inp" id="pm-step" type="number" placeholder="1">
          </div>
        </div>
      </div>
      <div id="pm-list-fields" style="display:none;">
        <div class="param-field-row">
          <label class="param-field-label">Values (comma-separated)</label>
          <input class="param-field-inp" id="pm-list-vals" placeholder="Small, Medium, Large">
        </div>
        <div class="param-field-row">
          <label class="param-field-label">Current Value</label>
          <input class="param-field-inp" id="pm-list-cur" placeholder="Small">
        </div>
      </div>
    </div>
    <div class="param-card-foot">
      <button class="param-cancel" onclick="closeParamModal()">Cancel</button>
      <button class="param-save" onclick="saveParam()">Create Parameter</button>
    </div>
  </div>
</div>

  <div id="workspace">
    <div id="shelf-area">
      <div class="shelf-row">
        <div class="shelf-lbl">Columns</div>
        <div class="shelf-drop" id="shelf-columns"
          ondragover="onShelfDragOver(event,'cols','columns')" ondragleave="onDragLeave(event)" ondrop="onDrop(event,'columns')">
          <span class="shelf-ph">Drop dimensions here</span>
        </div>
      </div>
      <div class="shelf-row">
        <div class="shelf-lbl">Rows</div>
        <div class="shelf-drop" id="shelf-rows"
          ondragover="onShelfDragOver(event,'rows','rows')" ondragleave="onDragLeave(event)" ondrop="onDrop(event,'rows')">
          <span class="shelf-ph">Drop dimensions or measures here</span>
        </div>
      </div>
      <div class="shelf-row">
        <div class="shelf-lbl">Filters</div>
        <div class="shelf-drop" id="shelf-filters"
          ondragover="onShelfDragOver(event,'filt','filters')" ondragleave="onDragLeave(event)" ondrop="onDrop(event,'filters')">
          <span class="shelf-ph">Drop any field to filter ‚Äî click chip to configure</span>
        </div>
      </div>
    </div>

    <div id="drill-bar">
      <div class="drill-bc" id="drill-bc"></div>
      <button class="drill-up" onclick="drillUp(1)" title="Up one level">‚Üë Up</button>
      <button class="drill-back" onclick="drillReset()">‚úï Reset Drill</button>
    </div>
    <div id="canvas">
      <div id="empty-state">
        <div class="es-icon">üìä</div>
        <h2>Start by loading your data</h2>
        <p>Supports CSV up to 600 MB and Excel files. Then drag fields onto the shelves.</p>
        <div class="es-steps">
          <div class="es-step"><span class="nb">1</span>Load CSV or Excel</div>
          <div class="es-step"><span class="nb">2</span>Drag to shelves</div>
          <div class="es-step"><span class="nb">3</span>Click filters to configure</div>
        </div>
      </div>
      <div id="chart-container"></div>
      <div id="table-container"></div>
      <button id="refline-btn" onclick="toggleRefLinePanel()">Ôºã Reference Line</button>
      <div id="refline-panel">
        <div class="rl-header">
          <span class="rl-title">Reference Lines</span>
          <button class="rl-close" onclick="toggleRefLinePanel()">‚úï</button>
        </div>
        <div class="rl-body">
          <div class="rl-form">
            <div class="rl-row">
              <select class="rl-sel" id="rl-type">
                <option value="average">Average</option>
                <option value="median">Median</option>
                <option value="max">Max</option>
                <option value="min">Min</option>
                <option value="constant">Constant</option>
              </select>
              <select class="rl-sel" id="rl-measure"></select>
            </div>
            <div class="rl-row">
              <input class="rl-inp" id="rl-const" type="number" placeholder="Value" style="display:none">
              <input class="rl-inp" id="rl-label" placeholder="Label (optional)" style="flex:1">
              <input class="rl-inp" id="rl-color" type="color" value="#0055B3" style="width:32px;padding:2px;cursor:pointer;border-radius:4px;">
              <button class="rl-add" onclick="addRefLine()">Add</button>
            </div>
          </div>
          <div class="rl-list" id="rl-list"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FILTER POPOVER -->
<div id="filter-popover">
  <!-- injected dynamically -->
</div>

<div id="progress-overlay">
  <div class="prog-card">
    <div class="prog-icon">‚öôÔ∏è</div>
    <div id="progress-title">Parsing file‚Ä¶</div>
    <div id="progress-sub">Starting‚Ä¶</div>
    <div class="prog-bar-wrap"><div class="prog-bar-fill" id="prog-fill"></div></div>
    <div class="prog-pct" id="prog-pct">0%</div>
  </div>
</div>

<div id="drag-ghost"></div>
<div id="mea-popup"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WEB WORKER (embedded blob)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function _workerFn() {
  let cols = {}, schema = [], rowCount = 0;

  self.onmessage = ({ data: { type, payload } }) => {
    if      (type === 'PARSE_CSV')   parseCSV(payload);
    else if (type === 'LOAD_COLS')   loadCols(payload);
    else if (type === 'GET_VALUES')  getValues(payload);
    else if (type === 'QUERY')       query(payload);
    else if (type === 'RENAME_COL')  { const v=cols[payload.from]; if(v){cols[payload.to]=v; delete cols[payload.from];} }
    else if (type === 'DATE_PART')   { createDatePart(payload); }
    else if (type === 'CREATE_BIN')  { createBin(payload); self.postMessage({type:'BIN_DONE', payload:{name:payload.newName}}); }
    else if (type === 'GET_ROWS')    { getRows(payload); }
  };

  function loadCols({ columns, sch, count }) {
    cols = {}; schema = sch; rowCount = count;
    sch.forEach(s => {
      cols[s.name] = s.type === 'measure'
        ? new Float64Array(columns[s.name]) : columns[s.name];
    });
    self.postMessage({ type:'DONE', payload:{ schema, rowCount } });
  }

  function parseCSV(text) {
    try {
    const lines = text.split(/\r?\n/);
    if (lines.length < 2) { self.postMessage({ type:'ERR', payload:'Empty file' }); return; }
    const firstLine = lines[0].replace(/^\uFEFF/, '');
    const delim = [',',';','\t','|'].map(d=>({d, n:firstLine.split(d).length-1})).sort((a,b)=>b.n-a.n)[0].d;
    const headers = splitLine(firstLine, delim);
    const tmp = {}; headers.forEach(h => tmp[h] = []);
    const total = lines.length - 1, TICK = 50000;
    for (let i = 1; i <= total; i++) {
      const line = lines[i]; if (!line || !line.trim()) continue;
      const v = splitLine(line, delim);
      headers.forEach((h, j) => tmp[h].push(v[j] !== undefined ? v[j] : ''));
      if (i % TICK === 0) self.postMessage({ type:'PROG', payload:{ rows:i, total } });
    }
    cols = {}; schema = [];
    headers.forEach(h => {
      const arr = tmp[h];
      const samp = arr.slice(0, Math.min(600, arr.length));
      const nc = samp.filter(v => {
        if (v === '' || v === null || v === undefined) return false;
        const cleaned = String(v).replace(/[,\s$\u20AC\u00A3\u20B9%]/g, '');
        return !isNaN(parseFloat(cleaned)) && isFinite(+cleaned);
      }).length;
      if (nc > samp.length * 0.78) {
        const fa = new Float64Array(arr.length);
        for (let j = 0; j < arr.length; j++) {
          fa[j] = parseFloat(String(arr[j]).replace(/[,\s$\u20AC\u00A3\u20B9%]/g,'')) || 0;
        }
        const hn = h.toUpperCase();
        const defAgg =
          /AVG|AVERAGE|MEAN|RATE|RATIO|PCT|PERCENT|PER|PRICE|CLOSE|OPEN|HIGH|LOW|LAST|PREV/.test(hn) ? 'AVG' :
          /COUNT|CNT|NUM_OF|NO_OF|NUMBER/.test(hn) ? 'COUNT' :
          'SUM';
        cols[h] = fa; schema.push({ name:h, type:'measure', discrete: false, defaultAgg: defAgg });
      } else {
        // Date detection ‚Äî sample up to 20 values
        
        const dateSamp = arr.slice(0,20).filter(v=>v&&v!=='');
        const dateHits = dateSamp.filter(v=>{
          const s = String(v).trim();
          if (s.length < 6 || /^\d{1,4}$/.test(s)) return false;
          const strict = /^(\\d{4}-\\d{2}-\\d{2}(T\\d{2}:\\d{2}(:\\d{2})?)?|(\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4})|(\\d{4}[\\/\\-]\\d{2}[\\/\\-]\\d{2})|(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\\s+\\d{1,2},?\\s+\\d{4}|\\d{1,2}\\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\\s+\\d{4})$/i;
          if (!strict.test(s)) return false;
          const d = new Date(s);
          return !isNaN(d.getTime());
        }).length;

        if (dateHits > dateSamp.length * 0.7) {
        
          cols[h] = arr; schema.push({ name:h, type:'dimension', dataType:'date', discrete: true });
          
        } else {
          cols[h] = arr; schema.push({ name:h, type:'dimension', discrete: true });
        }
      }
    });
    rowCount = tmp[headers[0]].length;
    self.postMessage({ type:'DONE', payload:{ schema, rowCount } });
    } catch(err) {
      self.postMessage({ type:'ERR', payload: 'Parse error: ' + err.message });
    }
  }

  function splitLine(line, delim=',') {
    const res = []; let cur = '', inQ = false;
    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (c === '"') { inQ = !inQ; continue; }
      if (c === delim && !inQ) { res.push(cur.trim()); cur = ''; continue; }
      cur += c;
    }
    res.push(cur.trim()); return res;
  }

  function createDatePart({field, part, newName}) {
    const src = cols[field]; if (!src) return;
    const out = new Array(rowCount);
    for (let i=0;i<rowCount;i++) {
      const d = new Date(src[i]);
      if (isNaN(d.getTime())) { out[i]=''; continue; }
      switch(part) {
        case 'year':    out[i] = String(d.getFullYear()); break;
        case 'quarter': out[i] = 'Q'+(Math.floor(d.getMonth()/3)+1)+' '+d.getFullYear(); break;
        case 'month':   out[i] = d.toLocaleString('default',{month:'short'})+' '+d.getFullYear(); break;
        case 'week': {
          const jan1 = new Date(d.getFullYear(),0,1);
          const wk = Math.ceil(((d-jan1)/86400000+jan1.getDay()+1)/7);
          out[i] = 'W'+String(wk).padStart(2,'0')+' '+d.getFullYear(); break;
        }
        case 'day':     out[i] = d.toISOString().slice(0,10); break;
        default:        out[i] = String(src[i]);
      }
    }
    cols[newName] = out;
    schema.push({name:newName, type:'dimension', dataType:'datepart'});
  }

  function createBin({field, binSize, newName}) {
    const src = cols[field]; if (!src) return;
    const out = new Array(rowCount);
    for (let i = 0; i < rowCount; i++) {
      const v = +src[i];
      if (isNaN(v)) { out[i] = ''; continue; }
      const lo = Math.floor(v / binSize) * binSize;
      const hi = lo + binSize;
      out[i] = lo + ' \u2013 ' + hi;
    }
    cols[newName] = out;
    schema.push({name:newName, type:'dimension', dataType:'bin', _sourceField:field, _binSize:binSize});
  }
  
  function getValues({ field, type, reqId }) {
    const col = cols[field];
    if (!col) { self.postMessage({ type:'VALUES', payload:{ reqId, values:[], stats:null } }); return; }
    if (type === 'dimension') {
      const countMap = new Map();
      for (let i = 0; i < rowCount; i++) {
        const v = String(col[i] || '');
        countMap.set(v, (countMap.get(v)||0) + 1);
      }
      const values = [...countMap.entries()]
        .sort((a,b) => b[1]-a[1])
        .slice(0, 500)
        .map(([v, c]) => ({ v, c }));
      self.postMessage({ type:'VALUES', payload:{ reqId, values, stats:null } });
    } else {
      let mn = Infinity, mx = -Infinity, sum = 0, cnt = 0;
      for (let i = 0; i < rowCount; i++) {
        const v = col[i];
        if (!isNaN(v)) { mn=Math.min(mn,v); mx=Math.max(mx,v); sum+=v; cnt++; }
      }
      self.postMessage({ type:'VALUES', payload:{ reqId, values:[], stats:{ min:mn, max:mx, mean: cnt?sum/cnt:0 } } });
    }
  }

  function getRows({ limit, fields }) {
    const lim = Math.min(limit || 100, rowCount);
    const useFields = (fields && fields.length) ? fields : schema.map(s => s.name);
    const rows = [];
    for (let i = 0; i < lim; i++) {
      const row = {};
      useFields.forEach(f => {
        row[f] = cols[f] ? (cols[f][i] !== undefined ? cols[f][i] : '') : '';
      });
      rows.push(row);
    }
    self.postMessage({ type: 'RAW_ROWS', payload: { headers: useFields, rows, total: rowCount } });
  }

  function query(payload) {
  const { dims, meas, filters, limit, lodFields } = payload;
    if (!dims.length && !meas.length) {
      self.postMessage({ type:'RESULT', payload:{ headers:[], rows:[], total:0 } }); return;
    }

    // ‚îÄ‚îÄ FIXED LOD pre-computation ‚îÄ‚îÄ
    // For each LOD field, compute agg at fixedDims grain ‚Üí lookup map
    const lodMaps = {}; // lodName ‚Üí Map(joinKey ‚Üí value)
    (lodFields||[]).forEach(lod => {
      const fDims = lod.fixedDims; // array of field names
      const mCol  = cols[lod.measField];
      if (!mCol && lod.measField !== 'Record Count') return;
      const gmap2 = new Map();
      for (let i = 0; i < rowCount; i++) {
        let key2 = '';
        for (let d = 0; d < fDims.length; d++) {
          key2 += (cols[fDims[d]] ? String(cols[fDims[d]][i]) : '') + '\x00';
        }
        const v = lod.measField === 'Record Count' ? 1 : (parseFloat(mCol[i]) || 0);
        if (!gmap2.has(key2)) {
          gmap2.set(key2, { _a: v, _c: 1 });
        } else {
          const e2 = gmap2.get(key2);
          if      (lod.agg === 'SUM' || lod.agg === 'AVG') { e2._a += v; e2._c++; }
          else if (lod.agg === 'MAX') { e2._a = Math.max(e2._a, v); }
          else if (lod.agg === 'MIN') { e2._a = Math.min(e2._a, v); }
          else if (lod.agg === 'COUNT') { e2._a++; }
        }
      }
      // Resolve AVG
      const resolvedMap = new Map();
      gmap2.forEach((e2, k) => {
        resolvedMap.set(k, lod.agg === 'AVG' ? e2._a / e2._c : e2._a);
      });
      lodMaps[lod.name] = { map: resolvedMap, fixedDims: fDims };
    });

    // Build filter functions
    const fns = (filters||[]).map(f => {
      const col = cols[f.field];
      if (!col) return () => true;
      if (f.type === 'dimension') {
        if (!f.selectedValues || !f.selectedValues.length) return () => true;
        const set = new Set(f.selectedValues);
        return i => set.has(String(col[i] || ''));
      } else {
        const hasMin = f.minVal !== null && f.minVal !== '' && !isNaN(+f.minVal);
        const hasMax = f.maxVal !== null && f.maxVal !== '' && !isNaN(+f.maxVal);
        if (!hasMin && !hasMax) return () => true;
        return i => {
          const v = +col[i];
          if (hasMin && v < +f.minVal) return false;
          if (hasMax && v > +f.maxVal) return false;
          return true;
        };
      }
    });

    const gmap = new Map();
    const cdSets = new Map(); // for COUNTD: groupKey ‚Üí [Set|null, ...]
    const dLen = dims.length, mLen = meas.length;
    const hasCd = meas.some(m => m.agg === 'COUNTD');

    const skipped = [];
    for (let i = 0; i < rowCount; i++) {
      let pass = true;
      for (let fi = 0; fi < fns.length; fi++) if (!fns[fi](i)) { pass=false; break; }
      if (!pass) continue;

      // Skip rows where any dimension is blank
      let hasBlank = false;
      for (let d = 0; d < dLen; d++) {
        const v = cols[dims[d].field] ? cols[dims[d].field][i] : '';
        if (v === '' || v === null || v === undefined) { hasBlank = true; break; }
      }
      if (hasBlank) {
        const rowData = {};
        schema.forEach(s => { rowData[s.name] = cols[s.name] ? cols[s.name][i] : ''; });
        skipped.push({ row: i+1, reason: 'Blank dimension value', data: rowData });
        continue;
      }

      // Build group key
      let key = '';
      for (let d = 0; d < dLen; d++) key += (cols[dims[d].field] ? String(cols[dims[d].field][i]) : '') + '\\x00';

      if (!gmap.has(key)) {
        const e = { _d: new Array(dLen), _a: new Float64Array(mLen), _c: new Int32Array(mLen).fill(1) };
        for (let d = 0; d < dLen; d++) e._d[d] = cols[dims[d].field] ? cols[dims[d].field][i] : '';
        for (let m = 0; m < mLen; m++) {
          const ag = meas[m].agg;
          const c = cols[meas[m].field];
          const v = (meas[m].field==='Record Count') ? 1 : (c ? (parseFloat(c[i])||0) : 0);
          e._a[m] = (ag==='COUNT'||ag==='COUNTD') ? 1 : (ag==='LAST'||ag==='FIRST') ? (c ? c[i] : 0) : v;
        }
        gmap.set(key, e);
        // Init COUNTD sets for this new group
        if (hasCd) {
          const sets = meas.map(m => {
            if (m.agg !== 'COUNTD') return null;
            const s = new Set();
            const c = cols[m.field];
            s.add(c ? c[i] : null);
            return s;
          });
          cdSets.set(key, sets);
        }
      } else {
        const e = gmap.get(key);
        const sets = hasCd ? cdSets.get(key) : null;
        for (let m = 0; m < mLen; m++) {
          const ag = meas[m].agg, c = cols[meas[m].field];
          const v = (meas[m].field==='Record Count') ? 1 : (c ? (parseFloat(c[i])||0) : 0);
          if      (ag === 'SUM' || ag === 'AVG') { e._a[m] += v; e._c[m]++; }
          else if (ag === 'COUNT')  { e._a[m]++; }
          else if (ag === 'COUNTD') { sets[m].add(c ? c[i] : null); e._a[m] = sets[m].size; }
          else if (ag === 'MAX')    { e._a[m] = Math.max(e._a[m], v); }
          else if (ag === 'MIN')    { e._a[m] = Math.min(e._a[m], v); }
          else if (ag === 'LAST')   { e._a[m] = v; }
          else if (ag === 'FIRST')  { /* keep first value, already set on group init */ }
        }
      }
    }
    const rows = [];
    gmap.forEach(e => {
      const row = {};
      for (let d=0;d<dLen;d++) row[dims[d].field]=e._d[d];
      for (let m=0;m<mLen;m++) {
        const k=meas[m].agg+'('+meas[m].field+')';
        row[k]=meas[m].agg==='AVG' ? e._a[m]/e._c[m] : e._a[m];
      }
      // ‚îÄ‚îÄ Stamp LOD values onto each row ‚îÄ‚îÄ
      Object.keys(lodMaps).forEach(lodName => {
        const { map, fixedDims } = lodMaps[lodName];
        let joinKey = '';
        for (let d = 0; d < fixedDims.length; d++) {
          joinKey += String(row[fixedDims[d]] || '') + '\x00';
        }
        row[lodName] = map.get(joinKey) ?? null;
      });
      rows.push(row);
    });
    if (dLen>0) rows.sort((a,b)=>String(a[dims[0].field]||'').localeCompare(String(b[dims[0].field]||'')));

    // Apply Top N filters ‚Äî compute all keep-sets from full rows first, then intersect
    const topNFilters = (filters||[]).filter(f => f.topN && f.topNBy);
    if (topNFilters.length) {
      // Step 1: build every keep-set independently from the unmodified rows
      const keepSets = topNFilters.map(f => {
        const measKey = Object.keys(rows[0]||{}).find(k=>k.includes('('+f.topNBy+')')) || f.topNBy;
        const sorted = [...rows].sort((a,b) => (b[measKey]||0) - (a[measKey]||0));
        return {
          field: f.field,
          keep: f.topNDir==='top'
            ? new Set(sorted.slice(0, f.topN).map(r=>String(r[f.field]||'')))
            : new Set(sorted.slice(-f.topN).map(r=>String(r[f.field]||'')))
        };
      });
      // Step 2: single pass ‚Äî row must pass ALL TopN filters to survive
      for (let i = rows.length-1; i >= 0; i--) {
        const r = rows[i];
        const remove = keepSets.some(({field, keep}) => !keep.has(String(r[field]||'')));
        if (remove) rows.splice(i, 1);
      }
      if (dLen>0) rows.sort((a,b)=>String(a[dims[0].field]||'').localeCompare(String(b[dims[0].field]||'')));
    }
    const limited = rows.slice(0, limit||50000);
    const lodHeaders = (lodFields||[]).map(l => l.name);
    const headers = [...dims.map(d=>d.field),...meas.map(m=>m.agg+'('+m.field+')'),...lodHeaders];
    self.postMessage({ type:'RESULT', payload:{ headers, rows:limited, total:rows.length, skipped, _shelf: payload._shelf, _qid: payload._qid } });
  }
}

// Extract function body ‚Äî safe from backtick/template-literal fragility
const _fnStr = _workerFn.toString();
const WW = _fnStr.slice(_fnStr.indexOf('{') + 1, _fnStr.lastIndexOf('}'));

function _createWorker() {
  const w = new Worker(URL.createObjectURL(new Blob([WW], {type:'application/javascript'})));
  w.onerror = function(e) { hideProgress(); setStatus('‚ö† Worker error: ' + e.message); };
  w.onmessageerror = function() { hideProgress(); setStatus('‚ö† Data engine error ‚Äî try reloading'); };
  w.onmessage = _onWorkerMessage;
  return w;
}
let worker = _createWorker();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const S = {
  schema: [], rowCount: 0, filename: '', skipped: [],
  shelf: { columns:[], rows:[], filters:[] },
  chartType: 'bar', view: 'table', result: null,
  hierarchies: {},
  drillStack: [],
  params: [],
  lodFields: [],
  refLines: [],
  trendLine: false,
  totals: { grandRow: false, grandCol: false, subtotals: false },
};

// Filter state per field: { field, type, selectedValues:[], minVal:'', maxVal:'', dataValues:[], stats:null }
const filterState = {}; // keyed by field name

// Stable chart click handler ‚Äî defined once, reads S.shelf live at call time
function _onChartClick(params) {
  if (params.componentType !== 'series') return;
  const allF = [...S.shelf.columns, ...S.shelf.rows];
  const dims = allF.filter(f => f.type === 'dimension');
  if (!dims.length) return;
  let chipShelf = 'columns', chipIndex = 0;
  const colDim = S.shelf.columns.findIndex(f => f.type === 'dimension');
  if (colDim !== -1) { chipShelf = 'columns'; chipIndex = colDim; }
  else {
    const rowDim = S.shelf.rows.findIndex(f => f.type === 'dimension');
    if (rowDim !== -1) { chipShelf = 'rows'; chipIndex = rowDim; }
  }
  const chip = S.shelf[chipShelf][chipIndex];
  if (!chip) return;
  const hier = getFieldHierarchy(chip.field);
  if (!hier) return;
  const clickedValue = params.name || params.value;
  drillDown(chip.field, clickedValue, chipShelf, chipIndex);
}

let valueCallbacks = {}; // reqId ‚Üí { cb, timer }
let reqCounter = 0;
const VALUE_CB_TIMEOUT_MS = 30000;

// XSS-safe registry: store dynamic data by int key, pass only key into onclick
const _reg = {};
let _regCounter = 0;
function _regSet(val) { const k = ++_regCounter; _reg[k] = val; return k; }
function _regGet(k)   { return _reg[k]; }
function _regDel(k)   { delete _reg[k]; }
let chart = null, dragF = null, chipDrag = null, _nativeDragFired = false;
let openPopoverField = null;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WORKER MESSAGES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function _onWorkerMessage({ data: { type, payload } }) {
  if (type === 'PROG') {
    const pct = payload.total ? Math.round((payload.rows/payload.total)*88)+5 : 50;
    setProgress(pct, `${fmtN(payload.rows)} of ${fmtN(payload.total)} rows`);
  } else if (type === 'DONE') {
    hideProgress();
    S.schema = payload.schema; S.rowCount = payload.rowCount;
    restoreState();
    if (!S.schema.find(s=>s.name==='Record Count')) {
      S.schema.push({ name:'Record Count', type:'measure', defaultAgg:'COUNT', _virtual:true });
    }
    buildSidebar();
    document.getElementById('restore-banner').classList.remove('show');
    setStatus(`${S.filename}  ¬∑  ${fmtN(payload.rowCount)} rows  ¬∑  ${payload.schema.length} columns`);
    const b = document.getElementById('row-badge');
    b.textContent = fmtN(payload.rowCount)+' rows'; b.style.display='';
    document.getElementById('preview-btn').style.display = '';
    document.getElementById('analysis-btn').style.display = '';
    
  } else if (type === 'ERR') {
    hideProgress(); setStatus('‚ö† '+payload);
  } else if (type === 'VALUES') {
    const entry = valueCallbacks[payload.reqId];
    if (entry) {
      clearTimeout(entry.timer);
      entry.cb(payload);
      delete valueCallbacks[payload.reqId];
    }
  } else if (type === 'BIN_DONE') {
    buildSidebar();
    setStatus(`Bin field "${payload.name}" created ‚Äî drag to shelf`);
  } else if (type === 'RAW_ROWS') {
    _renderPreviewModal(payload);
  } else if (type === 'RESULT') {
    if (payload._qid && payload._qid !== _queryId) return; // stale result
    _queryActive = false;
    clearTimeout(_queryTimer);
    document.getElementById('query-overlay').style.display='none';
    // Expand duplicate measure chips into uid-keyed columns
    const shelfMeas = [...S.shelf.columns, ...S.shelf.rows].filter(f => f.type==='measure' && f._uid);
    // Only expand uid columns when duplicates of same field+agg exist
    
    shelfMeas.forEach(chip => {
      const plainKey = `${chip.agg}(${chip.field})`;
      const uidKey = `${plainKey}__${chip._uid}`;
      if (payload.rows.length && plainKey in payload.rows[0] && !(uidKey in payload.rows[0])) {
        payload.rows.forEach(r => { r[uidKey] = r[plainKey]; });
        if (!payload.headers.includes(uidKey)) payload.headers.push(uidKey);
      }
    });
    S.result = payload;
    render();
  }
}
worker.onmessage = _onWorkerMessage;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FILE LOADING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

function paintAllShelves() {
  paintShelf('columns');
  paintShelf('rows');
  paintShelf('filters');
}


document.getElementById('file-input').addEventListener('change', function(e) {
  const f = e.target.files[0]; if (!f) return;
  if (f.size > 600 * 1024 * 1024) {
    setStatus('‚ö† File too large ‚Äî maximum 600 MB');
    e.target.value = '';
    return;
  }
  S.filename = f.name;
  // Reset all state for new file ‚Äî wipe filterState fully before schema changes
  S.shelf = { columns:[], rows:[], filters:[] };
  S.result = null;
  S.skipped = [];
  S.lodFields = [];
  S.drillStack = [];
  S.hierarchies = {};
  S.params = [];
  Object.keys(filterState).forEach(k => delete filterState[k]);
  Object.keys(colTransforms).forEach(k => delete colTransforms[k]);
  Object.keys(colMaWindow).forEach(k => delete colMaWindow[k]);
  dualAxisKeys.clear();
  paintAllShelves();
  closePopover();
  paintDrillBar();
  paintParams();
  document.getElementById('empty-state').style.display='flex';
  document.getElementById('chart-container').style.display='none';
  document.getElementById('table-container').style.display='none';
  if (chart) chart.clear();
  
  // document.getElementById('row-badge').style.display = 'none';
  document.getElementById('row-badge').style.display = 'none';
  document.getElementById('analysis-btn').style.display = 'none';
  sortState = { col: null, dir: 1 };

  const ext = f.name.split('.').pop().toLowerCase();
  if (ext==='csv') readCSV(f);
  else if (['xlsx','xls'].includes(ext)) readXLSX(f);
  else setStatus('‚ö† Unsupported format.');
  e.target.value='';
});

function readCSV(file) {
  showProgress('Reading CSV‚Ä¶', 5, 'Loading file into memory‚Ä¶');
  const rd = new FileReader();
  rd.onprogress = e => { if (e.lengthComputable) setProgress(Math.round((e.loaded/e.total)*12),'Reading‚Ä¶'); };
  rd.onload = e => { setProgress(15,'Parsing rows‚Ä¶'); worker.postMessage({type:'PARSE_CSV',payload:e.target.result}); };
  rd.readAsText(file);
}

function readXLSX(file) {
  showProgress('Reading Excel‚Ä¶', 5, 'Large files may take a moment‚Ä¶');
  const rd = new FileReader();
  rd.onload = e => {
    setProgress(30,'Converting‚Ä¶');
    try {
      let wb;
      try {
        wb = XLSX.read(e.target.result, {type:'array', dense:true});
      } catch(xlsxErr) {
        hideProgress();
        setStatus('‚ö† Could not read Excel file: ' + xlsxErr.message);
        return;
      }

      let sheetIdx = 0;
      if (wb.SheetNames.length > 1) {
        const choice = window.prompt(
          `This file has ${wb.SheetNames.length} sheets:\n${wb.SheetNames.map((n,i)=>`${i+1}. ${n}`).join('\n')}\n\nEnter sheet number:`, '1'
        );
        // User cancelled prompt ‚Äî abort cleanly
        if (choice === null) { hideProgress(); return; }
        sheetIdx = Math.max(0, Math.min(wb.SheetNames.length-1, (parseInt(choice)||1)-1));
      }
      const ws = wb.Sheets[wb.SheetNames[sheetIdx]];
      if (!ws) { hideProgress(); setStatus('‚ö† Could not read sheet'); return; }

      const data = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      if (data.length < 2) { hideProgress(); setStatus('‚ö† Empty sheet ‚Äî no data rows found'); return; }
      const headers = data[0].map(h=>String(h).trim());
      const tmp={}; headers.forEach(h=>tmp[h]=[]);
      for (let r=1;r<data.length;r++) headers.forEach((h,i)=>tmp[h].push(data[r][i]??''));
      setProgress(72,'Inferring schema‚Ä¶');
      const sch=[], colsOut={};
      headers.forEach(h=>{
        const arr=tmp[h], samp=arr.slice(0,600);
        const nc=samp.filter(v=>v!==''&&!isNaN(parseFloat(v))).length;
        if (nc>samp.length*0.75) {
          colsOut[h] = new Float64Array(arr.map(v=>parseFloat(v)||0));
          sch.push({name:h,type:'measure'});
        } else {
          const dateSamp = arr.slice(0,20).filter(v=>v&&v!=='');
          const dateHits = dateSamp.filter(v=>{ const s=String(v).trim(); if(s.length<6||/^\d{1,4}$/.test(s))return false; const strict=/^(\d{4}-\d{2}-\d{2}(T\d{2}:\d{2}(:\d{2})?)?|(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4})|(\d{4}[\/\-]\d{2}[\/\-]\d{2})|(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2},?\s+\d{4}|\d{1,2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4})$/i; if(!strict.test(s))return false; const d=new Date(s); return !isNaN(d.getTime()); }).length;
          const isDate = dateHits > dateSamp.length * 0.7;
          colsOut[h]=arr.map(v=>String(v));
          sch.push({name:h, type:'dimension', dataType: isDate?'date':'string'});
        }
      });
      setProgress(88,'Loading engine‚Ä¶');
      // Collect transferable Float64Arrays for zero-copy transfer
      const _transfers = Object.values(colsOut).filter(v => v instanceof Float64Array).map(v => v.buffer);
      worker.postMessage({type:'LOAD_COLS',payload:{columns:colsOut,sch,count:data.length-1}}, _transfers);
    } catch(err) { hideProgress(); setStatus('‚ö† Excel error: '+err.message); }
  };
  rd.readAsArrayBuffer(file);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SIDEBAR
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildSidebar() {
  const dims=S.schema.filter(s=>s.type==='dimension' && !s.hidden);
  const meas=S.schema.filter(s=>s.type==='measure' && !s.hidden);

  document.getElementById('dim-count').textContent=dims.length;
  document.getElementById('mea-count').textContent=meas.length;
  paintPills('dim-list',dims);
  paintPills('mea-list',meas);
}

function convertField(field, toType) {
  // Update schema
  const s = S.schema.find(x=>x.name===field);
  if (!s || s.type===toType) return;
  s.type = toType;

  // Update any shelf chips that use this field
  ['columns','rows','filters'].forEach(sh => {
    S.shelf[sh].forEach(f => {
      if (f.field===field) {
        f.type = toType;
        f.agg = toType==='measure' ? 'SUM' : null;
      }
    });
  });

  // Update filterState if exists
  if (filterState[field]) filterState[field].type = toType;

  buildSidebar();
  paintAllShelves();
  runQuery();
}

function setDiscrete(field, isDiscrete) {
  const s = S.schema.find(x => x.name === field);
  if (!s) return;
  s.discrete = isDiscrete;

  // Update shelf chips that use this field
  ['columns', 'rows', 'filters'].forEach(sh => {
    S.shelf[sh].forEach(f => {
      if (f.field === field) f.discrete = isDiscrete;
    });
  });

  buildSidebar();
  paintAllShelves();
  runQuery();
}
function setChipDiscrete(shelf, index, isDiscrete) {
  const f = S.shelf[shelf][index];
  if (!f) return;
  f.discrete = isDiscrete;       // mutates only this chip instance
  paintShelf(shelf);
  if (S.result) render();        // re-render with new axis behavior
}


let ctxField = null;

function openCtxMenu(e, field, currentType) {
  e.preventDefault(); e.stopPropagation();
  ctxField = field;
  const s = S.schema.find(x=>x.name===field) || {};
  const isDim = currentType === 'dimension';
  const menu = document.getElementById('ctx-menu');

  let html = '';

  // ‚îÄ‚îÄ Field name header ‚îÄ‚îÄ
  html += `<div class="ctx-label">${esc(field.length>22?field.slice(0,22)+'‚Ä¶':field)}</div>`;
  html += `<div class="ctx-sep"></div>`;

  // ‚îÄ‚îÄ Add to shelf ‚îÄ‚îÄ
  html += `<div class="ctx-item" onclick="addToShelf('${esc(field)}','${currentType}','columns');closeCtxMenu()">
    <span>Add to Columns</span>
  </div>`;
  html += `<div class="ctx-item" onclick="addToShelf('${esc(field)}','${currentType}','rows');closeCtxMenu()">
    <span>Add to Rows</span>
  </div>`;
  html += `<div class="ctx-item" onclick="addToShelf('${esc(field)}','${currentType}','filters');closeCtxMenu()">
    <span>Add to Filters</span>
  </div>`;

  html += `<div class="ctx-sep"></div>`;

  // ‚îÄ‚îÄ Convert type ‚îÄ‚îÄ
  const toType = isDim ? 'measure' : 'dimension';
  const toIcon = isDim ? '#' : '‚Ö¢';
  html += `<div class="ctx-item" onclick="convertField('${esc(field)}','${toType}');closeCtxMenu()">
    <span><span style="color:${isDim?'var(--amber)':'var(--forest)'};font-weight:700;margin-right:5px;">${toIcon}</span>Convert to ${toType}</span>
  </div>`;

  // ‚îÄ‚îÄ Discrete / Continuous toggle (only for non-string fields) ‚îÄ‚îÄ
  const curDiscrete = s.discrete !== false ? true : false; // default: dim=discrete, mea=continuous
  const isNonString = s.dataType !== 'string' && s.dataType !== undefined || s.type === 'measure';
  if (isNonString) {
    const toggleDiscrete = !curDiscrete;
    const dcLabel = toggleDiscrete ? 'Convert to Discrete' : 'Convert to Continuous';
    const dcIcon = toggleDiscrete ? '‚¨õ' : '‚ñ¨';
    const dcColor = toggleDiscrete ? 'var(--sky)' : 'var(--forest)';
    html += `<div class="ctx-item" onclick="setDiscrete('${esc(field)}',${toggleDiscrete});closeCtxMenu()">
      <span><span style="color:${dcColor};font-weight:700;margin-right:5px;">${dcIcon}</span>${dcLabel}</span>
    </div>`;
  }

  // ‚îÄ‚îÄ Change Data Type (submenu) ‚îÄ‚îÄ
  const curDt = s.dataType || (isDim?'string':'decimal');
  const dtOptions = isDim
    ? [['string','String (Abc)'],['decimal','Number (decimal)'],['whole','Number (whole)']]
    : [['decimal','Number (decimal)'],['whole','Number (whole)'],['string','String']];
  html += `<div class="ctx-item">
    <span>Change Data Type</span><span class="ctx-arrow">‚ñ∂</span>
    <div class="ctx-sub">
      ${dtOptions.map(([v,l])=>`<div class="ctx-item" onclick="changeDataType('${esc(field)}','${v}');closeCtxMenu()">
        <span>${l}</span>${curDt===v?'<span class="ctx-check">‚úì</span>':''}
      </div>`).join('')}
    </div>
  </div>`;

  // ‚îÄ‚îÄ Measure-only options ‚îÄ‚îÄ
  if (!isDim) {
    const curAgg = s.defaultAgg || 'SUM';
    html += `<div class="ctx-item">
      <span>Default Aggregation</span><span class="ctx-arrow">‚ñ∂</span>
      <div class="ctx-sub">
        ${['SUM','AVG','COUNT','COUNTD','MAX','MIN'].map(a=>`<div class="ctx-item" onclick="setDefaultAgg('${esc(field)}','${a}');closeCtxMenu()">
          <span>${a}</span>${curAgg===a?'<span class="ctx-check">‚úì</span>':''}
        </div>`).join('')}
      </div>
    </div>`;

    const curFmt = s.numFormat || 'default';
    html += `<div class="ctx-item">
      <span>Number Format</span><span class="ctx-arrow">‚ñ∂</span>
      <div class="ctx-sub">
        ${[['default','Default'],['integer','Integer (1,234)'],['decimal2','Decimal (1,234.56)'],['pct','Percentage (12.3%)'],['currency','Currency ($1,234)']].map(([v,l])=>`<div class="ctx-item" onclick="setNumFormat('${esc(field)}','${v}');closeCtxMenu()">
          <span>${l}</span>${curFmt===v?'<span class="ctx-check">‚úì</span>':''}
        </div>`).join('')}
      </div>
    </div>`;

    // ‚îÄ‚îÄ Create Bin (measures only) ‚îÄ‚îÄ
    html += `<div class="ctx-item" onclick="addBin('${esc(field)}');closeCtxMenu()">
      <span>‚äü Create Bin‚Ä¶</span>
    </div>`;
  }


  // ‚îÄ‚îÄ User-defined hierarchy (dimensions only) ‚îÄ‚îÄ
  if (isDim) {
    const existingHiers = Object.keys(S.hierarchies);
    const fieldHier = existingHiers.find(h => S.hierarchies[h].includes(field));
    html += `<div class="ctx-item">
      <span>‚äï Hierarchy</span><span class="ctx-arrow">‚ñ∂</span>
      <div class="ctx-sub">
        ${existingHiers.map(h => {
          const inThis = S.hierarchies[h].includes(field);
          return `<div class="ctx-item" onclick="addFieldToHierarchy('${esc(field)}','${esc(h)}');closeCtxMenu()">
            <span>${inThis?'‚úì ':''} ${esc(h)} (${S.hierarchies[h].length} levels)</span>
          </div>`;
        }).join('')}
        <div class="ctx-item" onclick="createHierarchy('${esc(field)}');closeCtxMenu()">
          <span style="color:var(--forest);font-weight:600;">+ New hierarchy‚Ä¶</span>
        </div>
        ${fieldHier ? `<div class="ctx-item" onclick="removeFromHierarchy('${esc(field)}','${esc(fieldHier)}');closeCtxMenu()">
          <span style="color:var(--rose);">Remove from "${esc(fieldHier)}"</span>
        </div>` : ''}
      </div>
    </div>`;
  }

  // ‚îÄ‚îÄ Date hierarchy (only for date fields) ‚îÄ‚îÄ
  if (s.dataType === 'date') {
    html += `<div class="ctx-item">
      <span>üìÖ Add Date Part</span><span class="ctx-arrow">‚ñ∂</span>
      <div class="ctx-sub">
        ${[['year','Year'],['quarter','Quarter'],['month','Month'],['week','Week'],['day','Day']].map(([p,l])=>`
          <div class="ctx-item" onclick="addDatePart('${esc(field)}','${p}');closeCtxMenu()">
            <span>${l}</span>
          </div>`).join('')}
      </div>
    </div>`;
  }
  html += `<div class="ctx-sep"></div>`;

  // ‚îÄ‚îÄ Rename ‚îÄ‚îÄ 
  html += `<div class="ctx-item" onclick="renameField('${esc(field)}');closeCtxMenu()">
    <span>Rename‚Ä¶</span>
  </div>`;

  // ‚îÄ‚îÄ Hide ‚îÄ‚îÄ
  const isHidden = s.hidden || false;
  html += `<div class="ctx-item" onclick="toggleHideField('${esc(field)}');closeCtxMenu()">
    <span style="color:${isHidden?'var(--forest)':'var(--muted)'}">${isHidden?'‚úì Show field':'Hide field'}</span>
  </div>`;

  document.getElementById('ctx-menu-inner').innerHTML = html;
  menu.style.display = 'block';
  const x = Math.min(e.clientX, window.innerWidth-220);
  const y = Math.min(e.clientY, window.innerHeight-320);
  menu.style.left = x+'px'; menu.style.top = y+'px';
}

function openChipCtxMenu(e, shelf, index) {
  e.preventDefault(); e.stopPropagation();
  const f = S.shelf[shelf][index];
  if (!f) return;

  const s = S.schema.find(x => x.name === f.field) || {};
  const isNonString = s.dataType !== 'string' && s.type !== 'dimension' 
                      || s.type === 'measure';
  const menu = document.getElementById('ctx-menu');
  let html = '';

  html += `<div class="ctx-label">${esc(f.field)}</div>`;
  html += `<div class="ctx-sep"></div>`;

  // Discrete/Continuous toggle ‚Äî only for non-string fields
  if (isNonString) {
    const curDiscrete = f.discrete ?? (f.type === 'dimension' ? true : false);
    const goDiscrete = !curDiscrete;
    const label = goDiscrete ? 'Convert to Discrete' : 'Convert to Continuous';
    const icon  = goDiscrete ? '‚¨õ' : '‚ñ¨';
    const color = goDiscrete ? 'var(--sky)' : 'var(--forest)';
    html += `<div class="ctx-item" onclick="setChipDiscrete('${shelf}',${index},${goDiscrete});closeCtxMenu()">
      <span><span style="color:${color};font-weight:700;margin-right:5px;">${icon}</span>${label} <span style="font-size:9.5px;color:var(--muted);">(this shelf only)</span></span>
    </div>`;

    // Also offer to apply to all uses of this field
    html += `<div class="ctx-item" onclick="setDiscrete('${esc(f.field)}',${goDiscrete});closeCtxMenu()">
      <span><span style="font-weight:700;margin-right:5px;color:var(--muted);">‚äõ</span>${label} <span style="font-size:9.5px;color:var(--muted);">(all uses)</span></span>
    </div>`;
  }

  html += `<div class="ctx-sep"></div>`;
  html += `<div class="ctx-item" onclick="removeChip('${shelf}',${index});closeCtxMenu()">
    <span style="color:var(--rose);">Remove from shelf</span>
  </div>`;

  document.getElementById('ctx-menu-inner').innerHTML = html;
  menu.style.display = 'block';
  const x = Math.min(e.clientX, window.innerWidth - 220);
  const y = Math.min(e.clientY, window.innerHeight - 200);
  menu.style.left = x + 'px';
  menu.style.top  = y + 'px';
}

function closeCtxMenu() { document.getElementById('ctx-menu').style.display='none'; ctxField=null; }

function addToShelf(field, type, shelf) {
  if (!shelf) shelf = type==='dimension' ? 'columns' : 'rows';
  if (type === 'dimension' && [...S.shelf.columns,...S.shelf.rows,...S.shelf.filters].find(f=>f.field===field)) return;
  // Run cardinality check same as onDrop
  if (shelf !== 'filters' && type === 'dimension') {
    const fs = filterState[field];
    const WARN_THRESHOLD = 80;
    if (fs && fs.dataValues.length >= WARN_THRESHOLD) {
      _pendingDrop = {field, type, shelf};
      showCardinalityWarning(field, type, shelf, fs.dataValues.length);
      return;
    } else if (!fs || !fs.dataValues.length) {
      _pendingDrop = {field, type, shelf};
      const reqId = ++reqCounter;
      
      valueCallbacks[reqId] = {
        cb: (payload) => {
          if (!filterState[field]) filterState[field]={field,type,selectedValues:[],dataValues:[],stats:null,minVal:'',maxVal:''};
          filterState[field].dataValues = payload.values;
          if (payload.values.length >= WARN_THRESHOLD) {
            showCardinalityWarning(field, type, shelf, payload.values.length);
          } else {
            _pendingDrop = null;
            proceedDrop(field, type, shelf);
          }
        },
        timer: setTimeout(() => { delete valueCallbacks[reqId]; }, VALUE_CB_TIMEOUT_MS)
      };

      worker.postMessage({type:'GET_VALUES', payload:{field, type, reqId}});
      return;
    }
  }
  proceedDrop(field, type, shelf);
}

function renameField(field) {
  const newName = window.prompt('Rename field:', field);
  if (!newName || newName.trim()==='' || newName===field) return;
  const n = newName.trim();
  // Update schema
  const s = S.schema.find(x=>x.name===field);
  if (!s) return;
  s.name = n;
  // Update cols in worker ‚Äî send rename message
  worker.postMessage({type:'RENAME_COL', payload:{from:field, to:n}});
  // Update shelves
  ['columns','rows','filters'].forEach(sh=>{
    S.shelf[sh].forEach(f=>{ if(f.field===field) f.field=n; });
  });
  // Update filterState
  if (filterState[field]) { filterState[n]=filterState[field]; filterState[n].field=n; delete filterState[field]; }
  buildSidebar(); paintAllShelves(); runQuery();
}

function toggleHideField(field) {
  const s = S.schema.find(x=>x.name===field); if (!s) return;
  s.hidden = !s.hidden;
  // Remove from shelves if hiding
  if (s.hidden) {
    ['columns','rows','filters'].forEach(sh=>{
      S.shelf[sh] = S.shelf[sh].filter(f=>f.field!==field);
    });
    paintAllShelves();
  }
  buildSidebar(); runQuery();
}

function changeDataType(field, dtype) {
  const s = S.schema.find(x=>x.name===field); if (!s) return;
  s.dataType = dtype;
  // If switching dimension to number type ‚Üí convert to measure
  if (s.type==='dimension' && (dtype==='decimal'||dtype==='whole')) {
    convertField(field, 'measure');
  } else if (s.type==='measure' && dtype==='string') {
    convertField(field, 'dimension');
  } else {
    buildSidebar();
  }
}

function setDefaultAgg(field, agg) {
  const s = S.schema.find(x=>x.name===field); if (!s) return;
  s.defaultAgg = agg;
  // Update any existing shelf chips using this field
  ['columns','rows'].forEach(sh=>{
    S.shelf[sh].forEach(f=>{ if(f.field===field && f.type==='measure') f.agg=agg; });
  });
  paintAllShelves(); runQuery();
}

function setNumFormat(field, fmt) {
  const s = S.schema.find(x=>x.name===field); if (!s) return;
  s.numFormat = fmt;
  if (S.result) render();
}

function addBin(field) {
  const s = S.schema.find(x => x.name === field);
  if (!s || s.type !== 'measure') return;

  // Suggest a sensible default bin size from the field's stats
  const fs = filterState[field];
  const range = fs?.stats ? fs.stats.max - fs.stats.min : null;
  const suggested = range ? +((range / 10).toPrecision(1)) || 1 : 1;

  const input = window.prompt(`Bin size for "${field}":`, suggested);
  if (input === null) return;
  const binSize = parseFloat(input);
  if (isNaN(binSize) || binSize <= 0) { setStatus('‚ö† Invalid bin size'); return; }

  const newName = `${field} (bin ${binSize})`;
  if (S.schema.find(s => s.name === newName)) {
    setStatus(`"${newName}" already exists`); return;
  }

  worker.postMessage({type:'CREATE_BIN', payload:{field, binSize, newName}});
  // Optimistically add to schema so sidebar updates immediately
  S.schema.push({name:newName, type:'dimension', dataType:'bin', _derived:true,
                 _sourceField:field, _binSize:binSize});
  buildSidebar();
  setStatus(`Creating bin field: ${newName}‚Ä¶`);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HIERARCHY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function createHierarchy(field) {
  const name = window.prompt('Hierarchy name:', field + ' Hierarchy');
  if (!name || !name.trim()) return;
  const n = name.trim();
  if (S.hierarchies[n]) { setStatus('Hierarchy "' + n + '" already exists'); return; }
  S.hierarchies[n] = [field];
  setStatus('Hierarchy "' + n + '" created. Right-click more dimensions to add levels.');
}

function addFieldToHierarchy(field, hierName) {
  const h = S.hierarchies[hierName]; if (!h) return;
  if (h.includes(field)) { setStatus('"' + field + '" already in hierarchy'); return; }
  h.push(field);
  setStatus('"' + field + '" added to "' + hierName + '" (level ' + h.length + ')');
}

function removeFromHierarchy(field, hierName) {
  const h = S.hierarchies[hierName]; if (!h) return;
  S.hierarchies[hierName] = h.filter(f => f !== field);
  if (!S.hierarchies[hierName].length) delete S.hierarchies[hierName];
}

function getFieldHierarchy(field) {
  // Returns {hierName, level, fields} if field belongs to a hierarchy
  for (const [name, fields] of Object.entries(S.hierarchies)) {
    const level = fields.indexOf(field);
    if (level !== -1) return { hierName:name, level, fields };
  }
  return null;
}

function drillDown(field, value, chipShelf, chipIndex) {
  const hier = getFieldHierarchy(field);
  if (!hier) return; // no hierarchy ‚Äî no drill
  const nextLevel = hier.level + 1;
  if (nextLevel >= hier.fields.length) return; // already at deepest level
  const nextField = hier.fields[nextLevel];

  // Push current state to stack
  S.drillStack.push({ hierName:hier.hierName, field, value, chipShelf, chipIndex });

  // Swap the column chip to next-level field
  const chip = S.shelf[chipShelf][chipIndex];
  if (chip) { chip.field = nextField; chip.type = 'dimension'; chip.agg = null; }

  // Add a filter for the clicked value
  if (!filterState[field]) {
    filterState[field] = { field, type:'dimension', selectedValues:[], dataValues:[], stats:null, minVal:'', maxVal:'' };
  }
  filterState[field].selectedValues = [String(value)];
  // Push as filter chip if not already there
  if (!S.shelf.filters.find(f => f.field === field)) {
    S.shelf.filters.push({ field, type:'dimension', agg:null, _drillFilter:true });
  }

  paintAllShelves();
  paintDrillBar();
  runQuery();
}

function drillUp(levels) {
  if (!S.drillStack.length) return;
  for (let i = 0; i < levels; i++) {
    if (!S.drillStack.length) break;
    const frame = S.drillStack.pop();
    // Restore column chip field
    const chip = S.shelf[frame.chipShelf]?.[frame.chipIndex];
    if (chip) { chip.field = frame.field; chip.type = 'dimension'; chip.agg = null; }
    // Remove the drill filter
    S.shelf.filters = S.shelf.filters.filter(f => !(f.field === frame.field && f._drillFilter));
    if (filterState[frame.field]) delete filterState[frame.field];
  }
  paintAllShelves();
  paintDrillBar();
  runQuery();
}

function drillReset() {
  while (S.drillStack.length) drillUp(1);
}

function paintDrillBar() {
  const bar = document.getElementById('drill-bar');
  const bc  = document.getElementById('drill-bc');
  if (!S.drillStack.length) { bar.classList.remove('show'); return; }
  bar.classList.add('show');
  bc.innerHTML = S.drillStack.map((frame, i) => `
    <span class="drill-bc-item">${esc(frame.hierName)}</span>
    <span class="drill-bc-sep">‚Ä∫</span>
    <span class="drill-bc-val" title="${esc(String(frame.value))}">${esc(String(frame.value))}</span>
    ${i < S.drillStack.length-1 ? '<span class="drill-bc-sep">‚Ä∫</span>' : ''}
  `).join('');
}

function addDatePart(field, part) {
  const newName = `${part}(${field})`;
  if (S.schema.find(s=>s.name===newName)) {
    setStatus(`"${newName}" already exists in sidebar`); return;
  }
  // Tell worker to create derived column
  worker.postMessage({type:'DATE_PART', payload:{field, part, newName}});
  // Optimistically add to schema
  S.schema.push({name:newName, type:'dimension', dataType:'datepart', _derived:true, _sourceField:field, _part:part});
  buildSidebar();
  setStatus(`Added date part: ${newName}`);
}

function applyNumFormat(val, field) {
  const s = S.schema.find(x=>x.name===field);
  const fmt = s?.numFormat || 'default';
  if (typeof val !== 'number') return esc(String(val??''));
  switch(fmt) {
    case 'integer':  return Math.round(val).toLocaleString();
    case 'decimal2': return val.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    case 'pct':      return val.toFixed(2)+'%';
    case 'currency': return '$'+val.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    default:         return val.toLocaleString(undefined,{maximumFractionDigits:4});
  }
}


document.addEventListener('click', closeCtxMenu);
// document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeCtxMenu(); });

function paintPills(listId, fields) {
  document.getElementById(listId).innerHTML = fields.map(f=>`
    <div class="fp ${f.type==='measure' ? (f.discrete ? 'disc' : 'mea') : 'dim'}" draggable="true"
      data-field="${esc(f.name)}" data-type="${f.type}"
      ondragstart="startDrag(event,'${esc(f.name)}','${f.type}')"
      ondragend="endDrag(event)"
      oncontextmenu="openCtxMenu(event,'${esc(f.name)}','${f.type}')"
      title="Right-click to convert type">
      <span class="fp-icon">${f.dataType==='date'?'üìÖ':f.type==='dimension'?'‚Ö¢':'#'}</span>
      <span class="fp-name">${esc(f.name)}</span>
      <span class="fp-tag">${f.dataType==='date'?'Date':f.type==='dimension'?'Abc':'Num'}</span>
    </div>`).join('');
}

function filterPills(type, val) {
  const src=S.schema.filter(s=>s.type===(type==='dim'?'dimension':'measure'));
  const q=val.toLowerCase();
  paintPills(type+'-list', q?src.filter(s=>s.name.toLowerCase().includes(q)):src);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DRAG & DROP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startDrag(e,field,type) {
  _nativeDragFired = true;
  dragF={field,type}; e.dataTransfer.effectAllowed='copy'; e.dataTransfer.setData('text/plain',field);
  document.querySelectorAll('.fp').forEach(p=>{if(p.dataset.field===field)p.classList.add('dragging');});
  const g=document.getElementById('drag-ghost'); g.textContent=field; g.style.display='block';
  e.dataTransfer.setDragImage(g,0,0);
}

function endDrag(e) {
  setTimeout(() => { _nativeDragFired = false; }, 0);
  dragF=null; chipDrag=null;
  document.querySelectorAll('.fp').forEach(p=>p.classList.remove('dragging'));
  document.getElementById('drag-ghost').style.display='none';
  clearDropIndicators();
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && (dragF || chipDrag)) {
    dragF = null; chipDrag = null;
    document.getElementById('drag-ghost').style.display = 'none';
    document.querySelectorAll('.fp').forEach(p => p.classList.remove('dragging'));
    clearDropIndicators();
  }
});

// ‚îÄ‚îÄ Mac trackpad pointer-drag fallback ‚îÄ‚îÄ
(function() {
  let pDrag = null, ghost = null, moved = false;

  document.addEventListener('pointerdown', e => {
    const pill = e.target.closest('.fp[draggable]');
    if (!pill) return;
    moved = false;
    pDrag = {
      el: pill,
      field: pill.dataset.field,
      type: pill.dataset.type,
      startX: e.clientX, startY: e.clientY,
      startTime: Date.now(),
      pointerId: e.pointerId
    };
    try { pill.setPointerCapture(e.pointerId); } catch(err) {}
  });

  document.addEventListener('pointermove', e => {
    if (!pDrag) return;
    const dx = Math.abs(e.clientX - pDrag.startX);
    const dy = Math.abs(e.clientY - pDrag.startY);
    if (!moved && (dx > 12 || dy > 12)) {
      moved = true;
      // Start logical drag
      dragF = { field: pDrag.field, type: pDrag.type };
      pDrag.el.classList.add('dragging');
      ghost = document.getElementById('drag-ghost');
      ghost.textContent = pDrag.field;
      ghost.style.display = 'block';
    }
    if (moved && ghost) {
      ghost.style.left = (e.clientX + 12) + 'px';
      ghost.style.top  = (e.clientY + 4)  + 'px';
      ghost.style.position = 'fixed';
      // Highlight shelf under cursor
      ['columns','rows','filters'].forEach(sh => {
        const el = document.getElementById('shelf-'+sh);
        const r = el.getBoundingClientRect();
        const over = e.clientX>=r.left && e.clientX<=r.right && e.clientY>=r.top && e.clientY<=r.bottom;
        el.classList.toggle('over-cols', over && sh==='columns');
        el.classList.toggle('over-rows', over && sh==='rows');
        el.classList.toggle('over-filt', over && sh==='filters');
      });
    }
  });

  document.addEventListener('pointerup', e => {
    if (!pDrag || !moved) { pDrag=null; moved=false; return; }
    if (Date.now() - pDrag.startTime < 200) { 
      if (pDrag) pDrag.el.classList.remove('dragging');
      dragF=null; pDrag=null; moved=false; return;
    }
    if (_nativeDragFired) {
      if (pDrag) pDrag.el.classList.remove('dragging');
      if (ghost) { ghost.style.display='none'; }
      dragF=null; pDrag=null; moved=false;
      return;
    }

    // Find which shelf is under cursor
    ['columns','rows','filters'].forEach(sh => {
      const el = document.getElementById('shelf-'+sh);
      const r = el.getBoundingClientRect();
      if (e.clientX>=r.left && e.clientX<=r.right && e.clientY>=r.top && e.clientY<=r.bottom) {
        el.classList.remove('over-cols','over-rows','over-filt');
        // Simulate drop
        const fakeE = { preventDefault:()=>{}, currentTarget: el, clientX: e.clientX };
        dragF = { field: pDrag.field, type: pDrag.type };
        onDrop(fakeE, sh);
      }
    });
    // Cleanup
    if (pDrag) pDrag.el.classList.remove('dragging');
    if (ghost) { ghost.style.display='none'; ghost.style.position='fixed'; }
    document.querySelectorAll('.over-cols,.over-rows,.over-filt').forEach(el=>el.classList.remove('over-cols','over-rows','over-filt'));
    dragF = null; pDrag = null; moved = false;
  });
})();


function onDragOver(e,cls) { e.preventDefault(); e.dataTransfer.dropEffect='copy'; e.currentTarget.classList.remove('over-cols','over-rows','over-filt'); e.currentTarget.classList.add('over-'+cls); }
function onDragLeave(e) { e.currentTarget.classList.remove('over-cols','over-rows','over-filt'); }

function onChipDragStart(e, shelf, index, field, type) {
  e.stopPropagation();
  chipDrag = { shelf, index, field, type };
  dragF = null; // not a sidebar drag
  e.dataTransfer.effectAllowed = 'move';
  const g = document.getElementById('drag-ghost');
  g.textContent = field; g.style.display = 'block';
  e.dataTransfer.setDragImage(g, 0, 0);
}

function onChipDragOver(e, shelf, index) {
  e.preventDefault(); e.stopPropagation();
  if (!chipDrag) return;
  e.dataTransfer.dropEffect = 'move';
  clearDropIndicators();
  const chips = document.querySelectorAll(`#shelf-${shelf} .chip, #shelf-${shelf} .fchip`);
  
  const isSameShelf = chipDrag.shelf === shelf;
  const itemCount = S.shelf[shelf].length;
  if (chips[index] && !(isSameShelf && itemCount <= 1)) {
    const rect = chips[index].getBoundingClientRect();
    const mid = rect.left + rect.width / 2;
    chips[index].classList.add(e.clientX < mid ? 'chip-drop-before' : 'chip-drop-after');
  }

  // Highlight the whole shelf too if coming from another shelf
  if (chipDrag.shelf !== shelf) {
    document.getElementById('shelf-'+shelf).classList.add('chip-over');
  }
}

function onShelfDragOver(e, cls, shelf) {
  e.preventDefault();
  e.currentTarget.classList.remove('over-cols','over-rows','over-filt');
  if (chipDrag) {
    e.currentTarget.classList.add('chip-over');
  } else {
    e.currentTarget.classList.add('over-'+cls);
  }
}

function clearDropIndicators() {
  document.querySelectorAll('.chip-drop-before,.chip-drop-after,.chip-drag-over,.chip-over')
    .forEach(el => el.classList.remove('chip-drop-before','chip-drop-after','chip-drag-over','chip-over'));
}

function onDrop(e, shelf, targetIndex) {
  e.preventDefault();
  e.stopPropagation();
  e.currentTarget.classList.remove('over-cols','over-rows','over-filt');
  clearDropIndicators();

  // ‚îÄ‚îÄ Chip reorder / cross-shelf move ‚îÄ‚îÄ
  if (chipDrag) {
    const src = chipDrag;
    chipDrag = null;
    dragF = null;
    if (src.shelf === shelf) {
      // Reorder within same shelf
      const items = S.shelf[shelf];
      const item = items.splice(src.index, 1)[0];
      const dest = targetIndex !== undefined
        ? (targetIndex > src.index ? targetIndex - 1 : targetIndex)
        : items.length;
      items.splice(dest, 0, item);
    } else {
      // Move across shelves
      const item = S.shelf[src.shelf].splice(src.index, 1)[0];
      // If moving to filters, init filterState
      if (shelf === 'filters' && !filterState[item.field]) {
        filterState[item.field] = { field:item.field, type:item.type, selectedValues:[], dataValues:[], stats:null, minVal:'', maxVal:'' };
      }
      const dest = targetIndex !== undefined ? targetIndex : S.shelf[shelf].length;
      S.shelf[shelf].splice(dest, 0, item);
      paintShelf(src.shelf);
      if (shelf === 'filters') {
        paintShelf('filters');
        fetchValuesAndOpen(item.field, item.type);
        runQuery();
        return;
      }
    }
    paintShelf(shelf);
    paintShelf(src.shelf);
    runQuery();
    return;
  }

  if (!dragF) return;

  // Pre-flight cardinality check for non-filter shelves
  if (shelf !== 'filters' && dragF.type === 'dimension') {
    const fs = filterState[dragF.field];
    const WARN_THRESHOLD = 80;
    if (fs && fs.dataValues.length >= WARN_THRESHOLD) {
      _pendingDrop = {field:dragF.field, type:dragF.type, shelf};
      showCardinalityWarning(dragF.field, dragF.type, shelf, fs.dataValues.length);
      return;
    } else if (!fs || !fs.dataValues.length) {
      
      // Fetch cardinality first, then decide
      const capturedField = dragF.field, capturedType = dragF.type;
      _pendingDrop = {field:capturedField, type:capturedType, shelf};
      const reqId = ++reqCounter;
      
      valueCallbacks[reqId] = {
        cb: (payload) => {
          if (!filterState[capturedField]) filterState[capturedField]={field:capturedField,type:capturedType,selectedValues:[],dataValues:[],stats:null,minVal:'',maxVal:''};
          filterState[capturedField].dataValues = payload.values;
          if (payload.values.length >= WARN_THRESHOLD) {
            showCardinalityWarning(capturedField, capturedType, shelf, payload.values.length);
          } else {
            _pendingDrop = null;
            proceedDrop(capturedField, capturedType, shelf);
          }
        },
        timer: setTimeout(() => { delete valueCallbacks[reqId]; }, VALUE_CB_TIMEOUT_MS)
      };

      worker.postMessage({type:'GET_VALUES', payload:{field:capturedField, type:capturedType, reqId}});
      return;
    }
  }

  const schemaEntry = S.schema.find(x=>x.name===dragF.field);
  const item={
    field: dragF.field,
    type: dragF.type,
    agg: dragF.type==='measure' ? (schemaEntry?.defaultAgg||'SUM') : null,
    discrete: schemaEntry?.discrete ?? (dragF.type === 'dimension' ? true : false),
    _uid: `${Date.now()}_${Math.random().toString(36).slice(2,8)}`
  };
  
  if (shelf==='filters') {
    // Initialize filter state
    if (!filterState[dragF.field]) {
      filterState[dragF.field]={
        field:dragF.field, type:dragF.type,
        selectedValues:[], dataValues:[], stats:null,
        minVal:'', maxVal:''
      };
    }
    S.shelf.filters.push(item);
    paintShelf('filters');
    fetchValuesAndOpen(dragF.field, dragF.type);
    dragF = null;
    return;
  }
  dragF = null;
  S.shelf[shelf].push(item);
  paintShelf(shelf);
  runQuery();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FETCH VALUES FROM WORKER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function fetchValuesAndOpen(field, type) {
  const reqId = ++reqCounter;
  valueCallbacks[reqId] = {
    cb: (payload) => {
      if (!filterState[field]) return;
      if (type==='dimension') {
        filterState[field].dataValues = payload.values;
      } else {
        filterState[field].stats = payload.stats;
      }
      paintShelf('filters');
      openFilterPopover(field);
    },
    timer: setTimeout(() => { delete valueCallbacks[reqId]; }, VALUE_CB_TIMEOUT_MS)
  };
  worker.postMessage({type:'GET_VALUES', payload:{field, type, reqId}});
}

function ensureValuesLoaded(field, type, cb) {
  const fs = filterState[field];
  if (!fs) return;
  if (type==='dimension' && fs.dataValues.length>0) { cb(); return; }
  if (type==='measure' && fs.stats) { cb(); return; }
  
  const reqId = ++reqCounter;
  valueCallbacks[reqId] = {
    cb: (payload) => {
      if (type==='dimension') fs.dataValues = payload.values;
      else fs.stats = payload.stats;
      cb();
    },
    timer: setTimeout(() => { delete valueCallbacks[reqId]; }, VALUE_CB_TIMEOUT_MS)
  };
  
  worker.postMessage({type:'GET_VALUES', payload:{field, type, reqId}});
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SHELF PAINTING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function paintShelf(name) {
  const el = document.getElementById('shelf-'+name);
  const items = S.shelf[name];
  if (!items.length) {
    const ph = name==='columns'?'Drop dimensions here':name==='rows'?'Drop dimensions or measures here':'Drop any field to filter ‚Äî click chip to configure';
    el.innerHTML=`<span class="shelf-ph">${ph}</span>`; return;
  }
  if (name==='filters') {
    el.innerHTML = items.map((f,i) => {
      const fs = filterState[f.field];
      const isActive = fs && (
        (f.type==='dimension' && fs.selectedValues.length>0) ||
        (f.type==='measure' && (fs.minVal!==''||fs.maxVal!==''))
      );
      const summary = getFilterSummary(f.field, f.type);
      const isOpen = openPopoverField === f.field;
      return `<div class="fchip ${isActive?'active-filter':''} ${isOpen?'open':''}" id="fchip-${i}"
        draggable="true"
        ondragstart="onChipDragStart(event,'filters',${i},'${esc(f.field)}','${f.type}')"
        ondragend="endDrag(event)"
        ondragover="onChipDragOver(event,'filters',${i})"
        ondrop="onDrop(event,'filters',${i})"
        onclick="onChipClick(event,'${esc(f.field)}','${f.type}',${i})">

        <span class="fchip-dot"></span>
        <span class="fchip-field">${esc(f.field)}</span>${f.type==='measure'?`<span style="font-family:var(--mono);font-size:9px;opacity:.6;margin-left:2px;">${f.agg||'SUM'}</span>`:''}
        <span class="fchip-summary">${summary}</span>
        <span class="fchip-caret">‚ñæ</span>
        <button class="fchip-rm" onclick="removeFilter(event,${i})" title="Remove filter">‚úï</button>
      </div>`;
    }).join('');
    return;
  }
  el.innerHTML = items.map((f,i) => {
    const cls = f.type === 'measure'
      ? (f.discrete ? 'dim' : 'mea')   // discrete measure = blue chip
      : 'dim';
    const measKey = f._uid ? `${f.agg}(${f.field})__${f._uid}` : `${f.agg}(${f.field})`;
    const curTx = colTransforms[measKey]||'none';
    const txLabels = {'none':'‚Äî','pct':'%‚àë','pct_row':'%Row','running':'‚àë‚Üì','rank':'Rank','diff':'Œî','pct_diff':'Œî%','ma':`MA${colMaWindow[measKey]||3}`};
    const badgeLabel = curTx && curTx!=='none'
      ? `${f.agg} ‚Üí ${txLabels[curTx]}`
      : f.agg;
    const agg = f.type==='measure'
      ? `<span class="chip-badge" onclick="openMeaPopup(event,'${name}',${i})" title="Click to configure">${badgeLabel} ‚ñæ</span>`
      : '';
        const isDualKey = f._uid ? `${f.agg}(${f.field})__${f._uid}` : `${f.agg}(${f.field})`;
        const isDualChip = f.type==='measure' && dualAxisKeys.has(isDualKey);
        return `<div class="chip ${cls}" draggable="false"
          onmousedown="this.draggable=true"
          onmouseup="this.draggable=false"
          ondragstart="onChipDragStart(event,'${name}',${i},'${esc(f.field)}','${f.type}')"
          ondragend="endDrag(event);this.draggable=false"
          ondragover="onChipDragOver(event,'${name}',${i})"
          ondrop="onDrop(event,'${name}',${i})"
          oncontextmenu="openChipCtxMenu(event,'${name}',${i})"
          style="cursor:grab;${isDualChip?'border-style:dashed;':''}"
          title="Right-click for options">
          ${agg}<span>${esc(f.field)}</span>${isDualChip ? '<span style="font-size:9px;opacity:.6;margin-left:2px;" title="Dual axis">‚áÖ</span>' : ''}${(f.type==='measure' && S.result && S.result.total < S.rowCount) ? `<span style="font-size:9px;opacity:.4;margin-left:3px;font-family:var(--mono);" title="${fmtN(S.rowCount)} rows aggregated into ${fmtN(S.result.total)} groups">${fmtN(S.result.total)}g</span>` : ''}<button class="rm" onclick="removeChip('${name}',${i})">‚úï</button></div>`;

  }).join('');
}

/* ‚îÄ‚îÄ MEASURE CONFIG POPUP ‚îÄ‚îÄ */
let _mpShelf=null, _mpIndex=-1;

function openMeaPopup(e, shelf, index) {
  e.stopPropagation();
  _mpShelf = shelf; _mpIndex = index;
  const f = S.shelf[shelf][index]; if (!f) return;
  const measKey = f._uid ? `${f.agg}(${f.field})__${f._uid}` : `${f.agg}(${f.field})`;
  const curTx = colTransforms[measKey] || 'none';
  const curMa = colMaWindow[measKey] || 3;

  const aggOpts   = ['SUM','AVG','COUNT','COUNTD','MAX','MIN','LAST','FIRST'];
  const txOpts    = [
    ['none','None'],['pct','% Total'],['pct_row','% Row'],
    ['running','Running ‚àë'],['rank','Rank'],['diff','Difference'],
    ['pct_diff','% Difference'],['ma','Moving Avg']
  ];

  const pop = document.getElementById('mea-popup');
  pop.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <span style="font-size:12px;font-weight:600;color:var(--ink);">${esc(f.field)}</span>
      <button onclick="closeMeaPopup()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:15px;line-height:1;">‚úï</button>
    </div>
    <div class="mp-section">Aggregation</div>
    <div class="mp-opts">${aggOpts.map(a=>`<div class="mp-opt${f.agg===a?' active':''}" onclick="mpSetAgg('${a}')">${a}</div>`).join('')}</div>
    <div class="mp-section">Table Calculation</div>
    <div class="mp-opts">${txOpts.map(([v,l])=>`<div class="mp-opt${curTx===v?' active':''}" onclick="mpSetTx('${v}')">${l}</div>`).join('')}</div>
    <div class="mp-ma-row" id="mp-ma-row" style="display:${curTx==='ma'?'flex':'none'};">
      <span style="font-size:11px;color:var(--muted);">Window:</span>
      <input type="number" min="2" max="50" value="${curMa}" id="mp-ma-inp"
        onchange="mpSetMa(this.value)"
        style="width:50px;border:1.5px solid var(--rule);border-radius:4px;padding:3px 6px;font-family:var(--mono);font-size:11px;background:var(--cream);outline:none;">
    </div>
    <div class="mp-preview" id="mp-preview"></div>`;

  updateMpPreview();
  pop.classList.add('show');
  const rect = e.target.getBoundingClientRect();
  const x = Math.min(rect.left, window.innerWidth - 280);
  const y = Math.min(rect.bottom + 4, window.innerHeight - 320);
  pop.style.left = x + 'px';
  pop.style.top  = y + 'px';
}

function closeMeaPopup() {
  document.getElementById('mea-popup').classList.remove('show');
  _mpShelf = null; _mpIndex = -1;
}

function updateMpPreview() {
  const f = _mpShelf ? S.shelf[_mpShelf][_mpIndex] : null; if (!f) return;
   
  const measKey = f._uid ? `${f.agg}(${f.field})__${f._uid}` : `${f.agg}(${f.field})`;
  const tx = colTransforms[measKey] || 'none';
  const txNames = {'none':'','pct':' as % of Total','pct_row':' as % of Row','running':' as Running Sum',
    'rank':' as Rank','diff':' as Difference from Previous','pct_diff':' as % Difference from Previous',
    'ma':` as ${colMaWindow[measKey]||3}-period Moving Avg`};
  const el = document.getElementById('mp-preview');
  if (el) el.innerHTML = `Displays as: <strong>${f.agg}(${f.field})${txNames[tx]||''}</strong>`;
}

function mpSetAgg(agg) {
  if (_mpShelf === null) return;
  const f = S.shelf[_mpShelf][_mpIndex]; if (!f) return;
  const oldKey = f._uid ? `${f.agg}(${f.field})__${f._uid}` : `${f.agg}(${f.field})`;
  const newKey = f._uid ? `${agg}(${f.field})__${f._uid}` : `${agg}(${f.field})`;
  // migrate transform to new key
  if (colTransforms[oldKey]) { colTransforms[newKey] = colTransforms[oldKey]; delete colTransforms[oldKey]; }
  if (colMaWindow[oldKey])   { colMaWindow[newKey]   = colMaWindow[oldKey];   delete colMaWindow[oldKey]; }
  if (dualAxisKeys.has(oldKey)) { dualAxisKeys.delete(oldKey); dualAxisKeys.add(newKey); }
  changeAgg(_mpShelf, _mpIndex, agg);
  const aggGroup = document.querySelectorAll('#mea-popup .mp-opts')[0];
  if (aggGroup) aggGroup.querySelectorAll('.mp-opt').forEach(el => {
    el.classList.toggle('active', el.textContent.trim() === agg);
  });
  updateMpPreview();
  saveState();
}

function mpSetTx(tx) {
  if (_mpShelf === null) return;
  const f = S.shelf[_mpShelf][_mpIndex]; if (!f) return;
  const measKey = f._uid ? `${f.agg}(${f.field})__${f._uid}` : `${f.agg}(${f.field})`;
  setColTransform(measKey, tx);

  const txGroup = document.querySelectorAll('#mea-popup .mp-opts')[1];
  if (txGroup) txGroup.querySelectorAll('.mp-opt').forEach((el,i) => {
    const vals = ['none','pct','pct_row','running','rank','diff','pct_diff','ma'];
    el.classList.toggle('active', vals[i] === tx);
  });

  const maRow = document.getElementById('mp-ma-row');
  if (maRow) maRow.style.display = tx === 'ma' ? 'flex' : 'none';
  updateMpPreview();
  saveState();
}

function mpSetMa(val) {
  if (_mpShelf === null) return;
  const f = S.shelf[_mpShelf][_mpIndex]; if (!f) return;
  const measKey = f._uid ? `${f.agg}(${f.field})__${f._uid}` : `${f.agg}(${f.field})`;
  setMaWindow(measKey, val);
  updateMpPreview();
  saveState();
}

document.addEventListener('click', e => {
  const pop = document.getElementById('mea-popup');
  if (pop && pop.classList.contains('show') && !pop.contains(e.target)) closeMeaPopup();
});

function getFilterSummary(field, type) {
  const fs = filterState[field];
  if (!fs) return '<span style="opacity:.5">loading‚Ä¶</span>';
  if (type==='dimension') {
    const sel = fs.selectedValues;
    if (!sel.length) return '<span style="opacity:.5">All values</span>';
    if (sel.length===1) return esc(String(sel[0]).slice(0,18)+(String(sel[0]).length>18?'‚Ä¶':''));
    return `<strong>${sel.length}</strong> selected`;
  } else {
    const {minVal,maxVal}=fs;
    if (minVal===''&&maxVal==='') return '<span style="opacity:.5">Any</span>';
    if (minVal!==''&&maxVal!=='') return `${fmtNum(+minVal)} ‚Äì ${fmtNum(+maxVal)}`;
    if (minVal!=='') return `‚â• ${fmtNum(+minVal)}`;
    return `‚â§ ${fmtNum(+maxVal)}`;
  }
}

function fmtNum(n) {
  if (Math.abs(n)>=1e6) return (n/1e6).toFixed(1)+'M';
  if (Math.abs(n)>=1e3) return (n/1e3).toFixed(1)+'K';
  return n.toLocaleString(undefined,{maximumFractionDigits:2});
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHIP ACTIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function changeAgg(sh,i,v) { S.shelf[sh][i].agg=v; runQuery(); }
function removeChip(sh,i) {
  if (_mpShelf === sh && _mpIndex === i) closeMeaPopup();
  else if (_mpShelf === sh && _mpIndex > i) _mpIndex--;
  const f = S.shelf[sh][i];
  if (f && f.type==='measure') {
    const plainKey = `${f.agg}(${f.field})`;
    const uidKey = f._uid ? `${f.agg}(${f.field})__${f._uid}` : null;
    delete colTransforms[plainKey];
    delete colMaWindow[plainKey];
    if (uidKey) { delete colTransforms[uidKey]; delete colMaWindow[uidKey]; }
    dualAxisKeys.delete(plainKey);
  }
  S.shelf[sh].splice(i,1);
  paintShelf(sh);
  saveState();
  runQuery();
}
function removeFilter(e,i) {
  e.stopPropagation();
  const field=S.shelf.filters[i]?.field;
  if (field && filterState[field]) { delete filterState[field]; }
  S.shelf.filters.splice(i,1);
  if (openPopoverField===field) closePopover();
  paintShelf('filters'); runQuery();
  saveState();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FILTER POPOVER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function onChipClick(e, field, type, idx) {
  e.stopPropagation();
  if (openPopoverField===field) { closePopover(); return; }
  ensureValuesLoaded(field, type, () => {
    openFilterPopover(field);
  });
}

function openFilterPopover(field) {
  closePopover();
  openPopoverField = field;
  paintShelf('filters'); // refresh open class

  const fs = filterState[field];
  if (!fs) return;
  const pop = document.getElementById('filter-popover');

  if (fs.type==='dimension') {
    pop.innerHTML = buildDimPopover(field);
  } else {
    pop.innerHTML = buildMeaPopover(field);
  }

  // Position below the chip
  pop.classList.add('show');
  const chip = document.querySelector(`.fchip.open`);
  if (chip) {
    const rect = chip.getBoundingClientRect();
    const popW = 280, winW = window.innerWidth;
    let left = rect.left;
    if (left+popW > winW-8) left = winW-popW-8;
    pop.style.top = (rect.bottom+5)+'px';
    pop.style.left = left+'px';
  }
  // Focus search if dim
  if (fs.type==='dimension') {
    setTimeout(()=>{ const inp=pop.querySelector('.fp-val-search'); if(inp) inp.focus(); },50);
  }
}

function closePopover() {
  document.getElementById('filter-popover').classList.remove('show');
  openPopoverField=null;
  // Clean up registry entries to prevent memory leak
  Object.keys(_reg).forEach(k => { if (_reg[k] && _reg[k].field) _regDel(k); });
  paintShelf('filters');
}

/* ‚îÄ‚îÄ DIM POPOVER ‚îÄ‚îÄ */
function buildDimPopover(field) {
  const fs = filterState[field];
  const total = fs.dataValues.reduce((s,x)=>s+x.c,0);
  return `
    <div class="fp-header">
      <span class="fp-field-name">${esc(field)}</span>
      <span class="fp-type-pill dim">Dimension</span>
    </div>
    <div class="fp-search-wrap">
      <input class="fp-val-search" placeholder="Search values‚Ä¶" oninput="filterPopoverValues('${esc(field)}',this.value)" autocomplete="off">
    </div>


    <div class="fp-topn-bar" style="padding:8px 12px;border-bottom:1px solid var(--rule);display:flex;align-items:center;gap:8px;">
      <span style="font-size:11px;color:var(--muted);">Top N</span>
      <input type="number" min="1" max="10000"
        id="topn-input-${CSS.escape(field)}"
        placeholder="e.g. 10"
        value="${filterState[field]?.topN||''}"
        oninput="setTopN('${esc(field)}',this.value)"
        style="width:70px;border:1.5px solid var(--rule);border-radius:4px;padding:4px 7px;font-family:var(--mono);font-size:11px;outline:none;background:var(--cream);">
      ${S.params.filter(p=>p.type==='integer'||p.type==='float').length ? `
      <select onchange="bindTopNParam('${esc(field)}',this.value)"
        style="border:1.5px solid var(--rule);border-radius:4px;padding:4px 6px;font-size:10.5px;font-family:var(--font);background:var(--cream);color:var(--muted);outline:none;">
        <option value="">param‚Ä¶</option>
        ${S.params.filter(p=>p.type==='integer'||p.type==='float').map(p=>`
          <option value="${p.id}" ${filterState[field]?.topNParamId===p.id?'selected':''}>${esc(p.name)}</option>
        `).join('')}
      </select>` : ''}

      <select id="topn-by-${CSS.escape(field)}"
        onchange="setTopNBy('${esc(field)}',this.value)"
        style="flex:1;border:1.5px solid var(--rule);border-radius:4px;padding:4px 7px;font-family:var(--font);font-size:11px;outline:none;background:var(--cream);color:var(--ink);">
        <option value="">‚Äî by field ‚Äî</option>
        ${S.schema.filter(s=>s.type==='measure').map(s=>`<option value="${esc(s.name)}" ${filterState[field]?.topNBy===s.name?'selected':''}>${esc(s.name)}</option>`).join('')}
      </select>
      <select id="topn-dir-${CSS.escape(field)}"
        onchange="setTopNDir('${esc(field)}',this.value)"
        style="border:1.5px solid var(--rule);border-radius:4px;padding:4px 7px;font-family:var(--font);font-size:11px;outline:none;background:var(--cream);color:var(--ink);">
        <option value="top" ${(filterState[field]?.topNDir||'top')==='top'?'selected':''}>Top</option>
        <option value="bottom" ${filterState[field]?.topNDir==='bottom'?'selected':''}>Bottom</option>
      </select>
      ${filterState[field]?.topN?`<button onclick="clearTopN('${esc(field)}')" style="background:none;border:none;color:var(--rose);cursor:pointer;font-size:11px;">‚úï</button>`:''}
    </div>

    <div class="fp-actions-top">
      <button class="fp-act-btn" onclick="selectAll('${esc(field)}')">Select all</button>
      <span class="fp-act-sep">¬∑</span>
      <button class="fp-act-btn" onclick="deselectAll('${esc(field)}')">Clear</button>
      <span class="fp-act-sep">¬∑</span>
      <span style="font-size:10.5px;color:var(--faint);font-family:var(--mono)">${fmtN(fs.dataValues.length)} unique</span>
    </div>


    <div class="fp-val-list" id="fval-list-${CSS.escape(field)}">
      ${buildValList(field, '')}
    </div>
    <div class="fp-footer">
      <div class="fp-footer-info">
        <strong>${fs.selectedValues.length || fs.dataValues.length}</strong>
        of ${fmtN(fs.dataValues.length)} shown
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="fp-clear-filter" onclick="deselectAll('${esc(field)}');applyFilter()">Reset</button>
        <button class="fp-apply" onclick="applyFilter()">Apply</button>
      </div>
    </div>`;
}

function buildValList(field, search) {
  const fs = filterState[field];
  if (!fs) return '';
  const q = search.toLowerCase();
  const filtered = q ? fs.dataValues.filter(x=>x.v.toLowerCase().includes(q)) : fs.dataValues;
  if (!filtered.length) return `<div class="fp-no-results">No values match "${esc(search)}"</div>`;
  const maxShow = 200;
  const shown = filtered.slice(0, maxShow);
  const checked = new Set(fs.selectedValues);
  return shown.map(({v,c}) => {
    const isChecked = checked.has(v);
    const vEsc = esc(v);
    // Store value in registry ‚Äî no user data touches the onclick string
    const _rk = _regSet({ field, val: v });
    return `<div class="fp-val-item" onclick="_toggleValReg(${_rk},this)">
      <input type="checkbox" ${isChecked?'checked':''} onclick="event.stopPropagation();_toggleValReg(${_rk},this.closest('.fp-val-item'))">
      <span class="fp-val-label" title="${vEsc}">${vEsc||'<em style="color:var(--faint)">(blank)</em>'}</span>
      <span class="fp-val-count">${fmtN(c)}</span>
    </div>`;
  }).join('') + (filtered.length>maxShow?`<div class="fp-no-results">+${fmtN(filtered.length-maxShow)} more ‚Äî narrow your search</div>`:'');
}

function filterPopoverValues(field, search) {
  const listEl = document.getElementById('fval-list-'+CSS.escape(field));
  if (listEl) listEl.innerHTML = buildValList(field, search);
  // Update footer count
  updateFooterCount(field);
}

function _toggleValReg(k, itemEl) {
  const entry = _regGet(k); if (!entry) return;
  toggleVal(entry.field, entry.val, itemEl);
}

function toggleVal(field, val, itemEl) {
  const fs = filterState[field]; if (!fs) return;
  const idx = fs.selectedValues.indexOf(val);
  if (idx>-1) fs.selectedValues.splice(idx,1);
  else fs.selectedValues.push(val);
  // Update checkbox state
  const cb = itemEl.querySelector('input[type=checkbox]');
  if (cb) cb.checked = idx===-1;
  updateFooterCount(field);
  paintShelf('filters'); // update chip summary
}

function updateFooterCount(field) {
  const fs = filterState[field]; if (!fs) return;
  const pop = document.getElementById('filter-popover');
  const info = pop.querySelector('.fp-footer-info');
  if (info) {
    const sel = fs.selectedValues.length;
    info.innerHTML = `<strong>${sel||fs.dataValues.length}</strong> of ${fmtN(fs.dataValues.length)} shown`;
  }
}

function selectAll(field) {
  const fs = filterState[field]; if (!fs) return;
  fs.selectedValues = [];
  const search = document.querySelector('.fp-val-search')?.value||'';
  filterPopoverValues(field, search);
  paintShelf('filters');
}

function deselectAll(field) {
  const fs = filterState[field]; if (!fs) return;
  fs.selectedValues = [];
  const listId = 'fval-list-'+CSS.escape(field);
  const listEl = document.getElementById(listId);
  if (listEl) listEl.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
  updateFooterCount(field);
  paintShelf('filters');
}

function applyFilter() {
  closePopover();
  runQuery();
}

/* ‚îÄ‚îÄ MEA POPOVER ‚îÄ‚îÄ */
function buildMeaPopover(field) {
  const fs = filterState[field];
  const s = fs.stats || {min:0,max:0,mean:0};
  const presets = [
    { label:'> 0', min:'0', max:'' },
    { label:'Top half', min: fmtRaw(s.mean), max:'' },
    { label:'Bottom half', min:'', max: fmtRaw(s.mean) },
  ];
  return `
    <div class="fp-header">
      <span class="fp-field-name">${esc(field)}</span>
      <span class="fp-type-pill mea">Measure</span>
    </div>
    <div class="fp-range-body">
      <div class="fp-range-info">
        <div class="fp-range-bound">
          <div class="fp-range-label">Data Min</div>
          <div class="fp-range-val">${fmtNum(s.min)}</div>
        </div>
        <span class="fp-range-arrow">‚Üí</span>
        <div class="fp-range-bound">
          <div class="fp-range-label">Mean</div>
          <div class="fp-range-val" style="color:var(--forest)">${fmtNum(s.mean)}</div>
        </div>
        <span class="fp-range-arrow">‚Üí</span>
        <div class="fp-range-bound">
          <div class="fp-range-label">Data Max</div>
          <div class="fp-range-val">${fmtNum(s.max)}</div>
        </div>
      </div>
      <div class="fp-inputs">
        <input class="fp-range-input" id="flt-min-${esc(field)}"
          placeholder="Min (‚â•)" type="number"
          value="${fs.minVal!==''?fs.minVal:''}"
          oninput="updateRangeFilter('${esc(field)}','min',this.value)"
          step="any">
        <span class="fp-input-sep">‚Äî</span>
        <input class="fp-range-input" id="flt-max-${esc(field)}"
          placeholder="Max (‚â§)" type="number"
          value="${fs.maxVal!==''?fs.maxVal:''}"
          oninput="updateRangeFilter('${esc(field)}','max',this.value)"
          step="any">
      </div>
      <div class="fp-quick-presets">
        ${presets.map(p=>`<button class="fp-preset" onclick="applyPreset('${esc(field)}','${p.min}','${p.max}')">${p.label}</button>`).join('')}
        <button class="fp-preset" onclick="clearRangeFilter('${esc(field)}')">Clear range</button>
      </div>
    </div>
    <div class="fp-footer">
      <div class="fp-footer-info" id="mea-footer-${esc(field)}">Set min and/or max to filter</div>
      <button class="fp-apply" onclick="applyFilter()">Apply</button>
    </div>`;
}

function fmtRaw(n) { return isFinite(n)?Number(n.toFixed(6)):''; }

function updateRangeFilter(field, side, val) {
  const fs = filterState[field]; if (!fs) return;
  if (side==='min') fs.minVal=val; else fs.maxVal=val;
  paintShelf('filters');
  // update footer text
  const footer = document.getElementById('mea-footer-'+CSS.escape(field));
  if (footer) {
    const {minVal,maxVal}=fs;
    if (minVal===''&&maxVal==='') footer.textContent='No range set ‚Äî showing all';
    else if (minVal!==''&&maxVal!=='') footer.innerHTML=`Filter: <strong>${fmtNum(+minVal)}</strong> ‚Üí <strong>${fmtNum(+maxVal)}</strong>`;
    else if (minVal!=='') footer.innerHTML=`Filter: ‚â• <strong>${fmtNum(+minVal)}</strong>`;
    else footer.innerHTML=`Filter: ‚â§ <strong>${fmtNum(+maxVal)}</strong>`;
  }
}

function applyPreset(field, min, max) {
  const fs = filterState[field]; if (!fs) return;
  fs.minVal=min; fs.maxVal=max;
  const minEl=document.getElementById('flt-min-'+CSS.escape(field));
  const maxEl=document.getElementById('flt-max-'+CSS.escape(field));
  if (minEl) minEl.value=min;
  if (maxEl) maxEl.value=max;
  updateRangeFilter(field,'min',min);
  closePopover();
  runQuery();
}

function clearRangeFilter(field) {
  const fs=filterState[field]; if(!fs) return;
  fs.minVal=''; fs.maxVal='';
  const minEl=document.getElementById('flt-min-'+CSS.escape(field));
  const maxEl=document.getElementById('flt-max-'+CSS.escape(field));
  if (minEl) minEl.value='';
  if (maxEl) maxEl.value='';
  updateRangeFilter(field,'min','');
}

function setTopN(field, val) {
  const fs = filterState[field]; if (!fs) return;
  fs.topN = val ? parseInt(val) : null;
  paintShelf('filters');
}
function setTopNBy(field, val) {
  const fs = filterState[field]; if (!fs) return;
  fs.topNBy = val || null;
}
function setTopNDir(field, val) {
  const fs = filterState[field]; if (!fs) return;
  fs.topNDir = val;
}
function clearTopN(field) {
  const fs = filterState[field]; if (!fs) return;
  fs.topN = null; fs.topNBy = null; fs.topNDir = 'top';
  openFilterPopover(field);
  paintShelf('filters');
}

function bindTopNParam(field, paramId) {
  const fs = filterState[field]; if (!fs) return;
  if (!paramId) { fs.topNParamId = null; return; }
  const id = parseInt(paramId);
  const p  = S.params.find(x => x.id === id); if (!p) return;
  fs.topNParamId = id;
  fs.topN = p.currentVal;
  const inp = document.getElementById('topn-input-' + CSS.escape(field));
  if (inp) inp.value = p.currentVal;
  paintShelf('filters');
  runQuery();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   REFERENCE LINES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _rlIdCounter = 0;

function toggleRefLinePanel() {
  const panel = document.getElementById('refline-panel');
  panel.classList.toggle('show');
  if (panel.classList.contains('show')) populateRlMeasures();
}

function populateRlMeasures() {
  const sel = document.getElementById('rl-measure');
  const meas = [...S.shelf.columns, ...S.shelf.rows].filter(f => f.type === 'measure');
  sel.innerHTML = meas.length
    ? meas.map(m => `<option value="${esc(m.agg+'('+m.field+')')}">${esc(m.agg+'('+m.field+')')}</option>`).join('')
    : '<option value="">‚Äî add a measure first ‚Äî</option>';
}

document.getElementById('rl-type').addEventListener('change', function() {
  document.getElementById('rl-const').style.display = this.value === 'constant' ? '' : 'none';
});

function addRefLine() {
  const type    = document.getElementById('rl-type').value;
  const measure = document.getElementById('rl-measure').value;
  const color   = document.getElementById('rl-color').value;
  const label   = document.getElementById('rl-label').value.trim();
  const constV  = parseFloat(document.getElementById('rl-const').value);

  if (!measure) return;
  if (type === 'constant' && isNaN(constV)) return;

  S.refLines.push({
    id: ++_rlIdCounter,
    type, measure, color,
    label: label || (type === 'constant' ? String(constV) : type.charAt(0).toUpperCase()+type.slice(1)),
    value: type === 'constant' ? constV : null
  });

  document.getElementById('rl-label').value = '';
  document.getElementById('rl-const').value = '';
  paintRefLineList();
  if (S.result) render();
}

function removeRefLine(id) {
  S.refLines = S.refLines.filter(r => r.id !== id);
  paintRefLineList();
  if (S.result) render();
}

function paintRefLineList() {
  const el = document.getElementById('rl-list');
  if (!S.refLines.length) {
    el.innerHTML = '<div class="rl-empty">No reference lines yet</div>'; return;
  }
  el.innerHTML = S.refLines.map(r => `
    <div class="rl-chip">
      <span class="rl-chip-dot" style="background:${r.color}"></span>
      <span class="rl-chip-label">${esc(r.label)} ¬∑ ${esc(r.type)} ¬∑ ${esc(r.measure)}</span>
      <button class="rl-chip-rm" onclick="removeRefLine(${r.id})">‚úï</button>
    </div>`).join('');
}

function computeRefLineValue(rl, rows) {
  const vals = rows.map(r => +(r[rl.measure] || 0)).filter(v => !isNaN(v));
  if (!vals.length) return null;
  switch (rl.type) {
    case 'average':  return vals.reduce((a,b) => a+b, 0) / vals.length;
    case 'median': {
      const s = [...vals].sort((a,b) => a-b);
      const m = Math.floor(s.length/2);
      return s.length % 2 ? s[m] : (s[m-1]+s[m])/2;
    }
    case 'max':      return Math.max(...vals);
    case 'min':      return Math.min(...vals);
    case 'constant': return rl.value;
    default:         return null;
  }
}

function buildMarkLines(rows) {
  // Returns per-measure markLine data to inject into series
  // { [measKey]: { data: [...], silent:false } }
  const result = {};
  S.refLines.forEach(rl => {
    const val = computeRefLineValue(rl, rows);
    if (val === null) return;
    if (!result[rl.measure]) result[rl.measure] = { data: [] };
    result[rl.measure].data.push({
      yAxis: val,
      name: rl.label,
      label: { show:true, position:'end', fontSize:10, color:rl.color,
               formatter: p => `${rl.label}: ${fmtNum(p.value)}` },
      lineStyle: { color:rl.color, width:1.5, type:'dashed' },
      symbol: ['none','none']
    });
  });
  return result;
}

function openChipCtxMenu(e, shelf, index) {
  e.preventDefault(); e.stopPropagation();
  const f = S.shelf[shelf][index];
  if (!f) return;
  const menu = document.getElementById('ctx-menu');
  let html = '';
  html += `<div class="ctx-label">${esc(f.field)}</div>`;
  html += `<div class="ctx-sep"></div>`;

  if (f.type === 'measure') {
    const measKey = f._uid ? `${f.agg}(${f.field})__${f._uid}` : `${f.agg}(${f.field})`;
    const isDual  = dualAxisKeys.has(measKey);
    html += `<div class="ctx-item" onclick="toggleDualAxis('${esc(measKey)}');closeCtxMenu()">
      <span>${isDual ? '‚úì ' : ''}Dual Axis (right Y)</span>
    </div>`;
    html += `<div class="ctx-sep"></div>`;
  }

  html += `<div class="ctx-item" onclick="removeChip('${shelf}',${index});closeCtxMenu()">
    <span style="color:var(--rose);">Remove from shelf</span>
  </div>`;

  document.getElementById('ctx-menu-inner').innerHTML = html;
  menu.style.display = 'block';
  const x = Math.min(e.clientX, window.innerWidth - 220);
  const y = Math.min(e.clientY, window.innerHeight - 160);
  menu.style.left = x + 'px';
  menu.style.top  = y + 'px';
}

function toggleDualAxis(measKey) {
  if (dualAxisKeys.has(measKey)) dualAxisKeys.delete(measKey);
  else dualAxisKeys.add(measKey);
  paintAllShelves();
  if (S.result) render();
}

function setColTransform(measKey, val) {
  colTransforms[measKey] = val==='none' ? null : val;
  if (val === 'ma' && !colMaWindow[measKey]) colMaWindow[measKey] = 3;
  paintAllShelves(); // repaint so MA window input appears/disappears
  if (S.result) render();
}

function setMaWindow(measKey, val) {
  const n = Math.max(2, Math.min(50, parseInt(val)||3));
  colMaWindow[measKey] = n;
  if (S.result) render();
}


function applyTransforms(headers, rows) {
  if (!rows.length) return rows;
  const measHeaders = headers.filter(h=>h.includes('('));
  const hasAnyTx = measHeaders.some(h => colTransforms[h]);
  if (!hasAnyTx) return rows;
  const out = rows.map(r => Object.assign({}, r));
  measHeaders.forEach(h => {
    const tx = colTransforms[h];
    if (!tx) return;
    const vals = out.map(r => +r[h]||0);
    const total = vals.reduce((s,v)=>s+v, 0);

    if (tx === 'pct') {
      out.forEach((r,i) => r[h] = total ? +((vals[i]/total*100).toFixed(2)) : 0);
    }
    else if (tx === 'pct_row') {
      const expandedPlains = new Set(
        measHeaders.filter(mh => mh.includes('__'))
                   .map(mh => mh.replace(/__[\d.]+$/, ''))
      );
      const rowHeaders = measHeaders.filter(mh => !expandedPlains.has(mh));
      out.forEach((r,i) => {
        const rowTotal = rowHeaders.reduce((s,mh) => (+r[mh]||0)+s, 0);
        r[h] = rowTotal ? +((vals[i]/rowTotal*100).toFixed(2)) : 0;
      });
    }
    else if (tx === 'running') {
      let acc = 0;
      out.forEach((r,i) => { acc += vals[i]; r[h] = +acc.toFixed(4); });
    }
    else if (tx === 'rank') {
      const sorted = [...vals].sort((a,b)=>b-a);
      const rankMap = new Map();
      sorted.forEach((v,i) => { if (!rankMap.has(v)) rankMap.set(v, i+1); });
      out.forEach((r,i) => { r[h] = rankMap.get(vals[i]) ?? i+1; });
    }
    else if (tx === 'diff') {
      // val[i] - val[i-1], first row gets null
      out.forEach((r,i) => {
        r[h] = i === 0 ? null : +((vals[i] - vals[i-1]).toFixed(4));
      });
    }
    else if (tx === 'pct_diff') {
      // (val[i] - val[i-1]) / |val[i-1]| * 100, first row gets null
      out.forEach((r,i) => {
        if (i === 0 || vals[i-1] === 0) { r[h] = null; return; }
        r[h] = +((( vals[i] - vals[i-1]) / Math.abs(vals[i-1]) * 100).toFixed(2));
      });
    }
    else if (tx === 'ma') {
      const n = colMaWindow[h] || 3;
      out.forEach((r,i) => {
        if (i < n - 1) { r[h] = null; return; } // not enough prior rows
        let sum = 0;
        for (let k = i - n + 1; k <= i; k++) sum += vals[k];
        r[h] = +(sum / n).toFixed(4);
      });
    }
  });
  return out;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   QUERY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _queryTimer = null;
let _queryActive = false;
let _queryId = 0;
let _previewMode = false;
let _previewShelfBackup = null;
let _previewRowCount = 100;

function cancelQuery() {
  worker.terminate(); // kill in-flight computation immediately
  _queryActive = false;
  clearTimeout(_queryTimer);
  _queryTimer = null;
  document.getElementById('query-overlay').style.display = 'none';
  setStatus('Query cancelled');
  // Properly recreate ‚Äî worker is let so reassignment works
  worker = _createWorker();
}

let _saveTimer = null;

function saveState() {
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(() => {
  try {
    const state = {
      _version: 1,
      filename: S.filename,
      shelf: S.shelf,
      params: S.params,
      lodFields: S.lodFields,
      hierarchies: S.hierarchies,
      refLines: S.refLines,
      chartType: S.chartType,
      view: S.view,
      totals: S.totals,
      transforms: colTransforms,
      maWindows: colMaWindow,
      dualAxis: [...dualAxisKeys],
      filterState,
      sortState
    };
    const _json = JSON.stringify(state);
    if (_json.length > 4 * 1024 * 1024) {
      localStorage.setItem('dvs_state', JSON.stringify({...state, filterState:{}}));
    } else {
      localStorage.setItem('dvs_state', _json);
    }
  } catch(e) {}
  }, 800);
}

function checkRestoreBanner() {
  try {
    const raw = localStorage.getItem('dvs_state');
    if (!raw) return;
    const s = JSON.parse(raw);
    const hasShelf = s.shelf && ([...s.shelf.columns||[],...s.shelf.rows||[],...s.shelf.filters||[]].length > 0);
    if (s.filename && hasShelf) {
      if (sessionStorage.getItem('dvs_banner_dismissed')) return;
      const fieldCount = [...s.shelf.columns||[],...s.shelf.rows||[]].length;
      document.getElementById('rb-filename').textContent = `${s.filename} ¬∑ ${fieldCount} field${fieldCount!==1?'s':''} configured`;
      document.getElementById('restore-banner').classList.add('show');
    }
  } catch(e) {}
}

function dismissRestoreBanner() {
  document.getElementById('restore-banner').classList.remove('show');
  sessionStorage.setItem('dvs_banner_dismissed', '1');

}

function restoreState() {
  try {
    const raw = localStorage.getItem('dvs_state');
    if (!raw) { runQuery(); return; }
    const s = JSON.parse(raw);
    if (!s._version || s._version < 1) {
      localStorage.removeItem('dvs_state');
      runQuery(); return;
    }
    const validFields = new Set(S.schema.map(f => f.name));
    const filterShelf = (arr) => (arr||[]).filter(f => validFields.has(f.field));
    S.shelf = {
      columns: filterShelf(s.shelf?.columns),
      rows:    filterShelf(s.shelf?.rows),
      filters: filterShelf(s.shelf?.filters)
    };
    S.params      = s.params      || [];
    S.lodFields   = s.lodFields   || [];
    S.hierarchies = s.hierarchies || {};
    S.refLines    = s.refLines    || [];
    S.chartType   = s.chartType   || 'bar';
    S.view        = s.view        || 'table';
    S.totals      = s.totals      || {grandRow:false,grandCol:false,subtotals:false};
    Object.assign(colTransforms, s.transforms || {});
    Object.assign(colMaWindow,   s.maWindows  || {});
    (s.dualAxis||[]).forEach(k => dualAxisKeys.add(k));
    Object.assign(filterState, s.filterState || {});
    if (s.sortState) sortState = s.sortState;
    paintAllShelves();
    paintParams();
    paintDrillBar();
    runQuery();
  } catch(e) {
    localStorage.removeItem('dvs_state');
    runQuery();
  }
}

function runQuery() {
  if (!S.schema.length) return;
  const allF=[...S.shelf.columns,...S.shelf.rows];
  const dims=allF.filter(f=>f.type==='dimension');
  const meas=allF.filter(f=>f.type==='measure');
  const newShelfSig = allF.map(f=>f.field+f.agg).join(',');
  if (newShelfSig !== _lastShelfSig) { sortState = { col: null, dir: 1 }; }
  _lastShelfSig = newShelfSig;
  const filters=S.shelf.filters.map(f=>{
    const fs=filterState[f.field]||{};
    return { field:f.field, type:f.type, selectedValues:fs.selectedValues||[], minVal:fs.minVal||'', maxVal:fs.maxVal||'',
      topN:fs.topN||null, topNBy:fs.topNBy||null, topNDir:fs.topNDir||'top' };
  });
  if (!dims.length&&!meas.length) {
    document.getElementById('empty-state').style.display='flex';
    document.getElementById('chart-container').style.display='none';
    document.getElementById('table-container').style.display='none';
    document.getElementById('table-container').innerHTML='';
    document.getElementById('export-btn').style.display='none';
    if (chart) chart.clear();
    return;
  }
  document.getElementById('empty-state').style.display='none';
  const colDims = S.shelf.columns.filter(f=>f.type==='dimension');
  const rowDims = S.shelf.rows.filter(f=>f.type==='dimension');
  
  _queryActive = true;
  clearTimeout(_queryTimer);
  _queryTimer = setTimeout(() => {
    if (_queryActive) {
      const d = dims.length+meas.length;
      document.getElementById('query-overlay-sub').textContent =
        `${fmtN(S.rowCount)} rows ¬∑ ${d} field${d!==1?'s':''}`;
      document.getElementById('query-overlay').style.display='flex';
    }
  }, 400);
  const _shelfSnapshot = {
    colDims,
    rowDims,
    meas,
    colDiscretes: S.shelf.columns.map(f => f.discrete ?? (f.type==='dimension')),
    rowDiscretes: S.shelf.rows.map(f => f.discrete ?? (f.type==='dimension'))
  };
  saveState();
  const _qid = ++_queryId;
  worker.postMessage({type:'QUERY',payload:{dims,meas,filters,limit: _previewMode ? _previewRowCount : 50000,lodFields:S.lodFields, _shelf:_shelfSnapshot, _qid}});
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VISUALIZATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function render() {
  const {headers,total}=S.result;
  const rows = applyTransforms(S.result.headers, S.result.rows);
  if (!rows||!rows.length) {
    setStatus('No results ‚Äî no rows match all active filters');
    document.getElementById('chart-container').style.display='none';
    document.getElementById('table-container').style.display='none';
    document.getElementById('export-btn').style.display='none';
    document.getElementById('empty-state').style.display='flex';
    document.querySelector('#empty-state h2').textContent='No data matches your filters';
    document.querySelector('#empty-state p').textContent='Try widening your filter range or removing a filter.';
    if (chart) chart.clear();
    return;
  }
  document.getElementById('empty-state').style.display='none';
  document.getElementById('export-btn').style.display='';
  const shown=rows.length<total?` ¬∑ top ${fmtN(rows.length)} groups`:'';
  setStatus(`${S.filename}  ¬∑  ${fmtN(S.rowCount)} rows  ¬∑  ${fmtN(rows.length)} groups${shown}`);
  S.view==='table'?renderTable(headers,rows):renderChart(headers,rows);
}

function renderChart(headers, rows) {
  document.getElementById('table-container').style.display='none';
  document.getElementById('chart-container').style.display='block';
  document.getElementById('refline-btn').style.display='';
  if (!chart) {
    chart = echarts.init(document.getElementById('chart-container'), null, {renderer:'canvas'});
    chart.on('click', _onChartClick);
  }

  // Prune dualAxisKeys ‚Äî remove any keys no longer on shelves
  const _activeMeasKeys = new Set(
    [...S.shelf.columns, ...S.shelf.rows]
      .filter(f => f.type === 'measure')
      .map(f => `${f.agg}(${f.field})`)
  );
  dualAxisKeys.forEach(k => { if (!_activeMeasKeys.has(k)) dualAxisKeys.delete(k); });
  const allF=[...S.shelf.columns,...S.shelf.rows];
  const dims=allF.filter(f=>f.type==='dimension');
  const meas=allF.filter(f=>f.type==='measure');
  const ct=S.chartType;
  const P=['#1B5E42','#C45C00','#0055B3','#7B2D8B','#C0392B','#0288D1','#558B2F','#E65100'];
  const base={
    backgroundColor:'#FAFAF8', animation:true, animationDuration:450, animationEasing:'cubicOut',
    textStyle:{fontFamily:"'DM Sans',sans-serif",color:'#3D3D39'},
    tooltip:{trigger:'axis',backgroundColor:'#FFFFFF',borderColor:'#E8E6E0',borderWidth:1,textStyle:{color:'#1A1A18',fontSize:12},extraCssText:'box-shadow:0 4px 16px rgba(26,26,24,.12);border-radius:6px;'},
    grid:{left:64,right:24,top:36,bottom:72,containLabel:true},
  };
  let option={};
  if (ct==='pie') {
    const dk=dims[0]?.field||headers[0], mk=meas[0]?`${meas[0].agg}(${meas[0].field})`:headers[headers.length-1];
    option={...base,tooltip:{trigger:'item',formatter:'{b}: <b>{c}</b> ({d}%)',backgroundColor:'#fff',borderColor:'#E8E6E0',textStyle:{color:'#1A1A18'},extraCssText:'border-radius:6px;box-shadow:0 4px 16px rgba(26,26,24,.12);'},
      legend:{orient:'vertical',right:12,top:'middle',textStyle:{color:'#8A8A84',fontSize:11}},
      series:[{type:'pie',radius:['32%','68%'],center:['42%','52%'],
      data: (() => {
        const top = rows.slice(0,24).map(r=>({name:String(r[dk]||''),value:+((r[mk]||0)).toFixed(3)}));
        if (rows.length>24) {
          const otherVal = rows.slice(24).reduce((s,r)=>s+(r[mk]||0),0);
          top.push({name:`Other (${rows.length-24})`, value:+otherVal.toFixed(3), itemStyle:{color:'#C8C8C0'}});
        }
        return top;
      })(),
        itemStyle:{borderRadius:5,borderColor:'#FAFAF8',borderWidth:2},label:{fontSize:11,color:'#8A8A84'},
        emphasis:{itemStyle:{shadowBlur:12,shadowColor:'rgba(0,0,0,.12)'}},color:P}]};
  } else if (ct==='scatter') {
    const xk=dims[0]?.field||headers[0], yk=meas[0]?`${meas[0].agg}(${meas[0].field})`:headers[headers.length-1];
    option={...base,xAxis:{type:'category',data:rows.map(r=>String(r[xk]||'')),axisLabel:{color:'#8A8A84',rotate:rows.length>18?35:0,fontSize:10},axisLine:{lineStyle:{color:'#E8E6E0'}},splitLine:{lineStyle:{color:'#F2F0EC'}}},
      yAxis:{type:'value',axisLabel:{color:'#8A8A84',fontSize:10},splitLine:{lineStyle:{color:'#F2F0EC',type:'dashed'}},axisLine:{show:false}},
      series:[{type:'scatter',data:rows.map(r=>[String(r[xk]||''),+((r[yk]||0)).toFixed(3)]),symbolSize:9,itemStyle:{color:'#1B5E42',opacity:.75,borderColor:'#fff',borderWidth:1}}]};
  
  } else if (ct === 'hbar') {
    const mkeys = meas.length ? meas.map(m=>`${m.agg}(${m.field})`) : [headers[headers.length-1]];
    const xd = rows.map(r => dims.length ? dims.map(d=>String(r[d.field]||'')).join(' ‚Ä∫ ') : 'Value');
    const _ml = buildMarkLines(rows);
    option = {...base,
      xAxis:{type:'value',axisLabel:{color:'#8A8A84',fontSize:10},splitLine:{lineStyle:{color:'#F2F0EC',type:'dashed'}},axisLine:{show:false}},
      yAxis:{type:'category',data:xd,axisLabel:{color:'#8A8A84',fontSize:10,width:100,overflow:'truncate'},axisLine:{lineStyle:{color:'#E8E6E0'}},splitLine:{show:false}},
      grid:{left:14,right:24,top:36,bottom:20,containLabel:true},
      series: mkeys.map((mk,i)=>({
        type:'bar', name:mk, data:rows.map(r=>+((r[mk]||0)).toFixed(4)),
        itemStyle:{color:P[i%P.length],borderRadius:[0,3,3,0]}, barMaxWidth:40,
        markLine:_ml[mk]||undefined,
        emphasis:{focus:'series'}
      }))
    };
  } else {
    
    // Combine ALL dims into one label
    const mkeys=meas.length?meas.map(m=>`${m.agg}(${m.field})`):[headers[headers.length-1]];
    if (!dims.length) {
    // Measures-only: show each measure as a bar
    option = { ...base,
      xAxis:{type:'category',data:mkeys,axisLabel:{color:'#8A8A84',fontSize:11}},
      yAxis:{type:'value',axisLabel:{color:'#8A8A84',fontSize:10},splitLine:{lineStyle:{color:'#F2F0EC',type:'dashed'}}},
      series:[{type:'bar',data:mkeys.map((mk,i)=>({value:+(rows[0]?.[mk]||0).toFixed(4),itemStyle:{color:P[i%P.length]}})),barMaxWidth:80}]
    };
    chart.setOption(option,true); return;
  }
  const xd = rows.map(r =>
    dims.length > 1
      ? dims.map(d => String(r[d.field]||'')).join(' ‚Ä∫ ')
      : String(r[dims[0].field]||'')
  );

  // Derive axis type from first column-shelf chip's discrete flag
  const _shelf = S.result._shelf || {};
  const _firstColChip = S.shelf.columns[0];
  const _xDiscrete = _firstColChip
    ? (_firstColChip.discrete ?? (_firstColChip.type === 'dimension' ? true : false))
    : true;
  const xAxisType = _xDiscrete ? 'category' : 'value';
  // For continuous x: use raw numeric values instead of string labels
  const xData = _xDiscrete ? xd : rows.map(r => +(r[dims[0]?.field] || 0));

    // ‚îÄ‚îÄ Dual axis setup ‚îÄ‚îÄ
    const hasDual = mkeys.some(mk => dualAxisKeys.has(mk));
    const yAxisCfg = hasDual ? [
      { type:'value', axisLabel:{color:'#8A8A84',fontSize:10,formatter:v=>v>=1e6?fmtNum(v):fmtN(v)}, splitLine:{lineStyle:{color:'#F2F0EC',type:'dashed'}}, axisLine:{show:false} },
      { type:'value', alignTicks:true, position:'right', axisLabel:{color:'#0055B3',fontSize:10,formatter:v=>v>=1e6?fmtNum(v):fmtN(v)}, splitLine:{show:false}, axisLine:{lineStyle:{color:'#0055B3'}} }
    ] : { type:'value', axisLabel:{color:'#8A8A84',fontSize:10,formatter:v=>v>=1e6?fmtNum(v):fmtN(v)}, splitLine:{lineStyle:{color:'#F2F0EC',type:'dashed'}}, axisLine:{show:false} };

    option={...base,
      legend:{top:6,textStyle:{color:'#8A8A84',fontSize:11,fontFamily:"'DM Sans',sans-serif"}},
      xAxis:{type:'category',data:xd,axisLabel:{color:'#8A8A84',rotate:xd.length>22?35:0,fontSize:10,interval:xd.length>50?'auto':0},axisLine:{lineStyle:{color:'#E8E6E0'}},splitLine:{show:false}},
      yAxis: yAxisCfg,
      grid:{left:64, right: hasDual?64:24, top:36, bottom:72, containLabel:true},
      series:(()=>{
        const _ml = buildMarkLines(rows);
        return mkeys.map((mk,i)=>{
          const isDual = dualAxisKeys.has(mk);
          // dual axis measures always render as line for visual contrast
          const seriesType = isDual ? 'line' : (ct==='bar'?'bar':'line');
          const yVals = rows.map(r=>+((r[mk]||0)).toFixed(4));
        const baseSeries = {
            name:mk, type:seriesType,
            yAxisIndex: hasDual && isDual ? 1 : 0,
            data: yVals,
            stack: ct==='stacked' && seriesType==='bar' ? 'total' : undefined,
            smooth: seriesType !== 'bar',
            areaStyle:ct==='area'&&!isDual?{opacity:.12,color:{type:'linear',x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:P[i%P.length]},{offset:1,color:'transparent'}]}}:undefined,
            itemStyle:{color:P[i%P.length],borderRadius:ct==='stacked'?0:seriesType==='bar'?[3,3,0,0]:0},
            lineStyle:seriesType!=='bar'?{width:2.5,color:P[i%P.length]}:undefined,
            showSymbol:seriesType!=='bar'&&rows.length<60,symbolSize:5,barMaxWidth:56,
            markLine:_ml[mk]||undefined,
            emphasis:{focus:'series',itemStyle:{shadowBlur:8,shadowColor:'rgba(26,26,24,.15)'}}
          };
          const out = [baseSeries];
          if (S.trendLine && ct !== 'pie' && ct !== 'stacked') {
            const n = yVals.length;
            const mx = (n-1)/2;
            const my = yVals.reduce((a,b)=>a+b,0)/n;
            let num=0,den=0;
            for(let j=0;j<n;j++){num+=(j-mx)*(yVals[j]-my);den+=(j-mx)*(j-mx);}
            const slope=den?num/den:0, intercept=my-slope*mx;
            const trendData = yVals.map((_,j)=>+(slope*j+intercept).toFixed(4));
            out.push({
              name: mk+' Trend', type:'line', data:trendData,
              smooth:false, symbol:'none', yAxisIndex: hasDual&&isDual?1:0,
              lineStyle:{width:1.5,type:'dashed',color:P[i%P.length],opacity:.7},
              itemStyle:{color:P[i%P.length]}, tooltip:{show:false},
              emphasis:{disabled:true}
            });
          }
          return out;
        }).flat();
      })()};
  }
  chart.setOption(option,true);
}

let sortState = { col: null, dir: 1 };
let _lastShelfSig = '';
const colTransforms = {}; // key: `AGG(field)` ‚Üí 'pct' | 'running' | null
const colMaWindow   = {}; // key: `AGG(field)` ‚Üí window size (integer, default 3)
const dualAxisKeys  = new Set(); // measKeys on right Y axis

function renderTable(rawHeaders, rows) {
  const expandedPlainKeys = new Set(
    rawHeaders.filter(h => h.includes('__'))
              .map(h => h.replace(/__[\d.]+$/, ''))
  );
  const headers = rawHeaders.filter(h => !expandedPlainKeys.has(h) || h.includes('__'));
  document.getElementById('chart-container').style.display='none';
  const tc = document.getElementById('table-container');
  tc.style.display = 'block';

  const shelf = S.result._shelf || {};
  const colDims = shelf.colDims || [];
  const rowDims = shelf.rowDims || [];
  const meas    = shelf.meas    || [];

  // ‚îÄ‚îÄ PIVOT MODE: dims in both Columns AND Rows shelf ‚îÄ‚îÄ
  if (colDims.length > 0 && rowDims.length > 0) {
    renderPivot(tc, rows, colDims, rowDims, meas);
    return;
  }

  // ‚îÄ‚îÄ FLAT TABLE (original behaviour) ‚îÄ‚îÄ 
  let sorted = [...rows];
  if (sortState.col) {
    sorted.sort((a,b) => {
      const av=a[sortState.col], bv=b[sortState.col];
      const cmp = typeof av==='number' ? av-bv : String(av||'').localeCompare(String(bv||''));
      return cmp * sortState.dir;
    });
  }
  // ‚îÄ‚îÄ pre-compute helpers ‚îÄ‚îÄ
  const measHdrs = headers.filter(h => h.includes('('));
  const dimHdrs  = headers.filter(h => !h.includes('('));
  const firstDim = dimHdrs[0] || null;

  function cellVal(row, h) {
    const v = row[h], n = typeof v === 'number';
    const tx = colTransforms[h];
    if (v === null || v === undefined) return {html:'<span style="color:var(--faint)">‚Äî</span>', raw:null};
    if (n) {
      const fmt =
        (tx==='pct'||tx==='pct_row') ? v.toFixed(2)+'%' :
        tx==='rank' ? '#'+v :
        tx==='diff' ? (v>0?'+':'')+fmtNum(v) :
        tx==='pct_diff' ? (v>0?'+':'')+v.toFixed(2)+'%' :
        applyNumFormat(v,h);
      return {html:`<td class="num">${fmt}</td>`, raw:v};
    }
    return {html:`<td>${esc(String(v??''))}</td>`, raw:null};
  }

  function rowTotal(row) {
    return measHdrs.reduce((s,h) => {
      const v = row[h]; return s + (typeof v==='number' ? v : 0);
    }, 0);
  }

  function grandTotals(rows) {
    // SUM for most, but respect transforms
    const out = {};
    measHdrs.forEach(h => {
      const vals = rows.map(r => r[h]).filter(v => typeof v==='number');
      const tx = colTransforms[h];
      if (tx==='rank') { out[h] = null; return; }
      if (tx==='pct'||tx==='pct_row') { out[h] = 100; return; }
      out[h] = vals.reduce((s,v) => s+v, 0);
    });
    return out;
  }

  function renderRow(row, extraCls='') {
    const gtCol = S.totals.grandCol ? fmtNum(rowTotal(row)) : null;
    return `<tr class="${extraCls}">${dimHdrs.length === 0 && S.totals.grandRow ? '<td></td>' : ''}${headers.map(h => {
      const v = row[h], n = typeof v==='number';
      const tx = colTransforms[h];
      if (v === null) return `<td class="num"><span style="color:var(--faint)">‚Äî</span></td>`;
      if (n) {
        const fmt =
          (tx==='pct'||tx==='pct_row') ? v.toFixed(2)+'%' :
          tx==='rank' ? '#'+v :
          tx==='diff' ? (v>0?'+':'')+fmtNum(v) :
          tx==='pct_diff' ? (v>0?'+':'')+v.toFixed(2)+'%' :
          applyNumFormat(v,h);
        return `<td class="num">${fmt}</td>`;
      }
      return `<td>${esc(String(v??''))}</td>`;
    }).join('')}${gtCol !== null ? `<td class="num" style="font-weight:700;background:var(--forest-lt);color:var(--forest);border-bottom:1px solid var(--forest-mid);border-left:2px solid var(--forest-mid);">${gtCol}</td>` : ''}</tr>`;
  }

  function renderTotalRow(label, rows, cls='grand-total-row') {
    const gt = grandTotals(rows);
    const rowTot = S.totals.grandCol ? fmtNum(measHdrs.reduce((s,h) => s + (typeof gt[h]==='number'?gt[h]:0), 0)) : null;
    return `<tr class="${cls}" style="font-weight:700;background:var(--forest-lt);border-top:2px solid var(--forest-mid);">
      <td style="color:var(--forest);">${label}</td>
      ${dimHdrs.slice(1).map(()=>'<td></td>').join('')}

      ${measHdrs.map(h => {
        const v = gt[h];
        if (v === null) return `<td class="num"><span style="color:var(--faint)">‚Äî</span></td>`;
        const tx = colTransforms[h];
        const fmt = (tx==='pct'||tx==='pct_row') ? v.toFixed(2)+'%' : fmtNum(v);
        return `<td class="num">${fmt}</td>`;
      }).join('')}
      ${rowTot !== null ? `<td class="num" style="font-weight:700;">${rowTot}</td>` : ''}
    </tr>`;
  }

  // ‚îÄ‚îÄ build body rows with optional subtotals ‚îÄ‚îÄ
  let bodyRows = '';
  const capped = sorted.slice(0, 10000);
  // NOTE: totals always computed from full sorted array, not the capped display slice
  const rowsForTotals = sorted;

  if (S.totals.subtotals && firstDim && dimHdrs.length >= 1) {
    let lastGroup = null, groupRows = [];
    capped.forEach((row, ri) => {
      const g = String(row[firstDim] || '');
      if (lastGroup !== null && g !== lastGroup) {
        bodyRows += renderTotalRow(lastGroup + ' Total', groupRows, 'subtotal-row');
        groupRows = [];
      }
      bodyRows += renderRow(row);
      groupRows.push(row);
      lastGroup = g;
    });
    // last group
    if (groupRows.length) bodyRows += renderTotalRow(lastGroup + ' Total', groupRows, 'subtotal-row');
  } else {
    bodyRows = capped.map(row => renderRow(row)).join('');
  }

  const grandTotalRow = S.totals.grandRow ? renderTotalRow('Grand Total', rowsForTotals) : '';

  const gtColHeader = S.totals.grandCol ? `<th class="num-h" style="text-align:right;color:var(--forest);font-weight:700;font-size:12px;text-transform:none;letter-spacing:0;background:var(--forest-lt);border-bottom:2px solid var(--forest-mid);border-left:2px solid var(--forest-mid);">Grand Total</th>` : '';

  tc.innerHTML = `<table>
    <thead><tr>${dimHdrs.length === 0 && S.totals.grandRow ? '<th></th>' : ''}${headers.map(h => {
      const isSorted = sortState.col===h;
      const arrow = isSorted ? (sortState.dir===1?' ‚Üë':' ‚Üì') : '';
      const tx = colTransforms[h];
      const txNames2 = {'pct':'% Total','pct_row':'% Row','running':'Running Sum','rank':'Rank','diff':'Difference','pct_diff':'% Difference','ma':'MA'+(colMaWindow[h]||3)};
      const cleanH = h.replace(/__[\d.]+$/, '');
      const displayH = tx && tx!=='none' ? txNames2[tx]+' ('+esc(cleanH)+')' : esc(cleanH);
      const isNum = h.includes('(');
      return `<th class="${isNum?'num-h':''}" style="cursor:pointer;user-select:none;${isNum?'text-align:right;':''}" onclick="sortTable('${esc(h)}')">${displayH}${arrow}</th>`;
    }).join('')}${gtColHeader}</tr></thead>
    <tbody>${bodyRows}${grandTotalRow}</tbody>
  </table>
  <div style="padding:8px 14px;font-size:11px;color:var(--muted);background:var(--white);border-top:1px solid var(--rule);position:sticky;bottom:0;">
    Showing ${fmtN(Math.min(sorted.length,10000))} of ${fmtN(sorted.length)} groups
    ${sorted.length>10000?' ‚Äî <span style="color:var(--rose)">table capped at 10K rows</span>':''}
  </div>`;
}

function renderPivot(tc, rows, colDims, rowDims, meas) {
  // Unique col dim values (combined key if multiple col dims)
  const colKey = r => colDims.map(d=>String(r[d.field]||'')).join(' ‚Ä∫ ');
  const rowKey = r => rowDims.map(d=>String(r[d.field]||'')).join('\x00');

  const colVals = [...new Set(rows.map(colKey))].sort();
  const measKeys = meas.length ? meas.map(m=>`${m.agg}(${m.field})`) : [];

  // Build lookup: rowKey+colKey ‚Üí row data
  const lookup = new Map();
  rows.forEach(r => {
    const rk = rowKey(r), ck = colKey(r);
    if (!lookup.has(rk)) lookup.set(rk, {});
    lookup.get(rk)[ck] = r;
  });

  // Unique row combinations in order
  const rowKeys = [...new Set(rows.map(rowKey))];

  // Header ‚Äî row dim labels + one col per unique col value (√ó measures)
  const rowDimHeaders = rowDims.map(d=>`<th style="cursor:default;background:var(--cream);border-right:2px solid var(--rule);">${esc(d.field)}</th>`).join('');

  let colHeaders1 = `<tr>${rowDims.map(()=>`<th style="background:var(--cream);border-right:2px solid var(--rule);"></th>`).join('')}`;
  colVals.forEach(cv => {
    const span = measKeys.length||1;
    colHeaders1 += `<th colspan="${span}" style="text-align:center;background:var(--forest-lt);color:var(--forest);border-right:2px solid var(--rule);border-bottom:1px solid var(--forest-mid);font-weight:700;">${esc(cv)}</th>`;
  });
  colHeaders1 += '</tr>';

  // Second header row for measures (only if measures exist)
  let colHeaders2 = '';
  if (measKeys.length > 1) {
    colHeaders2 = `<tr>${rowDims.map(()=>`<th style="background:var(--cream);border-right:2px solid var(--rule);"></th>`).join('')}`;
    colVals.forEach(() => {
      measKeys.forEach((mk, mi) => {
        const isLastMeasure = mi === measKeys.length - 1;
        colHeaders2 += `<th style="background:var(--white);color:var(--amber);font-size:10px;text-align:center;border-right:${isLastMeasure?'2px solid var(--rule)':'1px solid var(--rule)'};">${esc(mk)}</th>`;
      });
      // colHeaders2 = colHeaders2.replace(/<\/th>$/, ' style="border-right:2px solid var(--rule)">');
      // no post-hoc string patching needed ‚Äî border handled per-cell below 
    });
    colHeaders2 += '</tr>';
  }

  // Body rows
  let tbody = '';
  rowKeys.forEach((rk, ri) => {
    const rowData = lookup.get(rk) || {};
    // Get display values for row dims from first matching row
    const firstRow = rows.find(r=>rowKey(r)===rk);
    const rowDimCells = rowDims.map(d=>`<td style="font-weight:500;background:var(--cream);border-right:2px solid var(--rule);white-space:nowrap;">${esc(String(firstRow?.[d.field]||''))}</td>`).join('');

    let cells = '';
    colVals.forEach((cv, ci) => {
      const cellRow = rowData[cv];
      const isLastCol = ci === colVals.length-1;
      if (measKeys.length) {
        measKeys.forEach((mk, mi) => {
          const v = cellRow?.[mk];
          const isNum = typeof v==='number';
          const isLastMea = mi === measKeys.length-1;
          cells += `<td class="${isNum?'num':''}" style="${isLastMea&&!isLastCol?'border-right:2px solid var(--rule);':''}">${v!==undefined?(isNum?applyNumFormat(v,mk):esc(String(v))):'<span style="color:var(--faint)">‚Äî</span>'}</td>`;
        });
      } else {
        const v = cellRow ? fmtN(1) : '<span style="color:var(--faint)">‚Äî</span>';
        cells += `<td style="text-align:center;font-family:var(--mono);${!isLastCol?'border-right:2px solid var(--rule);':''}">${v}</td>`;
      }
    });
    tbody += `<tr style="background:${ri%2===0?'#fff':'#FAFAF8'}">${rowDimCells}${cells}</tr>`;
  });

  tc.innerHTML = `<table style="border-collapse:collapse;font-size:12px;width:100%;">
    <thead>${colHeaders1}${colHeaders2}
      <tr>${rowDimHeaders}${colVals.map((cv,ci)=>{
        const isLast=ci===colVals.length-1;
        if (!measKeys.length) return `<th style="text-align:center;cursor:default;${!isLast?'border-right:2px solid var(--rule);':''}">${esc(cv)}</th>`;
        return measKeys.map((mk,mi)=>`<th style="text-align:right;cursor:default;font-size:10px;color:var(--muted);${mi===measKeys.length-1&&!isLast?'border-right:2px solid var(--rule);':''}">${esc(mk)}</th>`).join('');
      }).join('')}</tr>
    </thead>
    <tbody>${tbody}</tbody>
  </table>
  <div style="padding:8px 14px;font-size:11px;color:var(--muted);background:var(--white);border-top:1px solid var(--rule);position:sticky;bottom:0;">
    Pivot: ${fmtN(rowKeys.length)} rows √ó ${fmtN(colVals.length)} columns
    ${colVals.length>100?' ‚Äî <span style="color:var(--rose)">large pivot, consider filtering</span>':''}
  </div>`;
}

function sortTable(col) {
  if (sortState.col === col) {
    if (sortState.dir === 1) sortState.dir = -1;
    else { sortState.col = null; sortState.dir = 1; }
  } else {
    sortState.col = col; sortState.dir = 1;
  }
  if (S.result) {
    const rows = applyTransforms(S.result.headers, S.result.rows);
    renderTable(S.result.headers, rows);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONTROLS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

function setChart(ct) {
  S.chartType = ct;
  document.querySelectorAll('.sm-tile').forEach(t => t.classList.toggle('active', t.dataset.ct === ct));
  if(S.result) render();
}
/* ‚îÄ‚îÄ TOTALS ‚îÄ‚îÄ */
function toggleAnalysisMenu() {
  const m = document.getElementById('analysis-menu');
  m.style.display = m.style.display === 'none' ? 'block' : 'none';
  _updateTcBadge();
}
function closeAnalysisMenu() {
  document.getElementById('analysis-menu').style.display = 'none';
}
function _updateTcBadge() {
  const active = Object.values(colTransforms).filter(v => v && v !== 'none').length;
  const badge = document.getElementById('anl-tc-badge');
  if (!badge) return;
  if (active > 0) { badge.textContent = active + ' active'; badge.style.display = ''; }
  else badge.style.display = 'none';
}
document.addEventListener('click', e => {
  const wrap = document.getElementById('analysis-wrap');
  if (wrap && !wrap.contains(e.target)) closeAnalysisMenu();
});

function toggleTotal(key) {
  S.totals[key] = !S.totals[key];
  const chk = document.getElementById('tot-chk-' + key);
  if (chk) chk.textContent = S.totals[key] ? '‚òë' : '‚òê';
  if (S.result) render();
}

function setView(v) {
  S.view = v;
  document.querySelectorAll('.sm-tile').forEach(t => {
    if (v === 'table') t.classList.toggle('active', t.dataset.ct === 'table');
    else t.classList.toggle('active', t.dataset.ct === S.chartType);
  });
  if (S.result) render();
  document.getElementById('refline-btn').style.display = 'none'; // moved to Show Me
  if (v !== 'chart') document.getElementById('refline-panel').classList.remove('show');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PARAMETERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _paramIdCounter = 0;

function toggleParamPanel() {
  const list = document.getElementById('param-list');
  list.style.display = list.style.display === 'none' ? '' : 'none';
}

function openParamModal() {
  document.getElementById('pm-name').value = '';
  document.getElementById('pm-val').value  = '10';
  document.getElementById('pm-min').value  = '1';
  document.getElementById('pm-max').value  = '100';
  document.getElementById('pm-step').value = '1';
  document.getElementById('pm-type').value = 'integer';
  document.getElementById('pm-list-vals').value = '';
  document.getElementById('pm-list-cur').value  = '';
  onParamTypeChange();
  document.getElementById('param-modal').classList.add('show');
  setTimeout(() => document.getElementById('pm-name').focus(), 80);
}

function closeParamModal() {
  document.getElementById('param-modal').classList.remove('show');
}

function onParamTypeChange() {
  const t = document.getElementById('pm-type').value;
  document.getElementById('pm-range-fields').style.display = t === 'list' ? 'none' : '';
  document.getElementById('pm-list-fields').style.display  = t === 'list' ? '' : 'none';
}

function saveParam() {
  const name = document.getElementById('pm-name').value.trim();
  if (!name) { document.getElementById('pm-name').focus(); return; }
  const type = document.getElementById('pm-type').value;
  let p;
  if (type === 'list') {
    const vals = document.getElementById('pm-list-vals').value.split(',').map(v=>v.trim()).filter(Boolean);
    const cur  = document.getElementById('pm-list-cur').value.trim() || vals[0] || '';
    p = { id:++_paramIdCounter, name, type:'list', currentVal:cur, allowedValues:vals };
  } else {
    const cur  = parseFloat(document.getElementById('pm-val').value)  || 10;
    const min  = parseFloat(document.getElementById('pm-min').value)  || 1;
    const max  = parseFloat(document.getElementById('pm-max').value)  || 100;
    const step = parseFloat(document.getElementById('pm-step').value) || 1;
    const val  = Math.min(max, Math.max(min, cur));
    p = { id:++_paramIdCounter, name, type, currentVal:val, min, max, step, allowedValues:[] };
  }
  S.params.push(p);
  closeParamModal();
  paintParams();
}

function removeParam(id) {
  S.params = S.params.filter(p => p.id !== id);
  paintParams();
  if (S.result) render();
}

function setParamVal(id, val) {
  const p = S.params.find(x => x.id === id); if (!p) return;
  p.currentVal = p.type === 'integer' ? parseInt(val) : p.type === 'float' ? parseFloat(val) : val;
  // Refresh any TopN filter that references this param
  Object.keys(filterState).forEach(field => {
    const fs = filterState[field];
    if (fs && fs.topNParamId === id) {
      fs.topN = p.currentVal;
      paintShelf('filters');
    }
  });
  // Refresh MA window that references this param
  Object.keys(colMaWindow).forEach(key => {
    if (colMaWindow[key + '__paramId'] === id) {
      colMaWindow[key] = p.currentVal;
      paintAllShelves();
    }
  });
  paintParams();
  if (S.result) render();
}

function getParamVal(nameOrId) {
  // Utility: get current value by name ‚Äî use in TopN/MA bindings
  const p = S.params.find(x => x.name === nameOrId || x.id === nameOrId);
  return p ? p.currentVal : null;
}

function paintParams() {
  const list = document.getElementById('param-list');
  const count = document.getElementById('param-count');
  count.textContent = S.params.length ? '(' + S.params.length + ')' : '';
  if (!S.params.length) {
    list.innerHTML = '<div style="font-size:11px;color:var(--faint);font-style:italic;padding:4px 2px;">No parameters yet</div>';
    return;
  }
  list.innerHTML = S.params.map(p => {
    const ctrl = p.type === 'list'
      ? `<select class="param-val-input" onchange="setParamVal(${p.id},this.value)" style="flex:1;">
           ${p.allowedValues.map(v => `<option ${v===p.currentVal?'selected':''}>${esc(v)}</option>`).join('')}
         </select>`
      : `<input type="range" class="param-slider"
           min="${p.min}" max="${p.max}" step="${p.step}"
           value="${p.currentVal}"
           oninput="setParamVal(${p.id},this.value);this.nextElementSibling.textContent=this.value">
         <span class="param-val-display">${p.currentVal}</span>`;
    return `<div class="param-item">
      <div class="param-item-head">
        <span class="param-name" title="${esc(p.name)}">${esc(p.name)}</span>
        <span class="param-type-tag">${p.type}</span>
        <button class="param-rm" onclick="removeParam(${p.id})">‚úï</button>
      </div>
      <div class="param-ctrl">${ctrl}</div>
    </div>`;
  }).join('');
}

// Show param-list on first param added
function ensureParamPanelOpen() {
  const list = document.getElementById('param-list');
  if (list.style.display === 'none') list.style.display = '';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOD EXPRESSIONS (FIXED)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openLodModal() {
  const dims = S.schema.filter(s => s.type === 'dimension' && !s.hidden);
  const meas = S.schema.filter(s => s.type === 'measure'   && !s.hidden);
  if (!dims.length || !meas.length) {
    setStatus('‚ö† Load data first'); return;
  }
  const dimOpts = dims.map(d => `<option value="${esc(d.name)}">${esc(d.name)}</option>`).join('');
  const meaOpts = meas.map(m => `<option value="${esc(m.name)}">${esc(m.name)}</option>`).join('');

  // Reuse param-modal pattern ‚Äî inject into a dedicated modal
  const modal = document.getElementById('lod-modal');
  document.getElementById('lod-dim-select').innerHTML  = dimOpts;
  document.getElementById('lod-mea-select').innerHTML  = meaOpts;
  document.getElementById('lod-name-input').value = '';
  modal.classList.add('show');
  setTimeout(() => document.getElementById('lod-name-input').focus(), 80);
}

function closeLodModal() {
  document.getElementById('lod-modal').classList.remove('show');
}

function saveLod() {
  const name = document.getElementById('lod-name-input').value.trim();
  if (!name) { document.getElementById('lod-name-input').focus(); return; }
  if (S.lodFields.find(l => l.name === name)) {
    setStatus('LOD field "' + name + '" already exists'); return;
  }
  // Collect selected dims (multi-select)
  const dimSel  = document.getElementById('lod-dim-select');
  const fixedDims = Array.from(dimSel.selectedOptions).map(o => o.value);
  if (!fixedDims.length) { setStatus('‚ö† Select at least one dimension'); return; }
  const measField = document.getElementById('lod-mea-select').value;
  const agg       = document.getElementById('lod-agg-select').value;

  S.lodFields.push({ name, fixedDims, measField, agg });
  // Add to schema as a virtual measure so it shows in sidebar
  S.schema.push({ name, type:'measure', _lod:true, _virtual:true, defaultAgg:'SUM' });
  buildSidebar();
  closeLodModal();
  runQuery();
  setStatus('LOD field "' + name + '" created ‚Äî drag to shelf');
}

function removeLod(name) {
  S.lodFields = S.lodFields.filter(l => l.name !== name);
  S.schema = S.schema.filter(s => s.name !== name);
  // Remove from shelves
  ['columns','rows','filters'].forEach(sh => {
    S.shelf[sh] = S.shelf[sh].filter(f => f.field !== name);
  });
  buildSidebar();
  paintAllShelves();
  runQuery();
}

function paintLodList() {
  const el = document.getElementById('lod-list');
  if (!el) return;
  if (!S.lodFields.length) {
    el.innerHTML = '<div style="font-size:11px;color:var(--faint);font-style:italic;padding:4px 2px;">No LOD fields yet</div>';
    return;
  }
  el.innerHTML = S.lodFields.map(l => `
    <div style="background:var(--amber-lt);border:1.5px solid var(--amber-mid);border-radius:5px;padding:5px 9px;display:flex;align-items:center;gap:6px;font-size:11px;">
      <span style="font-family:var(--mono);font-size:9px;background:var(--amber-mid);border-radius:3px;padding:1px 5px;color:var(--amber);font-weight:700;">FIXED</span>
      <span style="flex:1;font-weight:600;color:var(--ink2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(l.name)}">${esc(l.name)}</span>
      <span style="color:var(--muted);font-size:10px;">${esc(l.agg)}(${esc(l.measField)}) by ${esc(l.fixedDims.join(', '))}</span>
      <button onclick="removeLod('${esc(l.name)}')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px;padding:0;transition:color .1s;" onmouseover="this.style.color='var(--rose)'" onmouseout="this.style.color='var(--muted)'">‚úï</button>
    </div>`).join('');
}

function clearAll() {
  if (S.schema.length && !window.confirm('Clear all shelves and transforms?')) return;
  // Cancel any in-flight query first ‚Äî must happen before anything else
  _queryActive = false;
  clearTimeout(_queryTimer);
  _queryTimer = null;
  document.getElementById('query-overlay').style.display = 'none';

  S.shelf = { columns:[], rows:[], filters:[] };
  S.result = null;
  S.skipped = [];
  S.lodFields = [];
  S.drillStack = [];
  S.hierarchies = {};
  S.params = [];
  Object.keys(filterState).forEach(k => delete filterState[k]);
  Object.keys(colTransforms).forEach(k => delete colTransforms[k]);
  Object.keys(colMaWindow).forEach(k => delete colMaWindow[k]);
  dualAxisKeys.clear();

  paintAllShelves();
  closePopover();
  paintDrillBar();
  paintParams();

  document.getElementById('empty-state').style.display = 'flex';
  document.getElementById('chart-container').style.display = 'none';
  document.getElementById('table-container').style.display = 'none';
  document.getElementById('export-btn').style.display = 'none';
  // document.getElementById('analysis-btn').style.display = 'none';
  // analysis-btn stays visible while data is loaded; hides only on new file load
  document.getElementById('query-overlay').style.display = 'none';

  if (chart) {
    chart.off('click', _onChartClick);
    chart.clear();
    chart = null;
  }
  localStorage.removeItem('dvs_state');
}

function showPreview() {
  const fields = S.schema.filter(s => !s._virtual).map(s => s.name);
  worker.postMessage({ type: 'GET_ROWS', payload: { limit: _previewRowCount, fields } });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ANALYSIS ‚Äî STATISTICAL SUMMARY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showStatSummary() {
  if (!S.result || !S.result.rows.length) { setStatus('‚ö† No data ‚Äî run a query first'); return; }
  const rows = applyTransforms(S.result.headers, S.result.rows);
  const measHeaders = S.result.headers.filter(h => h.includes('('));
  if (!measHeaders.length) { setStatus('‚ö† Add a measure to shelves first'); return; }

  function _stats(vals) {
    const v = vals.filter(x => x !== null && !isNaN(x));
    if (!v.length) return { min:'‚Äî',max:'‚Äî',mean:'‚Äî',median:'‚Äî',stddev:'‚Äî',variance:'‚Äî',nulls: vals.length };
    const n = v.length, sum = v.reduce((a,b)=>a+b,0), mean = sum/n;
    const sorted = [...v].sort((a,b)=>a-b);
    const median = n%2 ? sorted[Math.floor(n/2)] : (sorted[n/2-1]+sorted[n/2])/2;
    const variance = v.reduce((a,b)=>a+Math.pow(b-mean,2),0)/n;
    const fmt = x => Math.abs(x) >= 1000 ? x.toLocaleString(undefined,{maximumFractionDigits:2}) : (+x.toFixed(4)).toString();
    return { min:fmt(sorted[0]), max:fmt(sorted[n-1]), mean:fmt(mean), median:fmt(median),
      stddev:fmt(Math.sqrt(variance)), variance:fmt(variance), nulls: vals.length - n };
  }

  let cards = '';
  measHeaders.forEach(h => {
    const vals = rows.map(r => { const v = r[h]; return (v===null||v===undefined||v==='') ? null : +v; });
    const s = _stats(vals);
    cards += `<div class="stat-card">
      <div class="stat-card-field" title="${esc(h)}">${esc(h)}</div>
      ${[['Min',s.min],['Max',s.max],['Mean',s.mean],['Median',s.median],['Std Dev',s.stddev],['Variance',s.variance],['Nulls',s.nulls]]
        .map(([l,v])=>`<div class="stat-row"><span class="stat-lbl">${l}</span><span class="stat-val">${v}</span></div>`).join('')}
    </div>`;
  });

  document.getElementById('stat-modal-body').innerHTML = `<div class="stat-grid">${cards}</div>`;
  document.getElementById('stat-modal-sub').textContent = `${measHeaders.length} measure${measHeaders.length!==1?'s':''} ¬∑ ${rows.length} rows`;
  document.getElementById('stat-modal').style.display = 'flex';
}
function closeStatModal() { document.getElementById('stat-modal').style.display = 'none'; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ANALYSIS ‚Äî CORRELATION MATRIX
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showCorrMatrix() {
  if (!S.result || !S.result.rows.length) { setStatus('‚ö† No data ‚Äî run a query first'); return; }
  const rows = applyTransforms(S.result.headers, S.result.rows);
  const measHeaders = S.result.headers.filter(h => h.includes('('));
  if (measHeaders.length < 2) { setStatus('‚ö† Need at least 2 measures for correlation'); return; }

  function _pearson(ax, ay) {
    const n = ax.length;
    const mx = ax.reduce((a,b)=>a+b,0)/n, my = ay.reduce((a,b)=>a+b,0)/n;
    let num=0, dx2=0, dy2=0;
    for (let i=0;i<n;i++) { const dx=ax[i]-mx, dy=ay[i]-my; num+=dx*dy; dx2+=dx*dx; dy2+=dy*dy; }
    return (dx2&&dy2) ? num/Math.sqrt(dx2*dy2) : 0;
  }

  function _corrColor(r) {
    const abs = Math.abs(r);
    if (r > 0) return `rgba(27,94,66,${0.15 + abs*0.7})`;
    return `rgba(181,41,58,${0.15 + abs*0.7})`;
  }

  const vectors = measHeaders.map(h => rows.map(r => +r[h]||0));
  const short = h => h.length > 14 ? h.slice(0,13)+'‚Ä¶' : h;

  let tbl = `<table class="corr-tbl"><thead><tr><th></th>`;
  measHeaders.forEach(h => { tbl += `<th title="${esc(h)}">${esc(short(h))}</th>`; });
  tbl += '</tr></thead><tbody>';
  measHeaders.forEach((rh, ri) => {
    tbl += `<tr><th style="text-align:left;">${esc(short(rh))}</th>`;
    measHeaders.forEach((ch, ci) => {
      if (ri === ci) { tbl += `<td style="background:var(--shelf-bg);color:var(--muted);">1.00</td>`; return; }
      const r = _pearson(vectors[ri], vectors[ci]);
      const color = _corrColor(r);
      tbl += `<td style="background:${color};color:var(--ink);" title="${rh} vs ${ch}: ${r.toFixed(4)}">${r.toFixed(2)}</td>`;
    });
    tbl += '</tr>';
  });
  tbl += '</tbody></table>';

  document.getElementById('corr-modal-body').innerHTML = tbl +
    `<div style="margin-top:12px;font-size:11px;color:var(--muted);">Pearson r: <span style="color:var(--forest);font-weight:600;">‚ñ† green = positive</span> &nbsp; <span style="color:var(--rose);font-weight:600;">‚ñ† red = negative</span> &nbsp; intensity = strength</div>`;
  document.getElementById('corr-modal-sub').textContent = `${measHeaders.length} measures ¬∑ ${rows.length} rows`;
  document.getElementById('corr-modal').style.display = 'flex';
}
function closeCorrModal() { document.getElementById('corr-modal').style.display = 'none'; }


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SHOW ME
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleShowMe() {
  const p = document.getElementById('show-me-panel');
  const btn = document.getElementById('show-me-btn');
  const isOpen = p.classList.contains('open');
  p.classList.toggle('open', !isOpen);
  btn.classList.toggle('active', !isOpen);
  if (!isOpen) _syncShowMeTiles();
}
function closeShowMe() {
  document.getElementById('show-me-panel').classList.remove('open');
  document.getElementById('show-me-btn').classList.remove('active');
}
function _syncShowMeTiles() {
  const active = S.view === 'table' ? 'table' : S.chartType;
  document.querySelectorAll('.sm-tile').forEach(t => t.classList.toggle('active', t.dataset.ct === active));
  // sync trend toggle
  const trendEl = document.getElementById('sm-trend-toggle');
  if (trendEl) trendEl.checked = S.trendLine;
  // sync rl button
  const rlBtn = document.getElementById('sm-rl-btn');
  if (rlBtn) rlBtn.classList.toggle('has-lines', S.refLines.length > 0);
}
function showMeSelect(ct) {
  if (ct === 'table') {
    setView('table');
  } else {
    setView('chart');
    setChart(ct);
  }
  _syncShowMeTiles();
}
function smToggleTrend(val) {
  S.trendLine = val;
  if (S.result && S.view === 'chart') render();
}
function smOpenRefLines() {
  closeShowMe();
  setView('chart');
  setTimeout(() => { document.getElementById('refline-btn').style.display=''; toggleRefLinePanel(); }, 50);
}
function chooseForMe() {
  const allF = [...S.shelf.columns, ...S.shelf.rows];
  const dims = allF.filter(f=>f.type==='dimension');
  const meas = allF.filter(f=>f.type==='measure');
  const hasDate = dims.some(d => { const s=S.schema.find(x=>x.name===d.field); return s&&(s.dataType==='date'||s.dataType==='datepart'); });
  let ct;
  if (!meas.length) ct = 'table';
  else if (meas.length >= 2 && dims.length === 0) ct = 'scatter';
  else if (hasDate) ct = 'line';
  else if (dims.length >= 2 && meas.length >= 1) ct = 'stacked';
  else if (dims.length === 1 && meas.length === 1) ct = 'bar';
  else ct = 'bar';
  showMeSelect(ct);
}
document.addEventListener('click', e => {
  const panel = document.getElementById('show-me-panel');
  const btn = document.getElementById('show-me-btn');
  if (panel && btn && !panel.contains(e.target) && !btn.contains(e.target)) closeShowMe();
});

function exportCSV() {
  if (!S.result||!S.result.rows.length) return;
  const {headers}=S.result;
  const rows = applyTransforms(S.result.headers, S.result.rows);
  const CSV_INJECT_RE = /^[=+\-@\t\r]/;
  const lines=[headers.map(h=>`"${h}"`).join(',')];
  rows.forEach(r=>lines.push(headers.map(h=>{
    const v=r[h]??'';
    if (typeof v==='number') return v;
    const s = String(v);
    // Neutralise CSV injection: prefix dangerous leading chars with a tab
    const safe = CSV_INJECT_RE.test(s) ? '\t'+s : s;
    return `"${safe.replace(/"/g,'""')}"`;
  }).join(',')));
  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`${S.filename.replace(/\.[^.]+$/,'')}_result.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

let _pendingDrop = null;

function closeCardModal() {
  document.getElementById('cardinality-modal').style.display='none';
}

function showCardinalityWarning(field, type, shelf, uniqueCount) {
  const isColShelf = shelf === 'columns';
  document.getElementById('card-subtitle').textContent = `"${field}" has ${fmtN(uniqueCount)} unique values`;
  document.getElementById('card-body').innerHTML =
    `Adding <strong>${esc(field)}</strong> to <strong>${shelf}</strong> will create
    <strong style="color:var(--rose)">${fmtN(uniqueCount)} ${isColShelf?'columns':'rows'}</strong> in your view.
    <br><br>This may cause the UI to freeze or render slowly. Consider filtering this field first to narrow it down.`;

  document.getElementById('card-stats').innerHTML = `
    <div style="flex:1;background:var(--amber-lt);border:1px solid var(--amber-mid);border-radius:6px;padding:10px 12px;text-align:center;">
      <div style="font-family:var(--mono);font-size:18px;font-weight:700;color:var(--amber);">${fmtN(uniqueCount)}</div>
      <div style="font-size:10px;color:var(--muted);margin-top:2px;">Unique values</div>
    </div>
    <div style="flex:1;background:var(--forest-lt);border:1px solid var(--forest-mid);border-radius:6px;padding:10px 12px;text-align:center;">
      <div style="font-family:var(--mono);font-size:18px;font-weight:700;color:var(--forest);">${uniqueCount>500?'üî¥ High':uniqueCount>100?'üü° Med':'üü¢ OK'}</div>
      <div style="font-size:10px;color:var(--muted);margin-top:2px;">Risk level</div>
    </div>`;

  document.getElementById('card-filter-btn').onclick = () => {
    if (_pendingDrop) {
      const {field:f, type:t} = _pendingDrop;
      _pendingDrop = null;
      closeCardModal();

      // Add to filters instead
      if (!filterState[f]) filterState[f]={field:f,type:t,selectedValues:[],dataValues:[],stats:null,minVal:'',maxVal:''};
      if (!S.shelf.filters.find(x=>x.field===f)) {
        S.shelf.filters.push({field:f,type:t,agg:null});
        paintShelf('filters');
        fetchValuesAndOpen(f, t);
      }
    }
  };
  document.getElementById('card-anyway-btn').onclick = () => {
    if (_pendingDrop) {
      const {field:f, type:t, shelf:sh} = _pendingDrop;
      _pendingDrop = null;
      closeCardModal();

      proceedDrop(f, t, sh);
    }
  };
  document.getElementById('cardinality-modal').style.display='flex';
}

function proceedDrop(field, type, shelf) {
  const schemaEntry = S.schema.find(x=>x.name===field);
  const uid = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
  const item = {field, type, agg: type==='measure'?(schemaEntry?.defaultAgg||'SUM'):null, _uid: uid};
  
  // NEW: migrate any existing transform from plain key to uid key
  if (type === 'measure') {
    const plainKey = `${item.agg}(${field})`;
    const uidKey   = `${item.agg}(${field})__${uid}`;
    if (colTransforms[plainKey]) {
      colTransforms[uidKey] = colTransforms[plainKey];
      // DON'T delete plainKey ‚Äî the original chip still uses it
    }
  }
  
  S.shelf[shelf].push(item);
  paintShelf(shelf);
  runQuery();
}

function showSkipLog() {
  if (!S.skipped.length) return;
  const modal = document.getElementById('skip-modal');
  document.getElementById('skip-modal-sub').textContent =
    `${fmtN(S.skipped.length)} of ${fmtN(S.rowCount)} rows excluded from current query`;
  // Build columns: Row#, Reason, then all schema fields
  const cols = S.schema.map(s => s.name);
  document.getElementById('skip-thead').innerHTML =
    `<tr style="background:var(--white);">
      <th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--muted);border-bottom:2px solid var(--rule);white-space:nowrap;">Row #</th>
      <th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--rose);border-bottom:2px solid var(--rule);white-space:nowrap;">Reason</th>
      ${cols.map(c=>`<th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--muted);border-bottom:2px solid var(--rule);white-space:nowrap;">${esc(c)}</th>`).join('')}
    </tr>`;
  document.getElementById('skip-tbody').innerHTML =
    S.skipped.slice(0,1000).map((s,idx) => {
      const rowCells = cols.map(c => {
        const v = s.data ? s.data[c] : '';
        return `<td style="padding:7px 12px;border-bottom:1px solid var(--rule);color:var(--ink2);">${esc(String(v??''))}</td>`;
      }).join('');
      return `<tr style="background:${idx%2===0?'#fff':'#FAFAF8'}">
        <td style="padding:7px 12px;border-bottom:1px solid var(--rule);font-family:var(--mono);color:var(--muted);">${fmtN(s.row)}</td>
        <td style="padding:7px 12px;border-bottom:1px solid var(--rule);color:var(--rose);font-weight:500;">${esc(s.reason)}</td>
        ${rowCells}
      </tr>`;
    }).join('') +
    (S.skipped.length>1000 ? `<tr><td colspan="${cols.length+2}" style="padding:12px;text-align:center;color:var(--muted);font-style:italic;">Showing first 1,000 of ${fmtN(S.skipped.length)} skipped rows ‚Äî export for full log</td></tr>` : '');
  modal.style.display = 'flex';
}

function closeSkipLog() { document.getElementById('skip-modal').style.display='none'; }

function exportSkipLog() {
  if (!S.skipped.length) return;
  const cols = S.schema.map(s=>s.name);
  const lines = [['Row #','Reason',...cols].map(h=>`"${h}"`).join(',')];
  S.skipped.forEach(s => {
    const row = [s.row, s.reason, ...cols.map(c=>s.data?s.data[c]:'')];
    lines.push(row.map(v=>typeof v==='number'?v:`"${String(v??'').replace(/"/g,'""')}"`).join(','));
  });
  const blob = new Blob([lines.join('\n')],{type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`skipped_rows_log.csv`; a.click(); URL.revokeObjectURL(a.href);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOAD MENU
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleLoadMenu(e) {
  e.stopPropagation();
  const m = document.getElementById('load-menu');
  const c = document.getElementById('load-caret');
  const open = m.style.display === 'block';
  m.style.display = open ? 'none' : 'block';
  c.style.transform = open ? '' : 'rotate(180deg)';
}
function closeLoadMenu() {
  document.getElementById('load-menu').style.display='none';
  document.getElementById('load-caret').style.transform='';
}
document.addEventListener('click', (e) => {
  const wrap = document.getElementById('load-btn-wrap');
  if (wrap && !wrap.contains(e.target)) closeLoadMenu();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GOOGLE DRIVE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// ‚îÄ‚îÄ CONFIG: paste your Google OAuth Client ID here ‚îÄ‚îÄ
const GDRIVE_CLIENT_ID  = localStorage.getItem('dvs_google_cid') || 'YOUR_GOOGLE_CLIENT_ID';
const ONEDRIVE_CLIENT_ID = localStorage.getItem('dvs_onedrive_cid') || 'YOUR_ONEDRIVE_CLIENT_ID';
const ONEDRIVE_API = 'https://graph.microsoft.com/v1.0';

let onedriveToken = null;
let onedriveTokenExpiry = 0; // unix ms
let onedriveStack = [{ id:'root', name:'My OneDrive' }];
let onedriveAllFiles = [];
let onedriveSelectedFile = null;

// ‚îÄ‚îÄ Token helpers ‚îÄ‚îÄ
const TOKEN_GRACE_MS = 5 * 60 * 1000; // treat token as expired 5min early

function _saveToken(provider, token, expiresInSec) {
  const expiry = Date.now() + (expiresInSec || 3600) * 1000 - TOKEN_GRACE_MS;
  if (provider === 'google') {
    driveToken = token; driveTokenExpiry = expiry;
    try { localStorage.setItem('dvs_google_token', token);
          localStorage.setItem('dvs_google_expiry', String(expiry)); } catch(e) {}
  } else {
    onedriveToken = token; onedriveTokenExpiry = expiry;
    try { localStorage.setItem('dvs_od_token', token);
          localStorage.setItem('dvs_od_expiry', String(expiry)); } catch(e) {}
  }
}

function _loadSavedTokens() {
  try {
    const gt = localStorage.getItem('dvs_google_token');
    const ge = parseInt(localStorage.getItem('dvs_google_expiry') || '0');
    if (gt && ge > Date.now()) { driveToken = gt; driveTokenExpiry = ge; }

    const ot = localStorage.getItem('dvs_od_token');
    const oe = parseInt(localStorage.getItem('dvs_od_expiry') || '0');
    if (ot && oe > Date.now()) { onedriveToken = ot; onedriveTokenExpiry = oe; }
  } catch(e) {}
}

function _isTokenValid(provider) {
  if (provider === 'google')   return !!driveToken    && Date.now() < driveTokenExpiry;
  if (provider === 'onedrive') return !!onedriveToken && Date.now() < onedriveTokenExpiry;
  return false;
}

function _clearToken(provider) {
  if (provider === 'google') {
    driveToken = null; driveTokenExpiry = 0;
    try { localStorage.removeItem('dvs_google_token');
          localStorage.removeItem('dvs_google_expiry'); } catch(e) {}
  } else {
    onedriveToken = null; onedriveTokenExpiry = 0;
    try { localStorage.removeItem('dvs_od_token');
          localStorage.removeItem('dvs_od_expiry'); } catch(e) {}
  }
}

// Load any saved valid tokens on startup
_loadSavedTokens();

const GDRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.readonly';
const GDRIVE_API = 'https://www.googleapis.com/drive/v3';

let driveToken = null;
let driveTokenExpiry = 0; // unix ms
let driveStack = [{ id:'root', name:'My Drive' }];
let driveAllFiles = [];
let driveFilter = 'all';
let driveSelectedFile = null;

function openDriveModal() {
  document.getElementById('drive-modal').classList.add('show');
  if (driveToken) showDriveBrowser();
}
function closeDriveModal() {
  document.getElementById('drive-modal').classList.remove('show');
  driveSelectedFile = null;
}

function driveSignIn() {
  if (!GDRIVE_CLIENT_ID || GDRIVE_CLIENT_ID.startsWith('YOUR_')) {
    showOAuthSetup('google'); return;
  }
  const url = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${GDRIVE_CLIENT_ID}&redirect_uri=${encodeURIComponent(location.origin+location.pathname)}&response_type=token&scope=${encodeURIComponent(GDRIVE_SCOPE)}&prompt=consent`;
  const popup = window.open(url, 'gdrive_auth', 'width=520,height=620,left=200,top=100');
  const timer = setInterval(() => {
    try {
      const hash = popup.location.hash;
      if (hash && hash.includes('access_token')) {
        clearInterval(timer);
        popup.close();
        const params = new URLSearchParams(hash.slice(1));
        const token     = params.get('access_token');
        const expiresIn = parseInt(params.get('expires_in') || '3600');
        _saveToken('google', token, expiresIn);
        showDriveBrowser();
        driveFetchFolder('root');
      }
    } catch(e) {}
    if (popup.closed) clearInterval(timer);
  }, 300);
}

function showDriveBrowser() {
  document.getElementById('drive-auth-banner').style.display='none';
  document.getElementById('drive-auth-btn').textContent='Switch account';
  document.getElementById('drive-account-sub').textContent='Connected ‚Äî browse your files';
  document.getElementById('drive-browser').style.display='flex';
}

async function driveFetchFolder(folderId) {
  if (!_isTokenValid('google')) {
    _clearToken('google');
    document.getElementById('drive-file-list').innerHTML=`<div class="drive-empty">‚ö† Session expired ‚Äî please sign in again.</div>`;
    document.getElementById('drive-auth-btn').textContent = 'Sign in';
    document.getElementById('drive-account-sub').textContent = 'Session expired';
    document.getElementById('drive-browser').style.display = 'none';
    document.getElementById('drive-auth-banner').style.display = '';
    return;
  }
  document.getElementById('drive-file-list').innerHTML='<div class="drive-empty">Loading‚Ä¶</div>';
  driveSelectedFile = null;
  updateDriveImportBtn();
  const mimeFilter = "mimeType='text/csv' or mimeType='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' or mimeType='application/vnd.ms-excel' or mimeType='application/vnd.google-apps.folder'";
  const q = `'${folderId}' in parents and trashed=false and (${mimeFilter})`;
  const url = `${GDRIVE_API}/files?q=${encodeURIComponent(q)}&fields=files(id,name,mimeType,size,modifiedTime,parents)&orderBy=folder,name&pageSize=200`;
  try {
    const res = await fetch(url, { headers:{ Authorization:`Bearer ${driveToken}` } });
    if (res.status === 401) {
      _clearToken('google');
      document.getElementById('drive-file-list').innerHTML=`<div class="drive-empty">‚ö† Session expired ‚Äî please sign in again.</div>`;
      document.getElementById('drive-auth-btn').textContent = 'Sign in';
      document.getElementById('drive-account-sub').textContent = 'Session expired';
      document.getElementById('drive-browser').style.display = 'none';
      document.getElementById('drive-auth-banner').style.display = '';
      return;
    }
    const data = await res.json();
    driveAllFiles = data.files || [];
    renderDriveFiles(driveAllFiles);
  } catch(err) {
    document.getElementById('drive-file-list').innerHTML=`<div class="drive-empty">‚ö† Error loading files: ${err.message}</div>`;
  }
}

function renderDriveFiles(files) {
  const q = document.getElementById('drive-search-inp').value.toLowerCase();
  let filtered = files.filter(f => {
    if (q && !f.name.toLowerCase().includes(q)) return false;
    if (driveFilter==='csv') return f.mimeType==='text/csv' || f.mimeType==='application/vnd.google-apps.folder';
    if (driveFilter==='excel') return f.mimeType.includes('spreadsheet') || f.mimeType.includes('excel') || f.mimeType==='application/vnd.google-apps.folder';
    return true;
  });
  if (!filtered.length) {
    document.getElementById('drive-file-list').innerHTML='<div class="drive-empty">No compatible files found in this folder</div>';
    return;
  }
  document.getElementById('drive-file-list').innerHTML = filtered.map(f => {
    const isFolder = f.mimeType==='application/vnd.google-apps.folder';
    const icon = isFolder ? 'üìÅ' : f.mimeType==='text/csv' ? 'üìÑ' : 'üìä';
    const bg   = isFolder ? '#f8f9fa' : f.mimeType==='text/csv' ? 'var(--forest-lt)' : 'var(--amber-lt)';
    const size = f.size ? (f.size>1048576?(f.size/1048576).toFixed(1)+'MB':(f.size/1024).toFixed(0)+'KB') : '';
    const mod  = f.modifiedTime ? new Date(f.modifiedTime).toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'}) : '';
    const _rk = _regSet(f);
    return `<div class="drive-file-item" id="dfi-${esc(f.id)}"
      onclick="${isFolder?`_driveEnterFolderReg(${_rk})`:`_selectDriveFileReg(${_rk})`}"
      ondblclick="${isFolder?`_driveEnterFolderReg(${_rk})`:``}">
      <div class="drive-file-icon" style="background:${bg}">${icon}</div>
      <div style="flex:1;min-width:0;">
        <div class="drive-file-name">${esc(f.name)}</div>
        <div class="drive-file-meta">${mod}</div>
      </div>
      ${!isFolder?`<div class="drive-file-size">${size}</div>`:'<div style="color:var(--faint);font-size:11px;">‚ñ∂</div>'}
    </div>`;
  }).join('');
}

function _driveEnterFolderReg(k) {
  const f = _regGet(k); if (!f) return;
  driveEnterFolder(f.id, f.name);
}
function _selectDriveFileReg(k) {
  const f = _regGet(k); if (!f) return;
  selectDriveFile(f.id, f.name, f.mimeType);
}

function driveEnterFolder(id, name) {
  driveStack.push({id, name});
  renderDriveBreadcrumb();
  driveFetchFolder(id);
}

function driveNavRoot() {
  driveStack = [{ id:'root', name:'My Drive' }];
  renderDriveBreadcrumb();
  driveFetchFolder('root');
}

function renderDriveBreadcrumb() {
  document.getElementById('drive-breadcrumb').innerHTML = driveStack.map((s,i) => {
    const isLast = i===driveStack.length-1;
    return (isLast
      ? `<span style="color:var(--ink2);font-weight:600;">${esc(s.name)}</span>`
      : `<span class="drive-bc-item" onclick="driveBcNav(${i})">${esc(s.name)}</span>`)
      + (isLast?'':'<span class="drive-bc-sep"> ‚Ä∫ </span>');
  }).join('');
}

function driveBcNav(idx) {
  driveStack = driveStack.slice(0, idx+1);
  renderDriveBreadcrumb();
  driveFetchFolder(driveStack[idx].id);
}

function selectDriveFile(id, name, mime) {
  driveSelectedFile = {id, name, mime};
  document.querySelectorAll('.drive-file-item').forEach(el=>el.classList.remove('selected'));
  document.getElementById('dfi-'+id)?.classList.add('selected');
  document.getElementById('drive-selected-info').innerHTML=`Selected: <strong>${esc(name)}</strong>`;
  updateDriveImportBtn();
}

function updateDriveImportBtn() {
  const btn = document.getElementById('drive-import-btn');
  btn.disabled = !driveSelectedFile;
  btn.style.opacity = driveSelectedFile ? '1' : '.4';
  btn.style.cursor  = driveSelectedFile ? 'pointer' : 'default';
}

async function driveImport() {
  if (!driveSelectedFile) return;
  const {id, name, mime} = driveSelectedFile;
  closeDriveModal();
  S.filename = name;
  S.shelf = { columns:[], rows:[], filters:[] };
  S.result = null;
  S.skipped = [];
  S.lodFields = [];
  S.drillStack = [];
  S.hierarchies = {};
  S.params = [];
  Object.keys(filterState).forEach(k => delete filterState[k]);
  Object.keys(colTransforms).forEach(k => delete colTransforms[k]);
  Object.keys(colMaWindow).forEach(k => delete colMaWindow[k]);
  dualAxisKeys.clear();
  paintAllShelves();
  closePopover();
  paintDrillBar();
  paintParams();
  document.getElementById('row-badge').style.display='none';
  sortState = { col:null, dir:1 };
  showProgress('Downloading from Drive‚Ä¶', 10, name);
  try {
    const url = `${GDRIVE_API}/files/${id}?alt=media`;
    const res = await fetch(url, { headers:{Authorization:`Bearer ${driveToken}`} });
    if (!res.ok) throw new Error('Download failed: '+res.status);
    setProgress(40, 'Reading file‚Ä¶');
    if (mime==='text/csv') {
      const text = await res.text();
      setProgress(55,'Parsing rows‚Ä¶');
      worker.postMessage({type:'PARSE_CSV', payload:text});
    } else {
      const buf = await res.arrayBuffer();
      setProgress(55,'Converting Excel‚Ä¶');
      let wb;
      try {
        wb = XLSX.read(buf, {type:'array', dense:true});
      } catch(xlsxErr) {
        hideProgress();
        setStatus('‚ö† Could not read Excel file: ' + xlsxErr.message);
        return;
      }
      let sheetIdx = 0;
      if (wb.SheetNames.length > 1) {
        const choice = window.prompt(`${wb.SheetNames.length} sheets:\n${wb.SheetNames.map((n,i)=>`${i+1}. ${n}`).join('\n')}\n\nEnter sheet number:`,'1');
        if (choice === null) { hideProgress(); return; }
        sheetIdx = Math.max(0, Math.min(wb.SheetNames.length-1, (parseInt(choice)||1)-1));
      }
      const ws = wb.Sheets[wb.SheetNames[sheetIdx]];
      if (!ws) { hideProgress(); setStatus('‚ö† Could not read sheet'); return; }
      const data = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
      if (data.length < 2) { hideProgress(); setStatus('‚ö† Empty sheet ‚Äî no data rows found'); return; }
      const headers=data[0].map(h=>String(h).trim());
      const tmp={}; headers.forEach(h=>tmp[h]=[]);
      for(let r=1;r<data.length;r++) headers.forEach((h,i)=>tmp[h].push(data[r][i]??''));
      setProgress(78,'Inferring schema‚Ä¶');
      const sch=[],colsOut={};
      headers.forEach(h=>{
        const arr=tmp[h],samp=arr.slice(0,600);
        const nc=samp.filter(v=>v!==''&&!isNaN(parseFloat(v))).length;
        if(nc>samp.length*0.75){colsOut[h]=new Float64Array(arr.map(v=>parseFloat(v)||0));sch.push({name:h,type:'measure'});}
        else{colsOut[h]=arr.map(v=>String(v));sch.push({name:h,type:'dimension'});}
      });
      setProgress(88,'Loading engine‚Ä¶');
      const _transfers = Object.values(colsOut).filter(v => v instanceof Float64Array).map(v => v.buffer);
      worker.postMessage({type:'LOAD_COLS',payload:{columns:colsOut,sch,count:data.length-1}}, _transfers);
    }
  } catch(err) {
    hideProgress(); setStatus('‚ö† Drive import error: '+err.message);
  }
}

function driveSearch(val) { renderDriveFiles(driveAllFiles); }
function setDriveFilter(type, btn) {
  driveFilter = type;
  document.querySelectorAll('.drive-type-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderDriveFiles(driveAllFiles);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   OAUTH SETUP MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _oauthProvider = 'google';

function showOAuthSetup(provider) {
  _oauthProvider = provider;
  const isGoogle = provider === 'google';
  document.getElementById('oauth-modal-title').textContent = isGoogle ? 'Connect Google Drive' : 'Connect OneDrive';
  document.getElementById('oauth-input-label').textContent = isGoogle ? 'Paste your Google Client ID' : 'Paste your Azure Application (Client) ID';
  document.getElementById('oauth-cid-hint').textContent = isGoogle
    ? 'Ends with .apps.googleusercontent.com'
    : 'Found in Azure Portal ‚Üí App registrations ‚Üí your app ‚Üí Overview';
  document.getElementById('oauth-console-link').href = isGoogle
    ? 'https://console.cloud.google.com/apis/credentials'
    : 'https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationsListBlade';
  document.getElementById('oauth-console-link').textContent = isGoogle
    ? 'üîó Google Cloud Console'
    : 'üîó Azure App Registrations';
  document.getElementById('oauth-cid-input').value = isGoogle
    ? (localStorage.getItem('dvs_google_cid')||'')
    : (localStorage.getItem('dvs_onedrive_cid')||'');

  const steps = isGoogle ? [
    ['1', 'Go to Google Cloud Console', 'Create a project (or pick existing)'],
    ['2', 'APIs & Services ‚Üí Credentials', 'Create OAuth 2.0 Client ID ‚Üí Web Application'],
    ['3', 'Add Authorised Origin', `Add: <code style="background:var(--cream);padding:1px 5px;border-radius:3px;">${location.origin}</code>`],
    ['4', 'Copy Client ID', 'Paste it below and click Save & Connect'],
  ] : [
    ['1', 'Go to Azure Portal ‚Üí App registrations', 'Click "New registration"'],
    ['2', 'Set Redirect URI', `Single-page app ‚Üí <code style="background:var(--cream);padding:1px 5px;border-radius:3px;">${location.origin+location.pathname}</code>`],
    ['3', 'API Permissions', 'Add Files.Read (Microsoft Graph)'],
    ['4', 'Copy Application (Client) ID', 'From Overview page ‚Äî paste below'],
  ];

  document.getElementById('oauth-steps').innerHTML = steps.map(([n,title,desc])=>`
    <div style="display:flex;gap:12px;margin-bottom:14px;align-items:flex-start;">
      <div style="width:22px;height:22px;border-radius:50%;background:var(--forest);color:#fff;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;">${n}</div>
      <div>
        <div style="font-size:12.5px;font-weight:600;color:var(--ink);">${title}</div>
        <div style="font-size:11.5px;color:var(--muted);margin-top:2px;">${desc}</div>
      </div>
    </div>`).join('');

  document.getElementById('oauth-setup-modal').style.display='flex';
}

function closeOAuthSetup() {
  document.getElementById('oauth-setup-modal').style.display='none';
}

function saveOAuthCid() {
  const val = document.getElementById('oauth-cid-input').value.trim();
  if (!val) { document.getElementById('oauth-cid-hint').style.color='var(--rose)'; document.getElementById('oauth-cid-hint').textContent='Please paste your Client ID first'; return; }
  if (_oauthProvider==='google') {
    localStorage.setItem('dvs_google_cid', val);
    closeOAuthSetup();
    // Reload so constant picks up new value
    location.reload();
  } else {
    localStorage.setItem('dvs_onedrive_cid', val);
    closeOAuthSetup();
    location.reload();
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ONEDRIVE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openOnedriveModal() {
  const cid = localStorage.getItem('dvs_onedrive_cid');
  if (!cid) { showOAuthSetup('onedrive'); return; }
  document.getElementById('onedrive-modal').classList.add('show');
  if (onedriveToken) showOnedriveBrowser();
}
function closeOnedriveModal() {
  document.getElementById('onedrive-modal').classList.remove('show');
  onedriveSelectedFile = null;
}

function onedriveSignIn() {
  const cid = localStorage.getItem('dvs_onedrive_cid');
  if (!cid) { showOAuthSetup('onedrive'); return; }
  const redirectUri = encodeURIComponent(location.origin+location.pathname);
  const scope = encodeURIComponent('Files.Read Files.Read.All offline_access');
  const url = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${cid}&response_type=token&redirect_uri=${redirectUri}&scope=${scope}&response_mode=fragment`;
  const popup = window.open(url,'onedrive_auth','width=520,height=620,left=200,top=100');
  const timer = setInterval(()=>{
    try {
      const hash = popup.location.hash;
      if (hash && hash.includes('access_token')) {
        clearInterval(timer); popup.close();
        const params   = new URLSearchParams(hash.slice(1));
        const token     = params.get('access_token');
        const expiresIn = parseInt(params.get('expires_in') || '3600');
        _saveToken('onedrive', token, expiresIn);
        showOnedriveBrowser();
        onedriveFetchFolder('root');
      }
    } catch(e){}
    if (popup.closed) clearInterval(timer);
  },300);
}

function showOnedriveBrowser() {
  document.getElementById('onedrive-auth-banner').style.display='none';
  document.getElementById('onedrive-auth-btn').textContent='Switch account';
  document.getElementById('onedrive-account-sub').textContent='Connected ‚Äî browse your files';
  document.getElementById('onedrive-browser').style.display='flex';
}

async function onedriveFetchFolder(folderId) {
  if (!_isTokenValid('onedrive')) {
    _clearToken('onedrive');
    document.getElementById('onedrive-file-list').innerHTML=`<div class="drive-empty">‚ö† Session expired ‚Äî please sign in again.</div>`;
    document.getElementById('onedrive-auth-btn').textContent = 'Sign in';
    document.getElementById('onedrive-account-sub').textContent = 'Session expired';
    document.getElementById('onedrive-browser').style.display = 'none';
    document.getElementById('onedrive-auth-banner').style.display = '';
    return;
  }
  document.getElementById('onedrive-file-list').innerHTML='<div class="drive-empty">Loading‚Ä¶</div>';
  onedriveSelectedFile=null; updateOnedriveImportBtn();
  const url = folderId==='root'
    ? `${ONEDRIVE_API}/me/drive/root/children?$select=id,name,file,folder,size,lastModifiedDateTime&$top=200`
    : `${ONEDRIVE_API}/me/drive/items/${folderId}/children?$select=id,name,file,folder,size,lastModifiedDateTime&$top=200`;
  try {
    const res = await fetch(url,{headers:{Authorization:`Bearer ${onedriveToken}`}});
    if (res.status === 401) {
      _clearToken('onedrive');
      document.getElementById('onedrive-file-list').innerHTML=`<div class="drive-empty">‚ö† Session expired ‚Äî please sign in again.</div>`;
      document.getElementById('onedrive-auth-btn').textContent = 'Sign in';
      document.getElementById('onedrive-account-sub').textContent = 'Session expired';
      document.getElementById('onedrive-browser').style.display = 'none';
      document.getElementById('onedrive-auth-banner').style.display = '';
      return;
    }
    const data = await res.json();
    onedriveAllFiles = (data.value||[]).filter(f=>{
      if (f.folder) return true;
      const n = f.name.toLowerCase();
      return n.endsWith('.csv')||n.endsWith('.xlsx')||n.endsWith('.xls');
    });
    renderOnedriveFiles(onedriveAllFiles);
  } catch(err) {
    document.getElementById('onedrive-file-list').innerHTML=`<div class="drive-empty">‚ö† ${err.message}</div>`;
  }
}

function renderOnedriveFiles(files) {
  const q = document.getElementById('onedrive-search-inp')?.value.toLowerCase()||'';
  const filtered = files.filter(f=>!q||f.name.toLowerCase().includes(q));
  if (!filtered.length) { document.getElementById('onedrive-file-list').innerHTML='<div class="drive-empty">No compatible files found</div>'; return; }
  document.getElementById('onedrive-file-list').innerHTML = filtered.map(f=>{
    const isFolder=!!f.folder;
    const icon=isFolder?'üìÅ':f.name.endsWith('.csv')?'üìÑ':'üìä';
    const bg=isFolder?'#f8f9fa':f.name.endsWith('.csv')?'var(--forest-lt)':'var(--amber-lt)';
    const size=f.size?(f.size>1048576?(f.size/1048576).toFixed(1)+'MB':(f.size/1024).toFixed(0)+'KB'):'';
    const mod=f.lastModifiedDateTime?new Date(f.lastModifiedDateTime).toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'}):'';
    return `<div class="drive-file-item" id="odfi-${f.id}"
      onclick="${isFolder?`onedriveEnterFolder('${f.id}','${esc(f.name)}')`:`selectOnedriveFile('${f.id}','${esc(f.name)}')`}">
      <div class="drive-file-icon" style="background:${bg}">${icon}</div>
      <div style="flex:1;min-width:0;">
        <div class="drive-file-name">${esc(f.name)}</div>
        <div class="drive-file-meta">${mod}</div>
      </div>
      ${!isFolder?`<div class="drive-file-size">${size}</div>`:'<div style="color:var(--faint);font-size:11px;">‚ñ∂</div>'}
    </div>`;
  }).join('');
}

function onedriveEnterFolder(id, name) {
  onedriveStack.push({id,name});
  renderOnedriveBreadcrumb();
  onedriveFetchFolder(id);
}
function renderOnedriveBreadcrumb() {
  document.getElementById('onedrive-breadcrumb').innerHTML = onedriveStack.map((s,i)=>{
    const isLast=i===onedriveStack.length-1;
    return (isLast?`<span style="color:var(--ink2);font-weight:600;">${esc(s.name)}</span>`
      :`<span class="drive-bc-item" onclick="onedriveBcNav(${i})">${esc(s.name)}</span>`)
      +(isLast?'':'<span class="drive-bc-sep"> ‚Ä∫ </span>');
  }).join('');
}
function onedriveBcNav(idx) {
  onedriveStack=onedriveStack.slice(0,idx+1);
  renderOnedriveBreadcrumb();
  onedriveFetchFolder(onedriveStack[idx].id);
}
function selectOnedriveFile(id, name) {
  onedriveSelectedFile={id,name};
  document.querySelectorAll('.drive-file-item').forEach(el=>el.classList.remove('selected'));
  document.getElementById('odfi-'+id)?.classList.add('selected');
  document.getElementById('onedrive-selected-info').innerHTML=`Selected: <strong>${esc(name)}</strong>`;
  updateOnedriveImportBtn();
}
function updateOnedriveImportBtn() {
  const btn=document.getElementById('onedrive-import-btn');
  btn.disabled=!onedriveSelectedFile;
  btn.style.opacity=onedriveSelectedFile?'1':'.4';
}
async function onedriveImport() {
  if (!onedriveSelectedFile) return;
  const {id,name}=onedriveSelectedFile;
  closeOnedriveModal();
  S.filename = name;
  S.shelf = { columns:[], rows:[], filters:[] };
  S.result = null;
  S.skipped = [];
  S.lodFields = [];
  S.drillStack = [];
  S.hierarchies = {};
  S.params = [];
  Object.keys(filterState).forEach(k => delete filterState[k]);
  Object.keys(colTransforms).forEach(k => delete colTransforms[k]);
  Object.keys(colMaWindow).forEach(k => delete colMaWindow[k]);
  dualAxisKeys.clear();
  paintAllShelves();
  closePopover();
  paintDrillBar();
  paintParams();
  document.getElementById('row-badge').style.display='none';
  sortState = { col:null, dir:1 };
  showProgress('Downloading from OneDrive‚Ä¶',10,name);
  try {
    const metaRes=await fetch(`${ONEDRIVE_API}/me/drive/items/${id}?$select=@microsoft.graph.downloadUrl`,{headers:{Authorization:`Bearer ${onedriveToken}`}});
    const meta=await metaRes.json();
    const dlUrl=meta['@microsoft.graph.downloadUrl'];
    const res=await fetch(dlUrl);
    setProgress(50,'Reading file‚Ä¶');
    if (name.toLowerCase().endsWith('.csv')) {
      const text=await res.text();
      worker.postMessage({type:'PARSE_CSV',payload:text});
    } else {
      const buf=await res.arrayBuffer();
      let wb;
      try {
        wb = XLSX.read(buf, {type:'array', dense:true});
      } catch(xlsxErr) {
        hideProgress();
        setStatus('‚ö† Could not read Excel file: ' + xlsxErr.message);
        return;
      }
      let sheetIdx = 0;
      if (wb.SheetNames.length > 1) {
        const choice = window.prompt(`${wb.SheetNames.length} sheets:\n${wb.SheetNames.map((n,i)=>`${i+1}. ${n}`).join('\n')}\n\nEnter sheet number:`,'1');
        if (choice === null) { hideProgress(); return; }
        sheetIdx = Math.max(0, Math.min(wb.SheetNames.length-1, (parseInt(choice)||1)-1));
      }
      const ws = wb.Sheets[wb.SheetNames[sheetIdx]];
      if (!ws) { hideProgress(); setStatus('‚ö† Could not read sheet'); return; }
      const data = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
      const headers=data[0].map(h=>String(h).trim());
      const tmp={}; headers.forEach(h=>tmp[h]=[]);
      for(let r=1;r<data.length;r++) headers.forEach((h,i)=>tmp[h].push(data[r][i]??''));
      const sch=[],colsOut={};
      headers.forEach(h=>{
        const arr=tmp[h],samp=arr.slice(0,600);
        const nc=samp.filter(v=>v!==''&&!isNaN(parseFloat(v))).length;
        if(nc>samp.length*0.75){colsOut[h]=new Float64Array(arr.map(v=>parseFloat(v)||0));sch.push({name:h,type:'measure'});}
        else{colsOut[h]=arr.map(v=>String(v));sch.push({name:h,type:'dimension'});}
      });
      const _transfers = Object.values(colsOut).filter(v => v instanceof Float64Array).map(v => v.buffer);
      worker.postMessage({type:'LOAD_COLS',payload:{columns:colsOut,sch,count:data.length-1}}, _transfers);
    }
  } catch(err) { hideProgress(); setStatus('‚ö† OneDrive import error: '+err.message); }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PROGRESS + UTILS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showProgress(title,pct,sub) { document.getElementById('progress-overlay').classList.add('show'); document.getElementById('progress-title').textContent=title; document.getElementById('progress-sub').textContent=sub; document.getElementById('prog-fill').style.width=pct+'%'; document.getElementById('prog-pct').textContent=pct+'%'; }
function setProgress(pct,sub) { document.getElementById('prog-fill').style.width=pct+'%'; document.getElementById('prog-pct').textContent=pct+'%'; document.getElementById('progress-sub').textContent=sub; }
function hideProgress() { document.getElementById('progress-overlay').classList.remove('show'); }

document.addEventListener('DOMContentLoaded', checkRestoreBanner); 

function setStatus(msg) {
  document.getElementById('status-bar').textContent = msg;
  const badge = document.getElementById('skip-badge');
  if (S.skipped && S.skipped.length) {
    badge.textContent = `‚ö† ${fmtN(S.skipped.length)} rows skipped`;
    badge.style.display = '';
    badge.onclick = () => showSkipLog();
  } else {
    badge.style.display = 'none';
  }
}
function esc(s) {
  if (s === null || s === undefined) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmtN(n) { return Number(n).toLocaleString(); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GLOBAL CLICK ‚Äî close popover on outside click
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.addEventListener('click', e => {
  const pop=document.getElementById('filter-popover');
  if (!pop.contains(e.target) && !e.target.closest('.fchip')) closePopover();
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closePopover();
    closeAnalysisMenu();
    closeMeaPopup();
    closeCtxMenu();
    document.getElementById('stat-modal').style.display = 'none';
    document.getElementById('corr-modal').style.display = 'none';
  }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RESIZE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.addEventListener('resize', () => { if(chart)chart.resize(); });
(function(){
  const h=document.getElementById('sidebar-resize'), sb=document.getElementById('sidebar');
  let on=false, sx=0, sw=0;
  h.addEventListener('mousedown',e=>{on=true;sx=e.clientX;sw=sb.offsetWidth;document.body.style.cursor='col-resize';document.body.style.userSelect='none';});
  document.addEventListener('mousemove',e=>{if(!on)return;const w=Math.max(180,Math.min(380,sw+e.clientX-sx));sb.style.width=w+'px';sb.style.minWidth=w+'px';if(chart)chart.resize();});
  document.addEventListener('mouseup',()=>{on=false;document.body.style.cursor='';document.body.style.userSelect='';});
})();


function crossDrop(e, targetType) {
  e.preventDefault();
  if (!dragF) return;
  if (dragF.type === 'dimension' && [...S.shelf.columns,...S.shelf.rows,...S.shelf.filters].find(f=>f.field===dragF.field)) return;
  if (dragF.type !== targetType) convertField(dragF.field, targetType);
}


function _renderPreviewModal(payload) {
  const { headers, rows, total } = payload;
  const shown = rows.length;
  document.getElementById('prev-info').textContent =
    `Showing ${fmtN(shown)} of ${fmtN(total)} rows ¬∑ ${headers.length} columns`;
  let h = '<table class="prev-tbl"><thead><tr>';
  headers.forEach(col => { h += `<th title="${esc(col)}">${esc(col)}</th>`; });
  h += '</tr></thead><tbody>';
  rows.forEach(r => {
    h += '<tr>';
    headers.forEach(col => {
      const v = r[col] ?? '';
      const d = typeof v === 'number'
        ? (Number.isInteger(v) ? v.toLocaleString() : v.toFixed(2))
        : esc(String(v));
      h += `<td title="${esc(String(v))}">${d}</td>`;
    });
    h += '</tr>';
  });
  h += '</tbody></table>';
  document.getElementById('prev-wrap').innerHTML = h;
  document.getElementById('prev-modal').style.display = 'flex';
}
function _closePreview() {
  document.getElementById('prev-modal').style.display = 'none';
}
function _changePreviewRows(val) {
  _previewRowCount = parseInt(val) || 100;
  _closePreview();
  showPreview();
}

</script>

<div id="ctx-menu" style="display:none;position:fixed;z-index:9999;background:#fff;border:1.5px solid var(--rule);border-radius:7px;box-shadow:var(--shadow-lg);padding:4px;min-width:200px;font-family:var(--font);">
  <div id="ctx-menu-inner"></div>
</div>

<style>
.ctx-item { padding:7px 12px;font-size:12px;cursor:pointer;border-radius:4px;display:flex;align-items:center;justify-content:space-between;gap:8px;color:var(--ink2);position:relative; }
.ctx-item:hover { background:var(--cream); }
.ctx-item.disabled { color:var(--faint);cursor:default; }
.ctx-item.disabled:hover { background:transparent; }
.ctx-sep { height:1px;background:var(--rule);margin:3px 0; }
.ctx-label { font-size:10px;font-weight:700;letter-spacing:.9px;text-transform:uppercase;color:var(--muted);padding:6px 12px 2px;cursor:default; }
.ctx-arrow { font-size:9px;opacity:.5; }
.ctx-sub { display:none;position:absolute;left:100%;top:-4px;background:#fff;border:1.5px solid var(--rule);border-radius:7px;box-shadow:var(--shadow-lg);padding:4px;min-width:170px;z-index:10000; }
.ctx-item:hover > .ctx-sub { display:block; }
.ctx-check { color:var(--forest);font-size:11px;font-weight:700; }

.load-menu-item {
  display:flex;align-items:center;gap:12px;padding:10px 12px;
  border-radius:7px;cursor:pointer;transition:background .12s;
}
.load-menu-item:hover { background:var(--cream); }
.lmi-icon {
  width:34px;height:34px;border-radius:8px;display:flex;
  align-items:center;justify-content:center;flex-shrink:0;
}
.lmi-title { font-size:12.5px;font-weight:600;color:var(--ink); }
.lmi-sub   { font-size:10.5px;color:var(--muted);margin-top:1px; }

/* Drive modal */
#drive-modal { display:none;position:fixed;inset:0;background:rgba(26,26,24,.45);z-index:9999;align-items:center;justify-content:center; }
#drive-modal.show { display:flex; }
.drive-card {
  background:#fff;border-radius:14px;box-shadow:var(--shadow-lg);
  width:560px;max-width:96vw;max-height:82vh;
  display:flex;flex-direction:column;overflow:hidden;
  animation:popIn .18s cubic-bezier(.34,1.56,.64,1);
}
.drive-header {
  padding:18px 20px 14px;border-bottom:1.5px solid var(--rule);
  display:flex;align-items:center;gap:12px;
}
.drive-logo { width:36px;height:36px;border-radius:9px;background:#e8f0fe;display:flex;align-items:center;justify-content:center;flex-shrink:0; }
.drive-title { font-family:var(--serif);font-size:16px;color:var(--ink); }
.drive-sub   { font-size:11px;color:var(--muted);margin-top:1px; }
.drive-search-wrap {
  padding:12px 16px;border-bottom:1px solid var(--rule);
  display:flex;gap:8px;align-items:center;
}
.drive-search {
  flex:1;background:var(--cream);border:1.5px solid var(--rule);
  border-radius:6px;padding:7px 10px 7px 32px;
  font-family:var(--font);font-size:12px;color:var(--ink);outline:none;
  transition:border .15s;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%238A8A84' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:10px center;background-size:13px;
}
.drive-search:focus { border-color:var(--forest-mid); }
.drive-search::placeholder { color:var(--faint); }
.drive-type-filter {
  display:flex;gap:4px;
}
.drive-type-btn {
  background:var(--cream);border:1.5px solid var(--rule);border-radius:5px;
  padding:5px 10px;font-size:11px;cursor:pointer;font-family:var(--font);
  color:var(--muted);transition:all .12s;white-space:nowrap;
}
.drive-type-btn.active { background:var(--forest-lt);border-color:var(--forest-mid);color:var(--forest);font-weight:600; }
.drive-breadcrumb {
  padding:8px 16px;display:flex;align-items:center;gap:4px;
  font-size:11px;color:var(--muted);border-bottom:1px solid var(--rule);
  flex-wrap:wrap;min-height:32px;
}
.drive-bc-item { cursor:pointer;color:var(--sky);transition:color .12s; }
.drive-bc-item:hover { color:var(--forest); }
.drive-bc-sep { opacity:.4; }
.drive-file-list { flex:1;overflow-y:auto;padding:6px 8px; }
.drive-file-item {
  display:flex;align-items:center;gap:11px;padding:9px 10px;
  border-radius:7px;cursor:pointer;transition:background .1s;
  border:1.5px solid transparent;
}
.drive-file-item:hover { background:var(--cream); }
.drive-file-item.selected { background:var(--forest-lt);border-color:var(--forest-mid); }
.drive-file-icon { width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px; }
.drive-file-name { flex:1;font-size:12.5px;font-weight:500;color:var(--ink);overflow:hidden;text-overflow:ellipsis;white-space:nowrap; }
.drive-file-meta { font-size:10.5px;color:var(--muted);margin-top:1px; }
.drive-file-size { font-size:10.5px;color:var(--faint);font-family:var(--mono);flex-shrink:0; }
.drive-empty { padding:40px 20px;text-align:center;color:var(--muted);font-size:12px;font-style:italic; }
.drive-footer {
  padding:12px 16px;border-top:1.5px solid var(--rule);
  display:flex;align-items:center;justify-content:space-between;
  background:#FDFCFA;
}
.drive-selected-info { font-size:11.5px;color:var(--muted); }
.drive-selected-info strong { color:var(--forest); }
.drive-auth-banner {
  margin:12px;border-radius:8px;padding:14px 16px;
  background:var(--sky-lt);border:1.5px solid #bfd4f0;
  display:flex;align-items:center;gap:12px;
}

/* ‚îÄ‚îÄ REFERENCE LINES PANEL ‚îÄ‚îÄ */
#refline-btn { position:absolute; bottom:14px; right:14px; z-index:200; background:var(--white); border:1.5px solid var(--rule); border-radius:var(--r); padding:5px 12px; font-size:11px; font-family:var(--font); color:var(--muted); cursor:pointer; box-shadow:var(--shadow-sm); transition:all .15s; display:none; }
#refline-btn:hover { border-color:var(--sky); color:var(--sky); }
#refline-panel { position:absolute; bottom:44px; right:14px; z-index:300; background:var(--white); border:1.5px solid var(--rule); border-radius:10px; box-shadow:var(--shadow-lg); width:300px; display:none; animation:popIn .15s cubic-bezier(.34,1.56,.64,1); }
#refline-panel.show { display:block; }
.rl-header { padding:11px 14px 9px; border-bottom:1px solid var(--rule); display:flex; align-items:center; justify-content:space-between; }
.rl-title { font-size:12px; font-weight:600; color:var(--ink); }
.rl-close { background:none; border:none; color:var(--muted); cursor:pointer; font-size:16px; line-height:1; padding:0; }
.rl-body { padding:10px 12px; }
.rl-form { display:flex; flex-direction:column; gap:7px; }
.rl-row { display:flex; gap:6px; align-items:center; }
.rl-sel { flex:1; border:1.5px solid var(--rule); border-radius:5px; padding:5px 8px; font-family:var(--font); font-size:11px; color:var(--ink); background:var(--cream); outline:none; }
.rl-sel:focus { border-color:var(--sky); }
.rl-inp { width:80px; border:1.5px solid var(--rule); border-radius:5px; padding:5px 8px; font-family:var(--mono); font-size:11px; color:var(--ink); background:var(--cream); outline:none; }
.rl-inp:focus { border-color:var(--sky); }
.rl-add { background:var(--sky); color:#fff; border:none; border-radius:5px; padding:5px 12px; font-size:11px; font-weight:600; font-family:var(--font); cursor:pointer; transition:background .15s; white-space:nowrap; }
.rl-add:hover { background:#0046a0; }
.rl-list { margin-top:8px; display:flex; flex-direction:column; gap:4px; max-height:160px; overflow-y:auto; }
.rl-chip { display:flex; align-items:center; gap:6px; padding:5px 8px; border-radius:5px; border:1.5px solid var(--rule); background:var(--cream); font-size:11px; }
.rl-chip-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.rl-chip-label { flex:1; color:var(--ink2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.rl-chip-rm { background:none; border:none; color:var(--muted); cursor:pointer; font-size:13px; line-height:1; padding:0; transition:color .1s; }
.rl-chip-rm:hover { color:var(--rose); }
.rl-empty { font-size:11px; color:var(--faint); font-style:italic; text-align:center; padding:8px 0; }


/* ‚îÄ‚îÄ DRILL BREADCRUMB ‚îÄ‚îÄ */
#drill-bar { display:none; align-items:center; gap:6px; padding:5px 14px; background:var(--amber-lt); border-bottom:1.5px solid var(--amber-mid); font-size:11.5px; flex-shrink:0; }
#drill-bar.show { display:flex; }
.drill-bc { display:flex; align-items:center; gap:4px; flex:1; flex-wrap:wrap; }
.drill-bc-item { color:var(--amber); font-weight:600; cursor:default; }
.drill-bc-sep { color:var(--amber-mid); }
.drill-bc-val { color:var(--ink2); font-weight:500; max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.drill-back { background:var(--amber); color:#fff; border:none; border-radius:4px; padding:4px 12px; font-size:11px; font-weight:600; font-family:var(--font); cursor:pointer; transition:background .15s; white-space:nowrap; }
.drill-back:hover { background:var(--amber-mid); color:var(--ink); }
.drill-up { background:transparent; border:1.5px solid var(--amber-mid); color:var(--amber); border-radius:4px; padding:3px 9px; font-size:11px; font-family:var(--font); cursor:pointer; margin-left:4px; }
.drill-up:hover { background:var(--amber-lt); }

/* ‚îÄ‚îÄ PARAMETERS PANEL ‚îÄ‚îÄ */
#param-section { border-top:1.5px solid var(--rule); flex-shrink:0; }
.param-head { padding:10px 14px 6px; font-size:10px; font-weight:600; letter-spacing:1.2px; color:var(--muted); text-transform:uppercase; display:flex; justify-content:space-between; align-items:center; cursor:pointer; user-select:none; }
.param-head:hover { color:var(--ink2); }
.param-add-btn { background:none; border:none; color:var(--forest); font-size:16px; cursor:pointer; line-height:1; padding:0; font-weight:700; }
.param-add-btn:hover { color:var(--ink); }
#param-list { padding:0 10px 10px; display:flex; flex-direction:column; gap:6px; max-height:180px; overflow-y:auto; }
.param-item { background:var(--cream); border:1.5px solid var(--rule); border-radius:6px; padding:7px 10px; }
.param-item-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:5px; }
.param-name { font-size:11.5px; font-weight:600; color:var(--ink); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.param-type-tag { font-size:9px; font-family:var(--mono); background:var(--sky-lt); color:var(--sky); border:1px solid #bfd4f0; border-radius:3px; padding:1px 5px; margin-left:6px; flex-shrink:0; }
.param-rm { background:none; border:none; color:var(--muted); cursor:pointer; font-size:13px; padding:0; transition:color .1s; }
.param-rm:hover { color:var(--rose); }
.param-ctrl { display:flex; align-items:center; gap:6px; }
.param-slider { flex:1; accent-color:var(--sky); cursor:pointer; }
.param-val-display { font-family:var(--mono); font-size:12px; font-weight:600; color:var(--sky); min-width:42px; text-align:right; }
.param-val-input { flex:1; border:1.5px solid var(--rule); border-radius:4px; padding:4px 7px; font-family:var(--mono); font-size:11px; background:var(--white); color:var(--ink); outline:none; }
.param-val-input:focus { border-color:var(--sky); }
/* Modal */
#param-modal { display:none; position:fixed; inset:0; background:rgba(26,26,24,.45); z-index:10000; align-items:center; justify-content:center; }
#param-modal.show { display:flex; }
.param-card { background:#fff; border-radius:12px; box-shadow:var(--shadow-lg); width:380px; max-width:96vw; overflow:hidden; animation:popIn .18s cubic-bezier(.34,1.56,.64,1); }
.param-card-head { padding:16px 18px 12px; border-bottom:1.5px solid var(--rule); font-family:var(--serif); font-size:15px; display:flex; justify-content:space-between; align-items:center; }
.param-card-body { padding:16px 18px; display:flex; flex-direction:column; gap:11px; }
.param-field-row { display:flex; flex-direction:column; gap:4px; }
.param-field-label { font-size:11px; font-weight:600; color:var(--ink2); }
.param-field-inp { border:1.5px solid var(--rule); border-radius:5px; padding:7px 10px; font-family:var(--font); font-size:12px; color:var(--ink); outline:none; transition:border .15s; background:var(--cream); }
.param-field-inp:focus { border-color:var(--sky); }
.param-card-foot { padding:10px 18px 14px; display:flex; gap:8px; justify-content:flex-end; border-top:1px solid var(--rule); }
.param-save { background:var(--sky); color:#fff; border:none; border-radius:6px; padding:7px 20px; font-size:12px; font-weight:600; font-family:var(--font); cursor:pointer; }
.param-save:hover { background:#0046a0; }
.param-cancel { background:transparent; border:1.5px solid var(--rule); border-radius:6px; padding:7px 14px; font-size:12px; font-family:var(--font); color:var(--muted); cursor:pointer; }

.totals-opt { padding:7px 16px; font-size:12px; color:var(--ink2); cursor:pointer; display:flex; align-items:center; gap:8px; transition:background .12s; }
.totals-opt:hover { background:var(--cream); }
.tot-chk { font-size:14px; color:var(--forest); width:16px; }

.subtotal-row td { background: var(--amber-lt) !important; color: var(--amber); font-weight: 600; font-size: 11px; border-top: 1px solid var(--amber-mid); border-bottom: 1px solid var(--amber-mid); }
.grand-total-row td { background: var(--forest-lt) !important; color: var(--forest); font-weight: 700; border-top: 2px solid var(--forest-mid); }


/* ‚îÄ‚îÄ ANALYSIS DROPDOWN ‚îÄ‚îÄ */
#analysis-menu{display:none;position:absolute;right:0;top:calc(100% + 6px);background:var(--white);border:1.5px solid var(--rule);border-radius:10px;box-shadow:var(--shadow-lg);padding:5px 0;z-index:5000;min-width:210px;animation:popIn .15s cubic-bezier(.34,1.56,.64,1);}
.anl-item{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;font-size:12px;color:var(--ink2);cursor:pointer;transition:background .1s;white-space:nowrap;gap:8px;position:relative;}
.anl-item:hover{background:var(--cream);}
.anl-item-left{display:flex;align-items:center;gap:8px;}
.anl-icon{font-size:13px;width:18px;text-align:center;flex-shrink:0;}
.anl-arrow{font-size:9px;color:var(--muted);}
.anl-sep{height:1px;background:var(--rule);margin:4px 0;}
.anl-sub{display:none;position:absolute;right:calc(100% + 4px);top:-5px;background:var(--white);border:1.5px solid var(--rule);border-radius:10px;box-shadow:var(--shadow-lg);padding:5px 0;min-width:190px;z-index:5001;}
.anl-has-sub:hover>.anl-sub{display:block;}
.anl-badge{background:var(--sky-lt);color:var(--sky);border:1px solid #bfd4f0;border-radius:10px;padding:1px 7px;font-size:10px;font-family:var(--mono);font-weight:600;}
.anl-badge.amber{background:var(--amber-lt);color:var(--amber);border-color:var(--amber-mid);}
/* Stat + Correlation modals */
#stat-modal,#corr-modal{display:none;position:fixed;inset:0;background:rgba(26,26,24,.55);z-index:9500;align-items:center;justify-content:center;}
#stat-modal-inner,#corr-modal-inner{background:#fff;border-radius:14px;box-shadow:var(--shadow-lg);width:88vw;max-width:900px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden;animation:popIn .18s cubic-bezier(.34,1.56,.64,1);}
.anl-modal-hd{padding:14px 20px;border-bottom:1.5px solid var(--rule);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.anl-modal-title{font-family:var(--serif);font-size:16px;color:var(--ink);}
.anl-modal-sub{font-size:11px;color:var(--muted);margin-top:2px;font-family:var(--mono);}
.anl-modal-body{flex:1;overflow:auto;padding:16px 20px;}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:16px;}
.stat-card{background:var(--cream);border:1.5px solid var(--rule);border-radius:8px;padding:12px 14px;}
.stat-card-field{font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0;border-bottom:1px solid var(--rule);}
.stat-row:last-child{border-bottom:none;}
.stat-lbl{font-size:11px;color:var(--muted);}
.stat-val{font-size:11.5px;font-family:var(--mono);font-weight:600;color:var(--ink);}
.corr-tbl{border-collapse:collapse;font-size:11px;}
.corr-tbl th{background:var(--shelf-bg);padding:8px 12px;text-align:center;font-size:10px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;color:var(--muted);border:1px solid var(--rule);white-space:nowrap;max-width:100px;overflow:hidden;text-overflow:ellipsis;}
.corr-tbl td{padding:8px 12px;text-align:center;border:1px solid var(--rule);font-family:var(--mono);font-size:11.5px;font-weight:600;}

</style>

<div id="skip-modal" style="display:none;position:fixed;inset:0;background:rgba(26,26,24,.4);z-index:9999;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:10px;box-shadow:var(--shadow-lg);width:700px;max-width:95vw;max-height:80vh;display:flex;flex-direction:column;overflow:hidden;">
    <div style="padding:16px 20px;border-bottom:1.5px solid var(--rule);display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-family:var(--serif);font-size:16px;">Skipped Rows Log</div>
        <div id="skip-modal-sub" style="font-size:11px;color:var(--muted);margin-top:2px;"></div>
      </div>
      <button onclick="closeSkipLog()" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);">‚úï</button>
    </div>
    <div style="overflow:auto;flex:1;">
      <table id="skip-table" style="width:100%;border-collapse:collapse;font-size:12px;">
        <thead id="skip-thead" style="position:sticky;top:0;"></thead>
        <tbody id="skip-tbody"></tbody>
      </table>
    </div>
    <div style="padding:10px 20px;border-top:1px solid var(--rule);display:flex;gap:8px;justify-content:flex-end;">
      <button onclick="exportSkipLog()" style="background:var(--forest);color:#fff;border:none;border-radius:5px;padding:6px 14px;font-size:12px;cursor:pointer;font-family:var(--font);">‚Üì Export Log</button>
      <button onclick="closeSkipLog()" style="background:transparent;border:1.5px solid var(--rule);border-radius:5px;padding:6px 14px;font-size:12px;cursor:pointer;font-family:var(--font);">Close</button>
    </div>
  </div>
</div>

<div id="cardinality-modal" style="display:none;position:fixed;inset:0;background:rgba(26,26,24,.45);z-index:9998;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:12px;box-shadow:var(--shadow-lg);width:420px;max-width:95vw;overflow:hidden;animation:popIn .18s cubic-bezier(.34,1.56,.64,1);">
    <div style="padding:6px 14px;background:linear-gradient(135deg,#FDF0E6,#fff);border-bottom:1.5px solid var(--amber-mid);display:flex;align-items:center;gap:10px;">
      <span style="font-size:22px;">‚ö†Ô∏è</span>
      <div>
        <div style="font-family:var(--serif);font-size:15px;color:var(--ink);">Large field detected</div>
        <div id="card-subtitle" style="font-size:11px;color:var(--muted);margin-top:1px;"></div>
      </div>
    </div>
    <div style="padding:18px 20px;">
      <div id="card-body" style="font-size:12.5px;color:var(--ink2);line-height:1.7;"></div>
      <div id="card-stats" style="display:flex;gap:10px;margin-top:14px;"></div>
    </div>
    <div style="padding:12px 20px;border-top:1px solid var(--rule);display:flex;gap:8px;justify-content:flex-end;background:#FDFCFA;">
      <button id="card-filter-btn" style="background:var(--forest);color:#fff;border:none;border-radius:5px;padding:7px 16px;font-size:12px;font-weight:600;cursor:pointer;font-family:var(--font);">Add to Filters Instead</button>
      <button id="card-anyway-btn" style="background:transparent;border:1.5px solid var(--rule);border-radius:5px;padding:7px 16px;font-size:12px;cursor:pointer;font-family:var(--font);color:var(--muted);">Add Anyway</button>
      <button onclick="closeCardModal()" style="background:transparent;border:none;font-size:12px;cursor:pointer;font-family:var(--font);color:var(--faint);">Cancel</button>
    </div>
  </div>
</div>

<div id="query-overlay" style="display:none;position:fixed;inset:0;background:rgba(250,248,244,.75);z-index:8000;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
  <div style="background:#fff;border-radius:10px;box-shadow:var(--shadow-lg);padding:24px 32px;text-align:center;min-width:300px;border:1.5px solid var(--rule);">
    <div style="width:36px;height:36px;border:3px solid var(--forest-mid);border-top-color:var(--forest);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 14px;"></div>
    <div style="font-family:var(--serif);font-size:15px;color:var(--ink);margin-bottom:4px;">Processing query‚Ä¶</div>
    <div id="query-overlay-sub" style="font-size:11px;color:var(--muted);font-family:var(--mono);margin-bottom:16px;">Aggregating data</div>
    <button onclick="cancelQuery()" style="background:transparent;border:1.5px solid var(--rose);color:var(--rose);border-radius:5px;padding:6px 18px;font-size:12px;cursor:pointer;font-family:var(--font);transition:all .15s;">‚úï Cancel</button>
  </div>
</div>

<style>
@keyframes spin { to { transform:rotate(360deg); } }
</style>


<div id="drive-modal">
  <div class="drive-card">
    <div class="drive-header">
      <div class="drive-logo">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none">
          <path d="M12 2L2 19h7l3-5 3 5h7L12 2z" fill="#1a73e8" opacity=".2"/>
          <path d="M9 19H2l5-8.5L9 19zM15 19h7l-5-8.5L15 19zM7 10.5L12 2l5 8.5H7z" stroke="#1a73e8" stroke-width="1.5" fill="none"/>
        </svg>
      </div>
      <div style="flex:1">
        <div class="drive-title">Google Drive</div>
        <div class="drive-sub" id="drive-account-sub">Sign in to browse your files</div>
      </div>
      <button id="drive-auth-btn" onclick="driveSignIn()" style="background:var(--sky);color:#fff;border:none;border-radius:6px;padding:7px 14px;font-size:12px;font-weight:600;cursor:pointer;font-family:var(--font);">Sign in</button>
      <button onclick="closeDriveModal()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;margin-left:6px;">‚úï</button>
    </div>

    <div id="drive-auth-banner" class="drive-auth-banner">
      <span style="font-size:20px;">üîê</span>
      <div>
        <div style="font-size:12.5px;font-weight:600;color:var(--sky);">Connect your Google Drive</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px;">Sign in with Google to browse CSV and Excel files stored in your Drive</div>
      </div>
    </div>

    <div id="drive-browser" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
      <div class="drive-search-wrap">
        <input class="drive-search" id="drive-search-inp" placeholder="Search files‚Ä¶" oninput="driveSearch(this.value)">
        <div class="drive-type-filter">
          <button class="drive-type-btn active" onclick="setDriveFilter('all',this)">All</button>
          <button class="drive-type-btn" onclick="setDriveFilter('csv',this)">CSV</button>
          <button class="drive-type-btn" onclick="setDriveFilter('excel',this)">Excel</button>
        </div>
      </div>
      <div class="drive-breadcrumb" id="drive-breadcrumb">
        <span class="drive-bc-item" onclick="driveNavRoot()">My Drive</span>
      </div>
      <div class="drive-file-list" id="drive-file-list">
        <div class="drive-empty">Loading‚Ä¶</div>
      </div>
    </div>

    <div class="drive-footer">
      <div class="drive-selected-info" id="drive-selected-info">No file selected</div>
      <div style="display:flex;gap:8px;">
        <button onclick="closeDriveModal()" style="background:transparent;border:1.5px solid var(--rule);border-radius:6px;padding:7px 14px;font-size:12px;cursor:pointer;font-family:var(--font);color:var(--muted);">Cancel</button>
        <button id="drive-import-btn" onclick="driveImport()" disabled style="background:var(--forest);color:#fff;border:none;border-radius:6px;padding:7px 16px;font-size:12px;font-weight:600;cursor:pointer;font-family:var(--font);opacity:.4;transition:opacity .15s;">Import File</button>
      </div>
    </div>
  </div>
</div>

<div id="onedrive-modal">
  <div class="drive-card">
    <div class="drive-header">
      <div class="drive-logo" style="background:#e3f2fd;">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none"><path d="M4.5 15.5a4 4 0 0 1 0-8 4.5 4.5 0 0 1 8.46-2A4 4 0 1 1 18 15.5H4.5z" stroke="#0078d4" stroke-width="1.5" fill="#e3f2fd"/></svg>
      </div>
      <div style="flex:1">
        <div class="drive-title">OneDrive</div>
        <div class="drive-sub" id="onedrive-account-sub">Sign in to browse your files</div>
      </div>
      <button id="onedrive-auth-btn" onclick="onedriveSignIn()" style="background:#0078d4;color:#fff;border:none;border-radius:6px;padding:7px 14px;font-size:12px;font-weight:600;cursor:pointer;font-family:var(--font);">Sign in</button>
      <button onclick="closeOnedriveModal()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;margin-left:6px;">‚úï</button>
    </div>
    <div id="onedrive-auth-banner" class="drive-auth-banner" style="border-color:#b3d4f5;background:#e3f2fd;">
      <span style="font-size:20px;">üîê</span>
      <div>
        <div style="font-size:12.5px;font-weight:600;color:#0078d4;">Connect your OneDrive</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px;">Sign in with Microsoft to browse CSV and Excel files</div>
      </div>
    </div>
    <div id="onedrive-browser" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
      <div class="drive-search-wrap">
        <input class="drive-search" id="onedrive-search-inp" placeholder="Search files‚Ä¶" oninput="renderOnedriveFiles(onedriveAllFiles)">
      </div>
      <div class="drive-breadcrumb" id="onedrive-breadcrumb">
        <span class="drive-bc-item" onclick="onedriveStack=[{id:'root',name:'My OneDrive'}];renderOnedriveBreadcrumb();onedriveFetchFolder('root')">My OneDrive</span>
      </div>
      <div class="drive-file-list" id="onedrive-file-list"><div class="drive-empty">Loading‚Ä¶</div></div>
    </div>
    <div class="drive-footer">
      <div class="drive-selected-info" id="onedrive-selected-info">No file selected</div>
      <div style="display:flex;gap:8px;">
        <button onclick="closeOnedriveModal()" style="background:transparent;border:1.5px solid var(--rule);border-radius:6px;padding:7px 14px;font-size:12px;cursor:pointer;font-family:var(--font);color:var(--muted);">Cancel</button>
        <button id="onedrive-import-btn" onclick="onedriveImport()" disabled style="background:#0078d4;color:#fff;border:none;border-radius:6px;padding:7px 16px;font-size:12px;font-weight:600;cursor:pointer;font-family:var(--font);opacity:.4;transition:opacity .15s;">Import File</button>
      </div>
    </div>
  </div>
</div>

<div id="oauth-setup-modal" style="display:none;position:fixed;inset:0;background:rgba(26,26,24,.5);z-index:10000;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:14px;box-shadow:var(--shadow-lg);width:500px;max-width:96vw;overflow:hidden;animation:popIn .18s cubic-bezier(.34,1.56,.64,1);">
    <div style="padding:20px 22px 16px;border-bottom:1.5px solid var(--rule);display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-family:var(--serif);font-size:16px;" id="oauth-modal-title">Connect Google Drive</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px;">One-time setup ¬∑ takes ~2 minutes</div>
      </div>
      <button onclick="closeOAuthSetup()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;">‚úï</button>
    </div>
    <div style="padding:18px 22px;">
      <div id="oauth-steps"></div>
      <div style="margin-top:18px;border-top:1px solid var(--rule);padding-top:16px;">
        <label style="font-size:12px;font-weight:600;color:var(--ink2);display:block;margin-bottom:6px;" id="oauth-input-label">Paste your Client ID</label>
        <div style="display:flex;gap:8px;">
          <input id="oauth-cid-input" placeholder="e.g. 123456789-abc.apps.googleusercontent.com"
            style="flex:1;border:1.5px solid var(--rule);border-radius:6px;padding:8px 12px;font-family:var(--mono);font-size:11.5px;outline:none;transition:border .15s;color:var(--ink);"
            onfocus="this.style.borderColor='var(--sky)'" onblur="this.style.borderColor='var(--rule)'">
          <button onclick="saveOAuthCid()" style="background:var(--forest);color:#fff;border:none;border-radius:6px;padding:8px 18px;font-size:12px;font-weight:600;cursor:pointer;font-family:var(--font);">Save & Connect</button>
        </div>
        <div id="oauth-cid-hint" style="font-size:10.5px;color:var(--muted);margin-top:6px;"></div>
      </div>
    </div>
    <div style="padding:10px 22px 16px;display:flex;gap:8px;align-items:center;">
      <a id="oauth-console-link" href="#" target="_blank"
        style="display:flex;align-items:center;gap:6px;background:var(--sky-lt);color:var(--sky);border:1.5px solid #bfd4f0;border-radius:6px;padding:7px 14px;font-size:12px;font-weight:600;text-decoration:none;transition:all .15s;">
        üîó Open Developer Console
      </a>
      <span style="font-size:11px;color:var(--muted);">Opens in new tab ‚Äî copy Client ID and paste above</span>
    </div>
  </div>
</div>

<!-- LOD MODAL -->
<div id="lod-modal" style="display:none;position:fixed;inset:0;background:rgba(26,26,24,.45);z-index:10000;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:12px;box-shadow:var(--shadow-lg);width:440px;max-width:96vw;overflow:hidden;animation:popIn .18s cubic-bezier(.34,1.56,.64,1);">
    <div style="padding:16px 18px 12px;border-bottom:1.5px solid var(--rule);display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-family:var(--serif);font-size:15px;">FIXED LOD Expression</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px;">Compute at a fixed grain, independent of the view</div>
      </div>
      <button onclick="closeLodModal()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;">‚úï</button>
    </div>
    <div style="padding:16px 18px;display:flex;flex-direction:column;gap:12px;">
      <div style="display:flex;flex-direction:column;gap:4px;">
        <label style="font-size:11px;font-weight:600;color:var(--ink2);">Field Name</label>
        <input id="lod-name-input" placeholder="e.g. Sales per Region"
          style="border:1.5px solid var(--rule);border-radius:5px;padding:7px 10px;font-family:var(--font);font-size:12px;color:var(--ink);outline:none;background:var(--cream);"
          onfocus="this.style.borderColor='var(--sky)'" onblur="this.style.borderColor='var(--rule)'">
      </div>
      <div style="display:flex;gap:10px;">
        <div style="display:flex;flex-direction:column;gap:4px;flex:1;">
          <label style="font-size:11px;font-weight:600;color:var(--ink2);">FIXED Dimensions <span style="font-weight:400;color:var(--muted);">(hold Ctrl for multi)</span></label>
          <select id="lod-dim-select" multiple
            style="border:1.5px solid var(--rule);border-radius:5px;padding:5px 8px;font-family:var(--font);font-size:11.5px;color:var(--ink);background:var(--cream);outline:none;height:100px;"></select>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;width:130px;">
          <label style="font-size:11px;font-weight:600;color:var(--ink2);">Aggregation</label>
          <select id="lod-agg-select"
            style="border:1.5px solid var(--rule);border-radius:5px;padding:7px 8px;font-family:var(--font);font-size:11.5px;color:var(--ink);background:var(--cream);outline:none;">
            <option>SUM</option><option>AVG</option><option>COUNT</option><option>MAX</option><option>MIN</option>
          </select>
          <label style="font-size:11px;font-weight:600;color:var(--ink2);margin-top:6px;">Measure</label>
          <select id="lod-mea-select"
            style="border:1.5px solid var(--rule);border-radius:5px;padding:7px 8px;font-family:var(--font);font-size:11.5px;color:var(--ink);background:var(--cream);outline:none;"></select>
        </div>
      </div>
      <div style="background:var(--amber-lt);border:1px solid var(--amber-mid);border-radius:6px;padding:8px 11px;font-size:11px;color:var(--amber);">
        <strong>Example:</strong> FIXED [Region] : SUM(Sales) ‚Äî gives total sales per region on every row, regardless of what's in the view.
      </div>
      <div id="lod-list" style="display:flex;flex-direction:column;gap:4px;"></div>
    </div>
    <div style="padding:10px 18px 14px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--rule);">
      <button onclick="closeLodModal()" style="background:transparent;border:1.5px solid var(--rule);border-radius:6px;padding:7px 14px;font-size:12px;font-family:var(--font);color:var(--muted);cursor:pointer;">Cancel</button>
      <button onclick="saveLod()" style="background:var(--amber);color:#fff;border:none;border-radius:6px;padding:7px 20px;font-size:12px;font-weight:600;font-family:var(--font);cursor:pointer;">Create LOD Field</button>
    </div>
  </div>

</div>

<div id="prev-modal" onclick="if(event.target===this)_closePreview()">
  <div id="prev-modal-inner">
    <div class="prev-hd">
      <div class="prev-hd-left">
        <div class="prev-hd-title">Data Preview</div>
        <div id="prev-info"></div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <select id="prev-row-sel" onchange="_changePreviewRows(this.value)"
          style="border:1.5px solid var(--rule);border-radius:6px;padding:5px 10px;font-size:12px;font-family:var(--mono);background:var(--cream);color:var(--ink);outline:none;cursor:pointer;">
          <option value="100" selected>100 rows</option>
          <option value="500">500 rows</option>
          <option value="1000">1,000 rows</option>
          <option value="5000">5,000 rows</option>
        </select>
        <button onclick="_closePreview()"
          style="background:none;border:1.5px solid var(--rule);color:var(--muted);cursor:pointer;font-size:15px;border-radius:6px;padding:4px 10px;transition:all .15s;"
          onmouseover="this.style.borderColor='var(--rose)';this.style.color='var(--rose)'"
          onmouseout="this.style.borderColor='var(--rule)';this.style.color='var(--muted)'">‚úï</button>
      </div>
    </div>
    <div id="prev-wrap"></div>
  </div>
</div>


<!-- STATISTICAL SUMMARY MODAL -->
<div id="stat-modal" onclick="if(event.target===this)closeStatModal()">
  <div id="stat-modal-inner">
    <div class="anl-modal-hd">
      <div><div class="anl-modal-title">‚óà Statistical Summary</div><div class="anl-modal-sub" id="stat-modal-sub"></div></div>
      <button onclick="closeStatModal()" style="background:none;border:1.5px solid var(--rule);color:var(--muted);cursor:pointer;font-size:15px;border-radius:6px;padding:4px 10px;" onmouseover="this.style.borderColor='var(--rose)';this.style.color='var(--rose)'" onmouseout="this.style.borderColor='var(--rule)';this.style.color='var(--muted)'">‚úï</button>
    </div>
    <div class="anl-modal-body" id="stat-modal-body"></div>
  </div>
</div>

<!-- CORRELATION MATRIX MODAL -->
<div id="corr-modal" onclick="if(event.target===this)closeCorrModal()">
  <div id="corr-modal-inner">
    <div class="anl-modal-hd">
      <div><div class="anl-modal-title">‚ßâ Correlation Matrix</div><div class="anl-modal-sub" id="corr-modal-sub"></div></div>
      <button onclick="closeCorrModal()" style="background:none;border:1.5px solid var(--rule);color:var(--muted);cursor:pointer;font-size:15px;border-radius:6px;padding:4px 10px;" onmouseover="this.style.borderColor='var(--rose)';this.style.color='var(--rose)'" onmouseout="this.style.borderColor='var(--rule)';this.style.color='var(--muted)'">‚úï</button>
    </div>
    <div class="anl-modal-body" id="corr-modal-body" style="overflow:auto;"></div>
  </div>
</div>




<!-- REPLACE WITH: -->
<div id="show-me-panel">
  <div class="sm-head">
    <span class="sm-head-title">Show Me</span>
    <button class="sm-close" onclick="closeShowMe()">‚úï</button>
  </div>
  <div class="sm-grid">
    <div class="sm-tile active" data-ct="bar" onclick="showMeSelect('bar')">
      <svg viewBox="0 0 40 30"><rect x="3" y="18" width="7" height="9" rx="1" fill="currentColor"/><rect x="13" y="10" width="7" height="17" rx="1" fill="currentColor"/><rect x="23" y="14" width="7" height="13" rx="1" fill="currentColor"/><rect x="33" y="5" width="7" height="22" rx="1" fill="currentColor"/></svg>
      <span class="sm-tile-lbl">Bar</span>
    </div>
    <div class="sm-tile" data-ct="hbar" onclick="showMeSelect('hbar')">
      <svg viewBox="0 0 40 30"><rect y="2" x="3" height="5" width="14" rx="1" fill="currentColor"/><rect y="10" x="3" height="5" width="26" rx="1" fill="currentColor"/><rect y="18" x="3" height="5" width="20" rx="1" fill="currentColor"/><rect y="26" x="3" height="5" width="10" rx="1" fill="currentColor"/></svg>
      <span class="sm-tile-lbl">H-Bar</span>
    </div>
    <div class="sm-tile" data-ct="stacked" onclick="showMeSelect('stacked')">
      <svg viewBox="0 0 40 30"><rect x="3" y="14" width="8" height="13" rx="1" fill="currentColor"/><rect x="3" y="8" width="8" height="6" rx="1" fill="currentColor" opacity="0.55"/><rect x="14" y="10" width="8" height="17" rx="1" fill="currentColor"/><rect x="14" y="4" width="8" height="6" rx="1" fill="currentColor" opacity="0.55"/><rect x="25" y="16" width="8" height="11" rx="1" fill="currentColor"/><rect x="25" y="10" width="8" height="6" rx="1" fill="currentColor" opacity="0.55"/></svg>
      <span class="sm-tile-lbl">Stacked</span>
    </div>
    <div class="sm-tile" data-ct="line" onclick="showMeSelect('line')">
      <svg viewBox="0 0 40 30"><polyline points="3,23 11,13 20,17 29,7 38,11" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="3" cy="23" r="2" fill="currentColor"/><circle cx="20" cy="17" r="2" fill="currentColor"/><circle cx="38" cy="11" r="2" fill="currentColor"/></svg>
      <span class="sm-tile-lbl">Line</span>
    </div>
    <div class="sm-tile" data-ct="area" onclick="showMeSelect('area')">
      <svg viewBox="0 0 40 30"><polygon points="3,28 3,23 11,13 20,17 29,7 38,11 38,28" fill="currentColor" opacity="0.25"/><polyline points="3,23 11,13 20,17 29,7 38,11" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/></svg>
      <span class="sm-tile-lbl">Area</span>
    </div>
    <div class="sm-tile" data-ct="scatter" onclick="showMeSelect('scatter')">
      <svg viewBox="0 0 40 30"><circle cx="7" cy="23" r="3" fill="currentColor"/><circle cx="17" cy="10" r="3" fill="currentColor"/><circle cx="24" cy="19" r="3" fill="currentColor"/><circle cx="32" cy="7" r="3" fill="currentColor"/><circle cx="12" cy="15" r="3" fill="currentColor"/><circle cx="35" cy="20" r="3" fill="currentColor"/></svg>
      <span class="sm-tile-lbl">Scatter</span>
    </div>
    <div class="sm-tile" data-ct="pie" onclick="showMeSelect('pie')">
      <svg viewBox="0 0 30 30"><path d="M15,15 L15,3 A12,12 0 0,1 26,21 Z" fill="currentColor"/><path d="M15,15 L26,21 A12,12 0 0,1 5,22 Z" fill="currentColor" opacity="0.65"/><path d="M15,15 L5,22 A12,12 0 1,1 15,3 Z" fill="currentColor" opacity="0.35"/></svg>
      <span class="sm-tile-lbl">Pie</span>
    </div>
    <div class="sm-tile" data-ct="table" onclick="showMeSelect('table')">
      <svg viewBox="0 0 40 30"><rect x="2" y="2" width="36" height="6" rx="1" fill="currentColor" opacity="0.45"/><line x1="2" y1="14" x2="38" y2="14" stroke="currentColor" stroke-width="1" opacity="0.3"/><line x1="2" y1="21" x2="38" y2="21" stroke="currentColor" stroke-width="1" opacity="0.3"/><line x1="2" y1="28" x2="38" y2="28" stroke="currentColor" stroke-width="1" opacity="0.3"/><line x1="14" y1="8" x2="14" y2="29" stroke="currentColor" stroke-width="1" opacity="0.3"/><line x1="27" y1="8" x2="27" y2="29" stroke="currentColor" stroke-width="1" opacity="0.3"/></svg>
      <span class="sm-tile-lbl">Table</span>
    </div>
  </div>
  <button class="sm-choose-btn" onclick="chooseForMe()">‚ú¶ Choose for Me</button>
  <div class="sm-sep"></div>
  <div class="sm-section">
    <div class="sm-section-title">Overlays</div>
    <div class="sm-row">
      <span class="sm-row-lbl">„Äú Trend Line</span>
      <label class="sm-toggle"><input type="checkbox" id="sm-trend-toggle" onchange="smToggleTrend(this.checked)"><span class="sm-toggle-track"></span></label>
    </div>
    <div class="sm-row" style="margin-top:4px;">
      <button class="sm-rl-btn" id="sm-rl-btn" onclick="smOpenRefLines()">
        <span style="font-size:13px;">‚üã</span> Reference Lines
        <span id="sm-rl-count" style="margin-left:auto;font-family:var(--mono);font-size:10px;"></span>
      </button>
    </div>
  </div>
</div>

</body>

 

</html>
